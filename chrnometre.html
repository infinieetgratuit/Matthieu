<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infinie & gratuit — Chronomètre (noir & or, compact)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark"/>
<style>
/* ===== Tokens & base (IDENTIQUES) ===== */
:root{
  --bg:#0A0A0B; --text:#F2F3F6; --muted:#A5A9B3;
  --gold-1:#D8B45A; --gold-2:#F2C76C; --gold-3:#BF8E2C;
  --panel:#101218CC; --border:rgba(212,172,82,.22);
  --grid:#F2C76C22; --grid-strong:#F2C76C35;
  --radius:14px; --ring:0 0 0 2px rgba(212,172,82,.35);
  --speed-grid:60s; --speed-plane:26s;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg); overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
:focus-visible{outline:none; box-shadow:var(--ring)}
::selection{background:rgba(242,199,108,.25)}

/* ===== Background: quadrillage infini (IDENTIQUE) ===== */
.back{position:fixed; inset:0; pointer-events:none; z-index:-3}
.grid-ortho{
  position:absolute; inset:-20vmax;
  background:
    linear-gradient(var(--grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size:42px 42px,42px 42px; filter:saturate(120%) contrast(105%);
  animation:drift var(--speed-grid) linear infinite;
}
@keyframes drift{0%{background-position:0 0,0 0}100%{background-position:420px 280px,420px 280px}}
.grid-plane{
  position:absolute; left:-10vw; right:-10vw; bottom:-6vh; height:60vh;
  transform:perspective(900px) rotateX(68deg); transform-origin:50% 100%;
  background:
    linear-gradient(var(--grid-strong) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-strong) 1px, transparent 1px);
  background-size:60px 60px,60px 60px;
  mask:linear-gradient(to top,#000 30%,rgba(0,0,0,.85) 55%,rgba(0,0,0,0) 100%);
  animation:planeMove var(--speed-plane) linear infinite;
}
@keyframes planeMove{0%{background-position:0 0,0 0}100%{background-position:0 -600px,0 -600px}}
.halo{position:absolute; inset:0; background:
  radial-gradient(55% 40% at 50% 38%, rgba(242,199,108,.10), transparent 60%),
  radial-gradient(80% 70% at 50% 100%, rgba(191,142,44,.18), transparent 70%); mix-blend-mode:screen}
.vignette{position:absolute; inset:0; background:radial-gradient(120% 120% at 50% 20%, transparent 0 55%, rgba(0,0,0,.52) 80% 100%)}
@media (prefers-reduced-motion:reduce){.grid-ortho,.grid-plane{animation:none}}

/* ===== Header compact (IDENTIQUE) ===== */
header{
  position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 16px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.18)); backdrop-filter:blur(10px) saturate(160%);
  font-size:13px;
}
.brand{display:flex; align-items:center; gap:8px; font-weight:800}
.logo{
  display:grid; place-items:center; width:28px; height:28px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, var(--gold-2), var(--gold-3)); color:#111; font-weight:900;
  box-shadow:0 0 14px rgba(212,172,82,.34), inset 0 0 6px rgba(255,255,255,.18);
}
.badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#CDBB8A; background:rgba(16,18,24,.6)}

/* ===== Layout centré (même gabarit) ===== */
main{min-height:calc(100vh - 48px); display:grid; place-items:center; padding:20px 12px}
.wrap{width:100%; max-width:640px; margin:auto; display:grid; gap:10px}
.card{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:0 0 36px rgba(0,0,0,.55), inset 0 0 .5px rgba(255,255,255,.06);
  padding:12px; position:relative; overflow:hidden;
}
.title{font-size:16px; font-weight:800; margin:0 0 6px}
.muted{color:var(--muted); font-size:12px}

/* ===== Boutons / inputs ===== */
.btn{
  appearance:none; background:#0b0d12; border:1px solid var(--border); color:var(--text);
  border-radius:10px; padding:10px 12px; font-weight:750; cursor:pointer; font-size:14px;
  transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.btn:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
.btn.small{padding:8px 10px; font-size:13px}
.btn.primary{background:linear-gradient(90deg, var(--gold-2), var(--gold-3)); border:none; color:#111}
input[type="text"]{
  width:100%; background:rgba(13,17,24,.6); color:var(--text); border:1px solid var(--border);
  border-radius:10px; padding:10px 12px; font-weight:700;
  transition:box-shadow .2s ease, border-color .2s ease;
}
input[type="text"]::placeholder{color:#bcae83}
input[type="text"]:focus{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}

/* ===== Overlay chargement / toast (IDENTIQUE) ===== */
.overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,6,8,.66); backdrop-filter:blur(6px); z-index:10}
.loader{
  width:96px; height:96px; position:relative; display:grid; place-items:center; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, rgba(242,199,108,.10), rgba(0,0,0,0));
  box-shadow:inset 0 0 0 1px rgba(212,172,82,.18), 0 0 26px rgba(212,172,82,.18);
}
.ring{position:absolute; inset:10px; border-radius:50%; border:3px solid rgba(242,199,108,.18); border-top-color:rgba(242,199,108,.9); animation:spin 1.1s linear infinite}
.ring2{inset:20px; border-top-color:rgba(242,199,108,.55); animation-duration:1.8s}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay p{margin-top:12px; text-align:center; color:#E9D9B3; font-weight:700; font-size:14px}

/* ===== Section résultat / merci ===== */
#done{display:none}
.ok{display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%;
  background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; font-weight:900; margin-right:6px}
.passbox{display:flex; align-items:center; gap:8px; justify-content:space-between; border:1px solid var(--border);
  background:rgba(13,17,24,.6); border-radius:10px; padding:8px 10px; margin-top:8px}
.passbox b{font-size:16px; letter-spacing:1px}
.center{text-align:center}
.thanks{
  margin-top:12px; border-radius:12px; padding:10px;
  background:
    linear-gradient(#0d1118cc,#0d1118cc) padding-box,
    linear-gradient(120deg,var(--gold-2),var(--gold-3)) border-box;
  border:1px solid transparent;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 6px 28px rgba(212,172,82,.12), inset 0 0 .5px rgba(255,255,255,.06);
}
.thanks img{max-width:100%; width:220px; height:auto; image-rendering:auto; filter:drop-shadow(0 2px 12px rgba(212,172,82,.25))}

/* ===== Chronomètres ===== */
.row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px}
.actions{display:flex; gap:6px; flex-wrap:wrap}
.timer{
  border:1px solid var(--border); border-radius:12px; padding:10px;
  background:rgba(13,17,24,.55);
}
.timerHeader{display:flex; align-items:center; gap:8px; justify-content:space-between}
.timerName{flex:1}
.time{
  font-weight:800; font-size:28px; letter-spacing:1px; text-align:right;
}
.meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px}
.laps{margin-top:8px; border-top:1px dashed rgba(212,172,82,.28); padding-top:6px; max-height:180px; overflow:auto}
.lap{display:flex; justify-content:space-between; padding:6px 8px; border:1px solid var(--border); border-radius:8px; margin-top:6px; background:#0b0d12}
.badge2{font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:#CDBB8A; background:rgba(16,18,24,.6)}
.controls{display:flex; gap:6px; flex-wrap:wrap}
.smallmuted{font-size:11px; color:#CDBB8A}
.fade{transition:opacity .28s ease, transform .28s ease, visibility .28s ease}
.hidden{opacity:0; visibility:hidden; transform:translateY(6px)}
.show{opacity:1; visibility:visible; transform:none}
</style>
</head>
<body>
<!-- Background -->
<div class="back" aria-hidden="true">
  <div class="grid-ortho"></div>
  <div class="grid-plane"></div>
  <div class="halo"></div>
  <div class="vignette"></div>
</div>

<!-- Header -->
<header>
  <div class="brand"><div class="logo">∞</div><span>Infinie & gratuit</span></div>
  <div class="badge">Chronomètre — local</div>
</header>

<main>
  <!-- Bloc principal -->
  <section id="app" class="wrap fade show" aria-live="polite">
    <div class="card">
      <h2 class="title">Chronomètre</h2>
      <div class="muted">Ajoute plusieurs chronomètres, lance/pauses, enregistre des tours, renomme, exporte en CSV. 100% local.</div>

      <!-- Ajouter un chrono -->
      <div class="row">
        <input id="newName" type="text" placeholder="Nom du chronomètre (ex. « Sprint », « Montage », …)">
        <button class="btn primary" id="addBtn">Ajouter</button>
      </div>

      <!-- Liste des chronos -->
      <div id="list" style="display:grid; gap:10px; margin-top:8px"></div>

      <!-- Actions globales -->
      <div class="row">
        <div class="smallmuted">Raccourcis : S démarrer/pauser, L tour, R réinit (sur le focus).</div>
        <div class="actions">
          <button class="btn small" id="exportAllBtn">Exporter CSV (tous)</button>
          <button class="btn small" id="endSessionBtn">Terminer la session</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Overlay / toast -->
  <div class="overlay" id="overlay" aria-live="polite">
    <div>
      <div class="loader">
        <div class="ring"></div>
        <div class="ring ring2"></div>
      </div>
      <p id="overlayText">Traitement…</p>
    </div>
  </div>

  <!-- Écran fin de session -->
  <section id="done" class="wrap fade">
    <div class="card center">
      <div><span class="ok">✓</span><strong>Session terminée</strong></div>
      <div class="muted" style="margin-top:6px">Récapitulatif prêt.</div>

      <div class="thanks" aria-label="Merci !">
        <img src="merci.png" alt="Notre personnage dit « merci »">
      </div>

      <div class="passbox">
        <span class="muted">Total cumulé</span>
        <b id="totalOut">—</b>
        <button class="btn small" id="backBtn">Nouvelle session</button>
      </div>

      <div id="summary" style="margin-top:10px; text-align:left"></div>
    </div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const wait = ms => new Promise(r=> setTimeout(r, ms));

/* ===== UI refs ===== */
const app = $('#app'), overlay = $('#overlay'), overlayText = $('#overlayText');
const done = $('#done'), totalOut = $('#totalOut'), summary = $('#summary');
const list = $('#list'), addBtn = $('#addBtn'), newName = $('#newName');
const exportAllBtn = $('#exportAllBtn'), endSessionBtn = $('#endSessionBtn'), backBtn = $('#backBtn');

/* ===== Store ===== */
const STORE_KEY = 'infinie-chrono-v1';
let timers = load() || [];

/* ===== Timer model =====
{ id, name, elapsed: number(ms), running: bool, startedAt: ms|null, laps: [{t:ms, delta:ms, i:int}] }
*/
function uid(){ return Math.random().toString(36).slice(2,9); }
function now(){ return performance.now(); }
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(timers)); }
function load(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch{ return []; } }
function clearStore(){ localStorage.removeItem(STORE_KEY); }

/* ===== Rendering ===== */
function formatMS(ms){
  const sign = ms<0 ? '-' : '';
  ms = Math.abs(ms);
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  const s = Math.floor((ms%60000)/1000);
  const cs = Math.floor((ms%1000)/10);
  const pad = n=> String(n).padStart(2,'0');
  return (h? h+':':'') + pad(m)+':'+pad(s)+'.'+pad(cs);
}
function renderAll(){
  list.innerHTML = '';
  timers.forEach(t=> list.appendChild(renderTimer(t)));
}
function renderTimer(t){
  const el = document.createElement('div');
  el.className = 'timer';
  el.dataset.id = t.id;
  el.innerHTML = `
    <div class="timerHeader">
      <input class="timerName" type="text" value="${escapeHtml(t.name||'Chrono')}" aria-label="Nom">
      <div class="badge2">${t.running ? 'En cours' : 'En pause'}</div>
    </div>
    <div class="meta">
      <div class="controls">
        <button class="btn small start">${t.running?'Pause':'Démarrer'}</button>
        <button class="btn small lap">Tour</button>
        <button class="btn small reset">Réinit.</button>
        <button class="btn small export">CSV</button>
        <button class="btn small remove">Supprimer</button>
      </div>
      <div class="time" aria-live="polite">00:00:00.00</div>
    </div>
    <div class="laps"></div>
  `;
  const nameInput = el.querySelector('.timerName');
  nameInput.addEventListener('input', ()=>{
    t.name = nameInput.value.trim() || 'Chrono'; save();
  });
  el.querySelector('.start').addEventListener('click', ()=> toggleStart(t.id));
  el.querySelector('.lap').addEventListener('click', ()=> addLap(t.id));
  el.querySelector('.reset').addEventListener('click', ()=> resetTimer(t.id));
  el.querySelector('.export').addEventListener('click', ()=> exportCSV([t]));
  el.querySelector('.remove').addEventListener('click', ()=> removeTimer(t.id));
  el.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='s'){ e.preventDefault(); toggleStart(t.id); }
    if(e.key.toLowerCase()==='l'){ e.preventDefault(); addLap(t.id); }
    if(e.key.toLowerCase()==='r'){ e.preventDefault(); resetTimer(t.id); }
  });
  updateTimeDOM(t, el);
  renderLaps(t, el.querySelector('.laps'));
  return el;
}
function updateTimeDOM(t, el){
  const timeEl = el?.querySelector?.('.time') || list.querySelector(`[data-id="${t.id}"] .time`);
  if(!timeEl) return;
  const runningExtra = t.running ? (now() - t.startedAt) : 0;
  timeEl.textContent = formatMS(t.elapsed + runningExtra);
  const badge = el?.querySelector?.('.badge2') || list.querySelector(`[data-id="${t.id}"] .badge2`);
  if(badge) badge.textContent = t.running ? 'En cours' : 'En pause';
  const startBtn = el?.querySelector?.('.start') || list.querySelector(`[data-id="${t.id}"] .start`);
  if(startBtn) startBtn.textContent = t.running ? 'Pause' : 'Démarrer';
}
function renderLaps(t, container){
  container.innerHTML = '';
  (t.laps||[]).forEach((lap,i)=>{
    const item = document.createElement('div');
    item.className = 'lap';
    item.innerHTML = `<span>Tour ${i+1}</span><span>${formatMS(lap.delta)} (total ${formatMS(lap.t)})</span>`;
    container.appendChild(item);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ===== Actions timers ===== */
function addTimer(name='Chrono'){
  const t = { id:uid(), name, elapsed:0, running:false, startedAt:null, laps:[] };
  timers.push(t); save(); renderAll();
  const last = list.querySelector(`[data-id="${t.id}"] .timerName`); last?.focus();
}
function toggleStart(id){
  const t = timers.find(x=>x.id===id); if(!t) return;
  if(!t.running){ t.running = true; t.startedAt = now(); }
  else{
    t.elapsed += now() - (t.startedAt||now());
    t.startedAt = null; t.running = false;
  }
  save(); updateTimeDOM(t);
}
function addLap(id){
  const t = timers.find(x=>x.id===id); if(!t) return;
  const current = t.elapsed + (t.running ? now()-t.startedAt : 0);
  const prevT = t.laps.length ? t.laps[t.laps.length-1].t : 0;
  t.laps.push({ t: current, delta: current - prevT });
  save();
  const el = list.querySelector(`[data-id="${id}"] .laps`);
  renderLaps(t, el);
  toast('Tour enregistré');
}
function resetTimer(id){
  const t = timers.find(x=>x.id===id); if(!t) return;
  t.elapsed = 0; t.startedAt = t.running ? now() : null; t.laps = [];
  save(); updateTimeDOM(t);
  const el = list.querySelector(`[data-id="${id}"] .laps`); el.innerHTML = '';
}
function removeTimer(id){
  timers = timers.filter(x=>x.id!==id); save(); renderAll();
}

/* ===== Export ===== */
function exportCSV(arr){
  if(!arr.length){ toast('Rien à exporter'); return; }
  const rows = [['id','nom','total_ms','total_fmt','laps_count','lap_index','lap_total_ms','lap_delta_ms','lap_total_fmt','lap_delta_fmt']];
  arr.forEach(t=>{
    const total = t.elapsed + (t.running ? now()-t.startedAt : 0);
    if(!t.laps.length){
      rows.push([t.id, t.name, Math.round(total), formatMS(total), 0,'','','','','']);
    }else{
      t.laps.forEach((L,i)=>{
        rows.push([t.id, t.name, Math.round(total), formatMS(total), t.laps.length, i+1, Math.round(L.t), Math.round(L.delta), formatMS(L.t), formatMS(L.delta)]);
      });
    }
  });
  const csv = rows.map(r=> r.map(v=>{
    const s = String(v??'');
    return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'chronometres.csv';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
  toast('CSV exporté');
}

/* ===== Session summary ===== */
function endSession(){
  let total = 0;
  const items = timers.map(t=>{
    const sum = t.elapsed + (t.running ? now()-t.startedAt : 0);
    total += sum;
    return {name:t.name, total:sum, laps:t.laps};
  });
  totalOut.textContent = formatMS(total);
  summary.innerHTML = items.map(it=>`
    <div class="timer" style="margin-top:10px">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong>${escapeHtml(it.name)}</strong>
        <span class="badge2">${formatMS(it.total)}</span>
      </div>
      ${it.laps.length ? `<div class="laps">${it.laps.map((L,i)=>`<div class="lap"><span>Tour ${i+1}</span><span>${formatMS(L.delta)} (total ${formatMS(L.t)})</span></div>`).join('')}</div>` : `<div class="smallmuted" style="margin-top:6px">Aucun tour</div>`}
    </div>
  `).join('');
  app.classList.add('hidden');
  setTimeout(()=>{ app.style.display='none'; done.style.display='grid'; done.classList.add('show'); }, 260);
}

/* ===== Nouvelle session = RESET COMPLET ===== */
function newSessionReset(){
  // Stop boucle de rendu (par sécurité)
  timers.forEach(t=>{ t.running=false; t.startedAt=null; });
  // Vide état + storage
  timers = [];
  clearStore();
  // UI -> écran principal propre
  done.style.display='none';
  summary.innerHTML = '';
  totalOut.textContent = '—';
  app.style.display='grid';
  app.classList.remove('hidden'); app.classList.add('show');
  // Réinstalle un chrono vierge
  renderAll();
  addTimer('Chrono 1');
}

/* ===== Toast via overlay ===== */
function toast(text){
  overlayText.textContent = text||'OK';
  overlay.style.display='grid';
  setTimeout(()=> overlay.style.display='none', 800);
}

/* ===== Animation frame (tick) ===== */
let raf = null;
function loop(){
  raf = requestAnimationFrame(loop);
  const running = timers.filter(t=>t.running);
  if(!running.length) return;
  running.forEach(t=> updateTimeDOM(t));
}
raf = requestAnimationFrame(loop);

/* ===== Events ===== */
addBtn.addEventListener('click', ()=>{
  const name = newName.value.trim() || 'Chrono';
  addTimer(name); newName.value='';
});
newName.addEventListener('keydown', e=>{
  if(e.key==='Enter'){ addBtn.click(); }
});
exportAllBtn.addEventListener('click', ()=> exportCSV(timers));
endSessionBtn.addEventListener('click', endSession);
backBtn.addEventListener('click', newSessionReset);

/* ===== Init ===== */
if(timers.length===0){ addTimer('Chrono 1'); }
else { renderAll(); }
</script>
</body>
</html>
