<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Infinie & gratuit — PDF Locker (mot de passe)</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ===================== THEME — Ultra Premium Monochrome ===================== */
    :root{
      --bg:#0A0A0B;           /* Noir onyx */
      --bg-2:#0C0D0F;         /* Noir bleuté */
      --panel:#0E1013;        /* Surface principale */
      --panel-2:#0B0C0E;      /* Surface secondaire */
      --text:#ECEEF1;         /* Blanc doux */
      --muted:#9CA3AF;        /* Gris luxe */
      --hairline:rgba(255,255,255,.06); /* filet très fin */
      --border:rgba(255,255,255,.10);   /* bordure subtile */
      --ring:0 0 0 2px rgba(255,255,255,.20), 0 0 0 8px rgba(255,255,255,.05);
      --radius:18px;
      --shadow-lg:0 24px 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.03);
      --grad-panel: radial-gradient(900px 600px at 20% 15%, rgba(255,255,255,.06), transparent 60%),
                    radial-gradient(900px 600px at 80% 85%, rgba(255,255,255,.05), transparent 55%),
                    linear-gradient(180deg, #0F1114 0%, #0B0C0E 70%, #090A0B 100%);
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, #0B0B0C, #0A0A0B);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden; position:relative;
    }

    /* Grain ultra léger (matière) */
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.8' numOctaves='2' stitchTiles='stitch' type='fractalNoise'/%3E%3CfeColorMatrix values='0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .06 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      mix-blend-mode:soft-light; opacity:.35;
    }

    *,*:before,*:after{box-sizing:border-box}
    :focus-visible{outline:none; box-shadow:var(--ring)}
    ::selection{background:rgba(255,255,255,.12)}

    /* ===================== Header minimal ===================== */
    .header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      border-bottom:1px solid var(--hairline);
      backdrop-filter:saturate(110%) blur(8px);
    }
    .wrap{max-width:940px; margin:0 auto; padding:14px 18px}
    .top{display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{
      display:inline-grid; place-items:center; width:30px; height:30px; border-radius:999px; color:#0C0D0F;
      background:conic-gradient(from 180deg, #1E1F22, #0F1114, #0B0C0E, #1E1F22);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08), 0 10px 24px rgba(0,0,0,.45);
      font-weight:800; text-shadow:0 1px 0 rgba(255,255,255,.35);
    }
    .badge{
      margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; font-size:12px; color:#D6DAE0;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border:1px solid var(--hairline);
    }
    .ic{width:14px; height:14px; display:inline-block; vertical-align:-2px}

    /* ===================== Monolith (structure ultra minimal) ===================== */
    .shell{max-width:940px; margin:0 auto; padding:32px 18px 72px; position:relative; z-index:1}
    .title{font-size:28px; line-height:1.15; margin:6px 0 18px; font-weight:800; letter-spacing:.2px}

    .monolith{
      border:1px solid var(--border); border-radius:var(--radius);
      background:var(--grad-panel);
      box-shadow:var(--shadow-lg);
      overflow:hidden;
    }

    /* Barres fines (hairlines) */
    .bar{border-bottom:1px solid var(--hairline); background:linear-gradient(180deg, rgba(255,255,255,.015), rgba(255,255,255,0))}
    .bar .row{padding:12px 14px; display:flex; align-items:center; gap:10px}
    .grow{flex:1 1 auto}

    /* Zone de dépôt — épurée */
    .stage{padding:16px}
    .drop{
      position:relative; display:grid; place-items:center; height:420px; border-radius:14px;
      border:1px dashed var(--hairline);
      background:
        radial-gradient(700px 340px at 30% 20%, rgba(255,255,255,.05), transparent 55%),
        linear-gradient(180deg, #0E1013, #0B0C0E);
      color:#D9DDE3; cursor:pointer; overflow:hidden;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .drop:hover{border-color:rgba(255,255,255,.18); box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 24px 60px rgba(0,0,0,.5)}
    .drop.is-drag{transform:scale(1.01); box-shadow:0 0 0 2px rgba(255,255,255,.12), 0 28px 80px rgba(0,0,0,.55)}
    .drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .hint{text-align:center; font-weight:700}
    .hint small{display:block; color:var(--muted); font-weight:600}

    /* Meta fichier */
    .meta{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px}
    .name{font-weight:700; color:var(--text)}
    #fileRow{display:none}

    /* Actions (compact + iconiques) */
    .actions{display:flex; align-items:center; gap:10px; padding:12px 14px}
    .btn{
      appearance:none; background:linear-gradient(180deg, #121418, #0D0F12); border:1px solid var(--hairline); color:var(--text);
      border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 14px 36px rgba(0,0,0,.5)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, #171A1F, #0E1115);
      border:1px solid rgba(255,255,255,.16);
    }
    .btn.ghost{background:transparent}

    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--hairline);
      color:#CFD4DB;
    }
    .dot{width:8px; height:8px; border-radius:50%; background:linear-gradient(180deg,#E5E7EB,#9CA3AF)}

    /* Password block */
    .pass{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      border:1px solid var(--hairline);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border-radius:14px; padding:10px 12px; margin:12px 14px 16px;
    }
    .pass b{font-size:18px; letter-spacing:1px; color:#F2F4F7}
    .hide{display:none}

    /* Loader minimal */
    .spin{--d:16px; width:var(--d); height:var(--d); border-radius:50%;
      border:2px solid rgba(255,255,255,.12); border-right-color:rgba(255,255,255,.9); animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* Footer legal minimal */
    .legal{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; padding:12px 14px}

    @media (max-width:680px){
      .title{font-size:24px}
      .drop{height:320px}
    }
  </style>

  <!-- ========= SVG Icons (symbols) ========= -->
  <svg width="0" height="0" style="position:absolute;visibility:hidden" aria-hidden="true">
    <symbol id="i-infinity" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7 7c2.2 0 3.9 1.5 5 3c1.1-1.5 2.8-3 5-3c3 0 5 2.3 5 5s-2 5-5 5c-2.2 0-3.9-1.5-5-3c-1.1 1.5-2.8 3-5 3c-3 0-5-2.3-5-5s2-5 5-5zm0 2c-1.8 0-3 1.3-3 3s1.2 3 3 3c1.8 0 3.2-1.5 4.3-3C10.2 10.5 8.8 9 7 9zm10 0c-1.8 0-3.2 1.5-4.3 3c1.1 1.5 2.5 3 4.3 3c1.8 0 3-1.3 3-3s-1.2-3-3-3z"/>
    </symbol>
    <symbol id="i-file" viewBox="0 0 24 24">
      <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 7h5v11a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h8v6a1 1 0 0 0 1 1z"/>
    </symbol>
    <symbol id="i-lock" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 1a5 5 0 0 1 5 5v3h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h1V6a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v3h6V6a3 3 0 0 0-3-3z"/>
    </symbol>
    <symbol id="i-rotate" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 6V3l5 4-5 4V8a4 4 0 1 0 4 4h2a6 6 0 1 1-6-6z"/>
    </symbol>
    <symbol id="i-copy" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 2h9a2 2 0 0 1 2 2v9h-2V4H9V2zM4 7h9a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zm0 2v9h9V9H4z"/>
    </symbol>
    <symbol id="i-dot" viewBox="0 0 8 8">
      <circle cx="4" cy="4" r="3" fill="currentColor"/>
    </symbol>
  </svg>
  <!-- qpdf-wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.js"></script>
</head>
<body>
  <!-- ===================== Header ===================== -->
  <header class="header">
    <div class="wrap top">
      <div class="brand">
        <div class="logo" aria-hidden><svg class="ic" viewBox="0 0 24 24"><use href="#i-infinity"/></svg></div>
        <span>Infinie & gratuit</span>
      </div>
      <div class="badge">
        <svg class="ic" viewBox="0 0 24 24"><use href="#i-lock"/></svg>
        <span><strong>Protection PDF</strong> — 100% local</span>
      </div>
    </div>
  </header>

  <!-- ===================== Main / Monolith ===================== -->
  <main class="shell">
    <h1 class="title">PDF Locker — Mot de passe</h1>

    <section class="monolith">
      <!-- Top bar: file meta + status -->
      <div class="bar">
        <div class="row">
          <div class="meta grow" id="fileRow">
            <svg class="ic" viewBox="0 0 24 24"><use href="#i-file"/></svg>
            <span class="name" id="fname">Aucun fichier</span>
            <span>•</span>
            <span id="fsize">0 Mo</span>
          </div>
          <div id="statusPill" class="pill">
            <span class="dot" style="background:currentColor"><svg class="ic" viewBox="0 0 8 8"><use href="#i-dot"/></svg></span>
            <span id="statusTxt">Prêt</span>
          </div>
        </div>
      </div>

      <!-- Drop stage -->
      <div class="stage">
        <div class="drop" id="drop" role="button" tabindex="0" aria-label="Déposez un PDF ou cliquez pour importer">
          <input id="file" type="file" accept="application/pdf" aria-label="Importer un PDF">
          <div class="hint">
            <div style="font-size:48px; opacity:.9; margin-bottom:8px;">
              <svg class="ic" style="width:48px; height:48px" viewBox="0 0 24 24"><use href="#i-file"/></svg>
            </div>
            Déposer / Cliquer pour sélectionner
            <small>Chiffrement AES-256 — vos fichiers ne quittent jamais l’appareil</small>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="bar">
        <div class="actions">
          <button class="btn primary" id="lockBtn"><svg class="ic" viewBox="0 0 24 24"><use href="#i-lock"/></svg> Crypter (local)</button>
          <button class="btn ghost" id="resetBtn"><svg class="ic" viewBox="0 0 24 24"><use href="#i-rotate"/></svg> Réinitialiser</button>
          <div class="grow"></div>
          <div class="row" id="loader" style="display:none"><div class="spin" title="Chargement"></div></div>
        </div>
      </div>

      <!-- Password -->
      <div class="pass hide" id="passBox">
        <span class="meta">Mot de passe</span>
        <b id="passTxt">—</b>
        <button class="btn" id="copyBtn" aria-label="Copier le mot de passe"><svg class="ic" viewBox="0 0 24 24"><use href="#i-copy"/></svg> Copier</button>
      </div>

      <!-- Legal / Tip -->
      <div class="legal">
        <span>Chiffrement effectué localement (WASM).</span>
        <span id="tip" class="hide">Téléchargement automatique activé.</span>
      </div>
    </section>
  </main>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);

    // Refs UI
    const drop = $('#drop');
    const fileInput = $('#file');
    const fileRow = $('#fileRow');
    const fname = $('#fname');
    const fsize = $('#fsize');
    const statusTxt = $('#statusTxt');
    const statusPill = $('#statusPill');
    const loader = $('#loader');
    const lockBtn = $('#lockBtn');
    const resetBtn = $('#resetBtn');
    const passBox = $('#passBox');
    const passTxt = $('#passTxt');
    const copyBtn = $('#copyBtn');
    const tip = $('#tip');

    let currentFile = null;
    let qpdfInstance = null;
    const WASM_URL = 'https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.wasm';

    /* PDF check robuste */
    function isPdf(file){
      const nameOk = /\.pdf$/i.test(file?.name || '');
      const mime = (file?.type || '').toLowerCase();
      const mimeOk = mime === 'application/pdf' || mime === 'application/x-pdf' || mime.startsWith('application/pdf');
      return mimeOk || nameOk;
    }

    /* Drag & Drop + clavier */
    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.remove('is-drag'); }));

    drop.addEventListener('drop', e => {
      const f = e.dataTransfer?.files?.[0];
      if(f) onFile(f);
      fileInput.value = '';
    });

    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fileInput.click(); } });

    fileInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(f) onFile(f);
      e.target.value = '';
    });

    function onFile(file){
      if(!isPdf(file)){ alert('Merci d’importer un fichier PDF.'); return; }
      currentFile = file;
      fname.textContent = file.name;
      fsize.textContent = (file.size/1024/1024).toFixed(2) + ' Mo';
      fileRow.style.display = 'flex';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('PDF chargé', true);
    }

    resetBtn.addEventListener('click', ()=>{
      currentFile = null; fileInput.value = '';
      fileRow.style.display = 'none';
      fname.textContent = 'Aucun fichier'; fsize.textContent = '0 Mo';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('Prêt', true);
    });

    copyBtn.addEventListener('click', async()=>{
      try{
        await navigator.clipboard.writeText(passTxt.textContent);
        copyBtn.textContent = 'Copié';
        setTimeout(()=> copyBtn.textContent='Copier', 1200);
      }catch{}
    });

    lockBtn.addEventListener('click', async()=>{
      if(!currentFile){ alert('Importe un PDF d’abord.'); return; }
      if(!qpdfInstance){ await loadQpdf(); }

      await busy('Analyse du PDF…', 400);
      await busy('Chiffrement AES-256…', 700);

      const password = genPassword();
      try{
        const outBlob = await encryptPdfWithQpdf(currentFile, password);
        passTxt.textContent = password;
        passBox.classList.remove('hide');
        autoDownload(outBlob, 'secured_' + (currentFile.name.replace(/\.pdf$/i,'') || 'document') + '.pdf');
        tip.classList.remove('hide');
        setStatus('PDF protégé', true);
      }catch(err){
        console.error(err);
        setStatus('Erreur', false);
        alert('Échec du chiffrement du PDF.');
      }
    });

    function setStatus(text, ok){
      statusTxt.textContent = text;
      // icône/pastille passe par .pill (monochrome) — on change juste la teinte via filter si besoin
      statusPill.style.opacity = ok ? '1' : '.9';
    }

    async function busy(text, ms){
      setStatus(text, true);
      loader.style.display = 'flex';
      await new Promise(r=> setTimeout(r, ms));
      loader.style.display = 'none';
    }

    async function loadQpdf(){
      setStatus('Chargement du module…', true);
      loader.style.display = 'flex';
      qpdfInstance = await window.Module({
        locateFile: () => WASM_URL,
        noInitialRun: true,
        preRun: [ m => { try{ m.FS.mkdir('/in'); m.FS.mkdir('/out'); }catch{} } ],
      });
      loader.style.display = 'none';
      setStatus('Module prêt', true);
    }

    async function encryptPdfWithQpdf(file, password){
      const buf = new Uint8Array(await file.arrayBuffer());
      const inPath = '/in/doc.pdf';
      const outPath = '/out/locked.pdf';
      qpdfInstance.FS.writeFile(inPath, buf);
      const args = ['--encrypt', password, password, '256', '--', inPath, outPath];
      qpdfInstance.callMain(args);
      const out = qpdfInstance.FS.readFile(outPath);
      try{ qpdfInstance.FS.unlink(inPath); qpdfInstance.FS.unlink(outPath); }catch{}
      return new Blob([out], {type:'application/pdf'});
    }

    function genPassword(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s=''; for(let i=0;i<10;i++) s += chars[(Math.random()*chars.length)|0];
      return s.slice(0,4)+'-'+s.slice(4,8)+'-'+s.slice(8);
    }

    function autoDownload(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 800);
    }
  </script>
</body>
</html>
