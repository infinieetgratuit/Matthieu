<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infinie & gratuit — Beat Maker (noir & or, compact)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark"/>
<style>
/* ===== Tokens & base (IDENTIQUES) ===== */
:root{
  --bg:#0A0A0B; --text:#F2F3F6; --muted:#A5A9B3;
  --gold-1:#D8B45A; --gold-2:#F2C76C; --gold-3:#BF8E2C;
  --panel:#101218CC; --border:rgba(212,172,82,.22);
  --grid:#F2C76C22; --grid-strong:#F2C76C35;
  --radius:14px; --ring:0 0 0 2px rgba(212,172,82,.35);
  --speed-grid:60s; --speed-plane:26s;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg); overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
:focus-visible{outline:none; box-shadow:var(--ring)}
::selection{background:rgba(242,199,108,.25)}

/* ===== Background (IDENTIQUE) ===== */
.back{position:fixed; inset:0; pointer-events:none; z-index:-3}
.grid-ortho{
  position:absolute; inset:-20vmax;
  background:
   linear-gradient(var(--grid) 1px, transparent 1px),
   linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size:42px 42px,42px 42px; filter:saturate(120%) contrast(105%);
  animation:drift var(--speed-grid) linear infinite;
}
@keyframes drift{0%{background-position:0 0,0 0}100%{background-position:420px 280px,420px 280px}}
.grid-plane{
  position:absolute; left:-10vw; right:-10vw; bottom:-6vh; height:60vh;
  transform:perspective(900px) rotateX(68deg); transform-origin:50% 100%;
  background:
   linear-gradient(var(--grid-strong) 1px, transparent 1px),
   linear-gradient(90deg, var(--grid-strong) 1px, transparent 1px);
  background-size:60px 60px,60px 60px;
  mask:linear-gradient(to top,#000 30%,rgba(0,0,0,.85) 55%,rgba(0,0,0,0) 100%);
  animation:planeMove var(--speed-plane) linear infinite;
}
@keyframes planeMove{0%{background-position:0 0,0 0}100%{background-position:0 -600px,0 -600px}}
.halo{position:absolute; inset:0; background:
  radial-gradient(55% 40% at 50% 38%, rgba(242,199,108,.10), transparent 60%),
  radial-gradient(80% 70% at 50% 100%, rgba(191,142,44,.18), transparent 70%); mix-blend-mode:screen}
.vignette{position:absolute; inset:0; background:radial-gradient(120% 120% at 50% 20%, transparent 0 55%, rgba(0,0,0,.52) 80% 100%)}
@media (prefers-reduced-motion:reduce){.grid-ortho,.grid-plane{animation:none}}

/* ===== Header compact (IDENTIQUE) ===== */
header{
  position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 16px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.18)); backdrop-filter:blur(10px) saturate(160%);
  font-size:13px;
}
.brand{display:flex; align-items:center; gap:8px; font-weight:800}
.logo{
  display:grid; place-items:center; width:28px; height:28px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, var(--gold-2), var(--gold-3)); color:#111; font-weight:900;
  box-shadow:0 0 14px rgba(212,172,82,.34), inset 0 0 6px rgba(255,255,255,.18);
}
.badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#CDBB8A; background:rgba(16,18,24,.6)}

/* ===== Layout ===== */
main{min-height:calc(100vh - 48px); display:grid; place-items:center; padding:20px 12px}
.wrap{width:100%; max-width:980px; margin:auto; display:grid; gap:10px}
.card{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:0 0 36px rgba(0,0,0,.55), inset 0 0 .5px rgba(255,255,255,.06);
  padding:12px; position:relative; overflow:hidden;
}
.title{font-size:16px; font-weight:800; margin:0 0 6px}
.muted{color:var(--muted); font-size:12px}
.smallmuted{font-size:11px; color:#CDBB8A}

/* ===== Controls ===== */
.controls{display:grid; grid-template-columns:repeat(6, 1fr); gap:8px; margin-top:8px}
.control{border:1px solid var(--border); border-radius:10px; padding:8px; background:rgba(13,17,24,.55)}
.control label{display:block; font-size:11px; color:#CDBB8A; margin-bottom:4px}
.control input[type="range"]{width:100%}
.control select, .control input[type="number"]{
  width:100%; background:#0b0d12; border:1px solid var(--border); color:var(--text);
  border-radius:8px; padding:8px; font-weight:700;
}
.btn{
  appearance:none; background:#0b0d12; border:1px solid var(--border); color:var(--text);
  border-radius:10px; padding:10px 12px; font-weight:750; cursor:pointer; font-size:14px;
  transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.btn:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
.btn.small{padding:8px 10px; font-size:13px}
.btn.primary{background:linear-gradient(90deg, var(--gold-2), var(--gold-3)); border:none; color:#111}

/* ===== Sequencer ===== */
.sequencer{display:grid; gap:10px; margin-top:8px}
.track{
  border:1px solid var(--border); border-radius:12px; padding:8px; background:rgba(13,17,24,.55)
}
.trackHead{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
.trackTitle{display:flex; align-items:center; gap:8px}
.trackTitle strong{font-size:14px}
.mix{display:flex; gap:6px; align-items:center}
.mix input[type="range"]{width:80px}
.grid{display:grid; grid-template-columns:repeat(16, 1fr); gap:6px}
.cell{
  position:relative; height:30px; border-radius:8px; cursor:pointer;
  border:1px solid var(--border); background:#0b0d12; transition:box-shadow .2s, border-color .2s, transform .06s;
  display:grid; place-items:center; outline:none;
}
.cell[role="button"]{user-select:none}
.cell:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
.cell.on{background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; border:none}
.cell.play{outline:2px solid rgba(242,199,108,.75)}
.legend{font-size:11px; color:#CDBB8A; margin-top:4px}

.noteCell{height:30px; display:grid; place-items:center; font-size:12px; font-weight:800}
.note-0::after{content:'—'; opacity:.6}
.note-1::after{content:'R';}
.note-2::after{content:'3';}
.note-3::after{content:'5';}
.note-4::after{content:'8';}

.row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px}

/* ===== Overlay / Done ===== */
.overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,6,8,.66); backdrop-filter:blur(6px); z-index:10}
.loader{
  width:96px; height:96px; position:relative; display:grid; place-items:center; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, rgba(242,199,108,.10), rgba(0,0,0,0));
  box-shadow:inset 0 0 0 1px rgba(212,172,82,.18), 0 0 26px rgba(212,172,82,.18);
}
.ring{position:absolute; inset:10px; border-radius:50%; border:3px solid rgba(242,199,108,.18); border-top-color:rgba(242,199,108,.9); animation:spin 1.1s linear infinite}
.ring2{inset:20px; border-top-color:rgba(242,199,108,.55); animation-duration:1.8s}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay p{margin-top:12px; text-align:center; color:#E9D9B3; font-weight:700; font-size:14px}

#done{display:none}
.center{text-align:center}
.ok{display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%;
  background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; font-weight:900; margin-right:6px}
.passbox{display:flex; align-items:center; gap:8px; justify-content:space-between; border:1px solid var(--border);
  background:rgba(13,17,24,.6); border-radius:10px; padding:8px 10px; margin-top:8px}
.passbox b{font-size:16px; letter-spacing:1px}
.thanks{
  margin-top:12px; border-radius:12px; padding:10px;
  background:
    linear-gradient(#0d1118cc,#0d1118cc) padding-box,
    linear-gradient(120deg,var(--gold-2),var(--gold-3)) border-box;
  border:1px solid transparent;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 6px 28px rgba(212,172,82,.12), inset 0 0 .5px rgba(255,255,255,.06);
}
.thanks img{max-width:100%; width:220px; height:auto; filter:drop-shadow(0 2px 12px rgba(212,172,82,.25))}
</style>
</head>
<body>
<!-- Background -->
<div class="back" aria-hidden="true">
  <div class="grid-ortho"></div>
  <div class="grid-plane"></div>
  <div class="halo"></div>
  <div class="vignette"></div>
</div>

<header>
  <div class="brand"><div class="logo">∞</div><span>Infinie & gratuit</span></div>
  <div class="badge">Beat Maker — local</div>
</header>

<main>
  <!-- APP -->
  <section id="app" class="wrap fade show" aria-live="polite">
    <div class="card">
      <h2 class="title">Créateur de prod / Beat Maker</h2>
      <div class="muted">Drums échantillonnés ultra stables + basse/pad synthé. Choisis durée, BPM, swing, tonalité — exporte en WAV.</div>

      <!-- Controls -->
      <div class="controls">
        <div class="control"><label>Durée</label>
          <select id="duration">
            <option value="60">1:00</option><option value="120">2:00</option>
            <option value="180">3:00</option><option value="240">4:00</option>
          </select>
        </div>
        <div class="control"><label>BPM</label>
          <input id="bpm" type="number" min="60" max="180" step="1" value="120"/>
        </div>
        <div class="control"><label>Swing</label>
          <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0"/>
        </div>
        <div class="control"><label>Tonalité</label>
          <select id="root"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
        </div>
        <div class="control"><label>Échelle</label>
          <select id="scale"><option value="minor">Mineur</option><option value="major">Majeur</option></select>
        </div>
        <div class="control"><label>Master FX</label>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
            <button class="btn small" id="fxRev">Reverb</button>
            <button class="btn small" id="fxDel">Delay</button>
            <button class="btn small" id="fxComp">Comp</button>
          </div>
        </div>
      </div>

      <!-- Transport -->
      <div class="row">
        <div style="display:flex; gap:6px; align-items:center">
          <button class="btn primary" id="playBtn">▶︎ Play / Pause</button>
          <button class="btn" id="stopBtn">■ Stop</button>
          <span class="badge" style="border-radius:10px;padding:4px 8px" id="posBadge">Barre 1 • Pas 1</span>
        </div>
        <div style="display:flex; gap:6px; align-items:center">
          <button class="btn small" id="clearBtn">Effacer tout</button>
          <button class="btn small" id="exportBtn">Exporter WAV</button>
        </div>
      </div>

      <!-- Sequencer -->
      <div class="sequencer">
        <!-- DRUMS -->
        <div class="track" data-track="drums">
          <div class="trackHead">
            <div class="trackTitle"><strong>Drums</strong><span class="smallmuted">Kick / Snare / Hat / Clap</span></div>
            <div class="mix">
              <span class="smallmuted">Vol</span><input type="range" min="0" max="1" step="0.01" value="0.9" class="vol">
              <span class="smallmuted">Pan</span><input type="range" min="-1" max="1" step="0.01" value="0" class="pan">
              <button class="btn small mute">Mute</button><button class="btn small solo">Solo</button>
            </div>
          </div>
          <div class="legend">Kick</div><div class="grid row-kick"></div>
          <div class="legend">Snare</div><div class="grid row-snare"></div>
          <div class="legend">Hat</div><div class="grid row-hat"></div>
          <div class="legend">Clap</div><div class="grid row-clap"></div>
        </div>

        <!-- BASS -->
        <div class="track" data-track="bass">
          <div class="trackHead">
            <div class="trackTitle"><strong>Bass</strong><span class="smallmuted">Degrés : — / R / 3 / 5 / 8</span></div>
            <div class="mix">
              <span class="smallmuted">Vol</span><input type="range" min="0" max="1" step="0.01" value="0.85" class="vol">
              <span class="smallmuted">Pan</span><input type="range" min="-1" max="1" step="0.01" value="0" class="pan">
              <button class="btn small mute">Mute</button><button class="btn small solo">Solo</button>
            </div>
          </div>
          <div class="grid row-bass"></div>
        </div>

        <!-- PAD -->
        <div class="track" data-track="pad">
          <div class="trackHead">
            <div class="trackTitle"><strong>Pad / Chords</strong><span class="smallmuted">Accords tenus</span></div>
            <div class="mix">
              <span class="smallmuted">Vol</span><input type="range" min="0" max="1" step="0.01" value="0.7" class="vol">
              <span class="smallmuted">Pan</span><input type="range" min="-1" max="1" step="0.01" value="0" class="pan">
              <button class="btn small mute">Mute</button><button class="btn small solo">Solo</button>
            </div>
          </div>
          <div class="grid row-pad"></div>
          <div class="smallmuted" style="margin-top:6px">Astuce : cases 1/5/9/13 = accords d’une noire.</div>
        </div>
      </div>

      <div class="row">
        <span class="smallmuted">Raccourcis : Espace Play/Pause • Cmd/Ctrl+K Clear • Cmd/Ctrl+E Export</span>
        <span class="smallmuted">100% local — aucun upload</span>
      </div>
    </div>
  </section>

  <!-- Overlay -->
  <div class="overlay" id="overlay" aria-live="polite">
    <div>
      <div class="loader"><div class="ring"></div><div class="ring ring2"></div></div>
      <p id="overlayText">Préparation…</p>
    </div>
  </div>

  <!-- DONE -->
  <section id="done" class="wrap fade">
    <div class="card center">
      <div><span class="ok">✓</span><strong>Export prêt</strong></div>
      <div class="muted" style="margin-top:6px">Télécharge ta prod en WAV.</div>

      <div class="thanks" aria-label="Merci !">
        <img src="merci.png" alt="Notre personnage dit « merci »">
      </div>

      <div class="passbox">
        <span class="muted">Fichier</span>
        <b id="fileName">beat.wav</b>
        <a class="btn small" id="dlWav" download="beat.wav" href="#">Télécharger</a>
      </div>

      <div style="margin-top:10px">
        <button class="btn small" id="backBtn">Revenir au beat</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Helpers / state ===== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const clamp = (v,a,b)=> Math.min(b, Math.max(a,v));
const wait = ms => new Promise(r=> setTimeout(r, ms));

/* UI refs */
const durationSel=$('#duration'), bpmInput=$('#bpm'), swingInput=$('#swing'), rootSel=$('#root'), scaleSel=$('#scale');
const playBtn=$('#playBtn'), stopBtn=$('#stopBtn'), clearBtn=$('#clearBtn'), exportBtn=$('#exportBtn'), posBadge=$('#posBadge');
const overlay=$('#overlay'), overlayText=$('#overlayText');
const app=$('#app'), done=$('#done'), dlWav=$('#dlWav'), backBtn=$('#backBtn'), fileName=$('#fileName');

/* Sequencer model */
const STEPS=16;
const rows={
  kick: new Array(STEPS).fill(false),
  snare:new Array(STEPS).fill(false),
  hat:  new Array(STEPS).fill(false),
  clap: new Array(STEPS).fill(false),
  bass: new Array(STEPS).fill(0),
  pad:  new Array(STEPS).fill(0)
};

/* Audio engine */
let ctx=null, master=null, tracks={}, fx={}, soloTrack=null;
let playing=false, currentStep=0, nextNoteTime=0, lookahead=0.025, scheduleAhead=0.1, timerID=null;
let swingAmt=0;

/* ===== Music helpers ===== */
const noteMap={C:0,'C#':1,D:2,'D#':3,E:4,F:5,'F#':6,G:7,'G#':8,A:9,'A#':10,B:11};
function midiToFreq(m){ return 440*Math.pow(2,(m-69)/12); }
function scaleDegrees(root='C', type='minor'){
  const r=noteMap[root]||0;
  const minor=[0,2,3,5,7,8,10], major=[0,2,4,5,7,9,11];
  return (type==='major'?major:minor).map(x=>(r+x+120)%12);
}
function chordFromScale(deg, degs){ return [degs[deg%degs.length], degs[(deg+2)%degs.length], degs[(deg+4)%degs.length]]; }

/* ===== Grid building (robuste & accessible) ===== */
function buildGrid(){
  const map = [
    ['.row-kick','kick',false],
    ['.row-snare','snare',false],
    ['.row-hat','hat',false],
    ['.row-clap','clap',false],
    ['.row-bass','bass',true],
    ['.row-pad','pad',true],
  ];
  for(const [sel,kind,isNote] of map){
    const cont = $(sel); cont.innerHTML='';
    for(let i=0;i<STEPS;i++){
      const c = document.createElement('div');
      c.className = 'cell'+(isNote?' noteCell note-0':'');
      c.setAttribute('role','button'); c.setAttribute('tabindex','0');
      c.setAttribute('aria-pressed','false');
      c.dataset.kind=kind; c.dataset.i=i;
      c.addEventListener('click', onCellToggle);
      c.addEventListener('keydown', e=>{
        if(e.key===' '||e.key==='Enter'){ e.preventDefault(); onCellToggle.call(c, e); }
      });
      cont.appendChild(c);
    }
  }
}
function onCellToggle(){
  const kind=this.dataset.kind, i=+this.dataset.i;
  if(kind==='kick'||kind==='snare'||kind==='hat'||kind==='clap'){
    rows[kind][i]=!rows[kind][i];
    this.classList.toggle('on', rows[kind][i]);
    this.setAttribute('aria-pressed', rows[kind][i]?'true':'false');
  }else{ // notes
    rows[kind][i]=(rows[kind][i]+1)%5;
    for(let k=0;k<=4;k++) this.classList.remove('note-'+k);
    this.classList.add('note-'+rows[kind][i]);
    const on = rows[kind][i]!==0;
    this.classList.toggle('on', on);
    this.setAttribute('aria-pressed', on?'true':'false');
  }
}

/* ===== Track mixers (vol/pan/mute/solo) ===== */
function wireMixers(){
  $$('.track').forEach(tr=>{
    const name = tr.dataset.track;
    const vol = tr.querySelector('.vol'), pan = tr.querySelector('.pan');
    const muteBtn = tr.querySelector('.mute'), soloBtn = tr.querySelector('.solo');
    vol.addEventListener('input', ()=> { if(tracks[name]) tracks[name].gain.gain.value=+vol.value; });
    pan.addEventListener('input', ()=> { if(tracks[name]) tracks[name].pan.pan.value=+pan.value; });
    muteBtn.addEventListener('click', ()=>{
      const m = tr.classList.toggle('muted');
      if(tracks[name]) tracks[name].gain.gain.value = m?0:+vol.value;
    });
    soloBtn.addEventListener('click', ()=>{
      soloTrack = (soloTrack===name)? null : name;
      applySolo();
    });
  });
}
function applySolo(){
  $$('.track').forEach(tr=>{
    const name = tr.dataset.track;
    const volEl = tr.querySelector('.vol');
    const base = tr.classList.contains('muted')? 0 : +volEl.value;
    if(tracks[name]) tracks[name].gain.gain.value = (soloTrack===null || soloTrack===name) ? base : 0;
  });
}

/* ===== Engine: create, with pre-rendered drum buffers ===== */
async function ensureAudio(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  // master & FX
  master = ctx.createGain(); master.gain.value=1;
  const masterPan = ctx.createStereoPanner(); masterPan.pan.value=0;
  fx.reverb = buildReverb(ctx, 2.1, 2600);
  fx.delay = ctx.createDelay(1.0); fx.delay.delayTime.value=0.28;
  const delayGain = ctx.createGain(); delayGain.gain.value=0.22;
  fx.comp = ctx.createDynamicsCompressor();
  fx.comp.threshold.value=-10; fx.comp.ratio.value=3; fx.comp.attack.value=0.005; fx.comp.release.value=0.08;

  master.connect(fx.reverb.input);
  master.connect(fx.delay);
  master.connect(masterPan);
  fx.reverb.output.connect(masterPan);
  fx.delay.connect(delayGain).connect(masterPan);
  masterPan.connect(fx.comp).connect(ctx.destination);

  // tracks
  ['drums','bass','pad'].forEach(n=>{
    const gain=ctx.createGain(); gain.gain.value = document.querySelector(`[data-track="${n}"] .vol`).value;
    const pan=ctx.createStereoPanner(); pan.pan.value = document.querySelector(`[data-track="${n}"] .pan`).value;
    gain.connect(pan).connect(master);
    tracks[n]={gain, pan};
  });

  // load drum buffers (procedurally rendered once => sample-based tightness)
  drums.kick = await renderKick(ctx);
  drums.snare= await renderSnare(ctx);
  drums.hat   = await renderHat(ctx,false);
  drums.ohat  = await renderHat(ctx,true);
  drums.clap  = await renderClap(ctx);
}

/* ===== Drum buffer rendering (909-ish) ===== */
const drums={}; // AudioBuffer
function renderKick(ac){
  const oac = new OfflineAudioContext(1, ac.sampleRate*1.0|0, ac.sampleRate);
  const o = oac.createOscillator(); o.type='sine';
  const g = oac.createGain();
  o.frequency.setValueAtTime(155,0);
  o.frequency.exponentialRampToValueAtTime(45, 0.12);
  g.gain.setValueAtTime(1.0,0);
  g.gain.exponentialRampToValueAtTime(0.0001, 0.15);
  o.connect(g).connect(oac.destination); o.start(0); o.stop(0.18);
  return oac.startRendering();
}
function renderNoise(ac, dur=0.25){
  const oac = new OfflineAudioContext(1, ac.sampleRate*dur|0, ac.sampleRate);
  const buf = oac.createBuffer(1, oac.length, oac.sampleRate);
  const d = buf.getChannelData(0);
  for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2.2); }
  const src = oac.createBufferSource(); src.buffer=buf;
  src.connect(oac.destination); src.start(0);
  return oac.startRendering();
}
async function renderSnare(ac){
  const noise = await renderNoise(ac, 0.2);
  const oac = new OfflineAudioContext(1, ac.sampleRate*0.25|0, ac.sampleRate);
  const src = oac.createBufferSource(); src.buffer=noise;
  const bp = oac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.7;
  const g = oac.createGain(); g.gain.setValueAtTime(0.85,0); g.gain.exponentialRampToValueAtTime(0.0001,0.18);
  src.connect(bp).connect(g).connect(oac.destination);
  src.start(0);
  return oac.startRendering();
}
async function renderHat(ac, open=false){
  const noise = await renderNoise(ac, open?0.35:0.12);
  const oac = new OfflineAudioContext(1, ac.sampleRate*(open?0.35:0.12)|0, ac.sampleRate);
  const src = oac.createBufferSource(); src.buffer=noise;
  const hp = oac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000;
  const g = oac.createGain(); g.gain.setValueAtTime(open?0.38:0.28, 0);
  g.gain.exponentialRampToValueAtTime(0.0001, open?0.33:0.08);
  src.connect(hp).connect(g).connect(oac.destination); src.start(0);
  return oac.startRendering();
}
async function renderClap(ac){
  const oac = new OfflineAudioContext(1, ac.sampleRate*0.25|0, ac.sampleRate);
  const makeBurst = (t)=>{
    const nbuf = oac.createBuffer(1, Math.floor(oac.sampleRate*0.12), oac.sampleRate);
    const d = nbuf.getChannelData(0);
    for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2.0); }
    const src = oac.createBufferSource(); src.buffer=nbuf;
    const hp = oac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    const g = oac.createGain(); g.gain.setValueAtTime(0.65,t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
    src.connect(hp).connect(g).connect(oac.destination);
    src.start(t);
  };
  [0,0.012,0.028].forEach(makeBurst);
  return oac.startRendering();
}

/* ===== FX toggles ===== */
$('#fxRev').addEventListener('click', ()=>{ ensureAudio(); fx.reverb.active=!fx.reverb.active; $('#fxRev').classList.toggle('primary', fx.reverb.active); });
$('#fxDel').addEventListener('click', ()=>{ ensureAudio(); fx.delay.active=!fx.delay.active; $('#fxDel').classList.toggle('primary', fx.delay.active); });
$('#fxComp').addEventListener('click', ()=>{ ensureAudio(); fx.comp.active=!fx.comp.active; $('#fxComp').classList.toggle('primary', fx.comp.active); });

/* ===== Instruments (runtime) ===== */
function playBuffer(buf, when, dest){
  const s = ctx.createBufferSource(); s.buffer=buf; s.connect(dest); s.start(when); return s;
}
function trigKick(t){ playBuffer(drums.kick, t, tracks.drums.gain); }
function trigSnare(t){ playBuffer(drums.snare,t, tracks.drums.gain); }
function trigHat(t, open=false){ playBuffer(open?drums.ohat:drums.hat, t, tracks.drums.gain); }
function trigClap(t){ playBuffer(drums.clap, t, tracks.drums.gain); }

function trigBass(t, degree=1){
  if(degree===0) return;
  const degs = scaleDegrees(rootSel.value, scaleSel.value);
  const map = {1:0,2:2,3:4,4:7};
  const base = 36 + degs[0];
  const freq = midiToFreq(base + (map[degree]||0));
  const o = ctx.createOscillator(), g = ctx.createGain(), f=ctx.createBiquadFilter();
  o.type='sawtooth'; f.type='lowpass'; f.frequency.value=500;
  g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.6, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
  o.frequency.setValueAtTime(freq,t);
  o.connect(f).connect(g).connect(tracks.bass.gain); o.start(t); o.stop(t+0.5);
}
function trigPad(t, degree=1, len=0.5){
  if(degree===0) return;
  const degs = scaleDegrees(rootSel.value, scaleSel.value);
  const chord = chordFromScale(0, degs);
  const add = {1:[0,4,7],2:[4,7,11],3:[7,11,14],4:[12,16,19]}[degree] || [0,4,7];
  const freqs = chord.map(n => midiToFreq(48+n)).map((f,i)=> f*Math.pow(2, add[i%add.length]/12));
  const g = ctx.createGain(); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.08); g.gain.exponentialRampToValueAtTime(0.0001,t+len);
  freqs.forEach((freq,i)=>{
    const o=ctx.createOscillator(), f=ctx.createBiquadFilter(); o.type='sawtooth'; f.type='lowpass'; f.frequency.value=1800;
    o.frequency.setValueAtTime(freq*(i===1?0.999:i===2?1.002:1),t);
    o.connect(f).connect(g).connect(tracks.pad.gain); o.start(t); o.stop(t+len+0.02);
  });
}

/* ===== Reverb builder ===== */
function buildReverb(context, seconds=2.2, cutoff=2600){
  const input=context.createGain(), output=context.createGain();
  const convolver=context.createConvolver();
  const len = context.sampleRate*seconds|0;
  const imp=context.createBuffer(2,len,context.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d=imp.getChannelData(ch); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2.6); }
  }
  convolver.buffer=imp;
  const lp=context.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=cutoff;
  input.connect(convolver).connect(lp).connect(output);
  return {input, output, active:true};
}

/* ===== Scheduler (précis + fluide) ===== */
function secondsPerStep(){ const bpm=clamp(+bpmInput.value||120,60,180); return (60/bpm)/2; } // 8th note
function schedule(){
  while(nextNoteTime < ctx.currentTime + scheduleAhead){
    scheduleStep(currentStep, nextNoteTime);
    nextNoteTime += secondsPerStep();
    currentStep = (currentStep+1)%STEPS;
  }
  timerID = setTimeout(schedule, lookahead*1000);
}
function scheduleStep(step, t){
  markPlayhead(step);
  // swing
  const swing = +swingInput.value||0;
  const tt = t + (step%2===1 ? swing*secondsPerStep()*0.5 : 0);

  if(rows.kick[step])  trigKick(tt);
  if(rows.snare[step]) trigSnare(tt);
  if(rows.hat[step])   trigHat(tt, step%4===3);
  if(rows.clap[step])  trigClap(tt);

  if(rows.bass[step])  trigBass(tt, rows.bass[step]);
  if(rows.pad[step])   trigPad(tt,  rows.pad[step], secondsPerStep()*2.0);

  const bar = Math.floor(step/4)+1, pos=(step%4)+1;
  posBadge.textContent = `Barre ${bar} • Pas ${pos}`;
}
function markPlayhead(step){
  $$('.grid').forEach(g=>{
    [...g.children].forEach((c,i)=> c.classList.toggle('play', i===step));
  });
}

/* ===== Transport ===== */
function start(){
  ensureAudio();
  if(!ctx) return;
  if(playing){ pause(); return; }
  applySolo();
  playing=true;
  currentStep=0;
  nextNoteTime = ctx.currentTime + 0.06;
  schedule();
  playBtn.classList.add('primary');
}
function pause(){
  playing=false;
  playBtn.classList.remove('primary');
  if(timerID){ clearTimeout(timerID); timerID=null; }
}
function stop(){ pause(); currentStep=0; markPlayhead(-1); posBadge.textContent='Barre 1 • Pas 1'; }

/* ===== Clear ===== */
function clearAll(){
  Object.keys(rows).forEach(k=> rows[k]=rows[k].map(v=> typeof v==='boolean'? false : 0));
  buildGrid();
}

/* ===== Export WAV (offline, sample-accurate) ===== */
async function exportWAV(){
  await ensureAudio(); // to use same sampleRate
  const totalSec=+durationSel.value||60;
  const bpm=clamp(+bpmInput.value||120,60,180);
  const sr=ctx.sampleRate;
  const off = new OfflineAudioContext(2, Math.ceil(totalSec*sr), sr);

  // master+fx
  const master=off.createGain(); master.gain.value=1;
  const pan=off.createStereoPanner(); pan.pan.value=0;
  const comp=off.createDynamicsCompressor(); comp.threshold.value=-10; comp.ratio.value=3; comp.attack.value=0.005; comp.release.value=0.08;
  const rv=buildReverb(off,2.1,2600);
  const delay=off.createDelay(1.0); delay.delayTime.value=0.28;
  const dGain=off.createGain(); dGain.gain.value = $('#fxDel').classList.contains('primary')? 0.22 : 0;

  master.connect(rv.input);
  if($('#fxDel').classList.contains('primary')) master.connect(delay);
  rv.output.connect(pan); delay.connect(dGain).connect(pan);
  master.connect(pan); pan.connect(comp).connect(off.destination);

  // tracks
  const tr={};
  ['drums','bass','pad'].forEach(n=>{
    const g=off.createGain(); g.gain.value = document.querySelector(`[data-track="${n}"] .vol`).value;
    const p=off.createStereoPanner(); p.pan.value = document.querySelector(`[data-track="${n}"] .pan`).value;
    g.connect(p).connect(master); tr[n]={gain:g};
  });

  // drum buffers for offline (reuse rendered data)
  function abToOfflineBuffer(ab){ const buf=off.createBuffer(ab.numberOfChannels, ab.length, ab.sampleRate); for(let ch=0;ch<ab.numberOfChannels;ch++){ buf.getChannelData(ch).set(ab.getChannelData(ch)); } return buf; }
  const K=abToOfflineBuffer(drums.kick), S=abToOfflineBuffer(drums.snare), H=abToOfflineBuffer(drums.hat), OH=abToOfflineBuffer(drums.ohat), C=abToOfflineBuffer(drums.clap);
  const degs=scaleDegrees(rootSel.value, scaleSel.value);
  const stepDur=(60/bpm)/2;
  const loops=Math.ceil(totalSec/(STEPS*stepDur));
  let t=0;
  const mapDeg={1:0,2:2,3:4,4:7};

  function playBuf(buf, when, dest){ const s=off.createBufferSource(); s.buffer=buf; s.connect(dest); s.start(when); }
  function bassNote(when, degree){
    if(degree===0) return;
    const base=36+degs[0]; const freq=midiToFreq(base+(mapDeg[degree]||0));
    const o=off.createOscillator(), g=off.createGain(), f=off.createBiquadFilter();
    o.type='sawtooth'; f.type='lowpass'; f.frequency.value=500;
    g.gain.setValueAtTime(0.0001,when); g.gain.exponentialRampToValueAtTime(0.6,when+0.01); g.gain.exponentialRampToValueAtTime(0.0001,when+0.35);
    o.frequency.setValueAtTime(freq, when);
    o.connect(f).connect(g).connect(tr.bass.gain); o.start(when); o.stop(when+0.5);
  }
  function padNote(when, degree, len){
    if(degree===0) return;
    const chord=chordFromScale(0,degs);
    const add = {1:[0,4,7],2:[4,7,11],3:[7,11,14],4:[12,16,19]}[degree]||[0,4,7];
    const freqs=chord.map(n=> midiToFreq(48+n)).map((f,i)=> f*Math.pow(2, add[i%add.length]/12));
    const g=off.createGain(); g.gain.setValueAtTime(0.0001,when); g.gain.exponentialRampToValueAtTime(0.5,when+0.08); g.gain.exponentialRampToValueAtTime(0.0001,when+len);
    freqs.forEach((freq,i)=>{ const o=off.createOscillator(), f=off.createBiquadFilter(); o.type='sawtooth'; f.type='lowpass'; f.frequency.value=1800; o.frequency.setValueAtTime(freq*(i===1?0.999:i===2?1.002:1),when); o.connect(f).connect(g).connect(tr.pad.gain); o.start(when); o.stop(when+len+0.02); });
  }

  const swing=+swingInput.value||0;
  for(let L=0;L<loops;L++){
    for(let s=0;s<STEPS;s++){
      const tt = t + s*stepDur + (s%2===1 ? swing*stepDur*0.5 : 0);
      if(rows.kick[s])  playBuf(K, tt, tr.drums.gain);
      if(rows.snare[s]) playBuf(S, tt, tr.drums.gain);
      if(rows.hat[s])   playBuf(s%4===3?OH:H, tt, tr.drums.gain);
      if(rows.clap[s])  playBuf(C, tt, tr.drums.gain);
      if(rows.bass[s])  bassNote(tt, rows.bass[s]);
      if(rows.pad[s])   padNote(tt, rows.pad[s], stepDur*2.0);
    }
    t += STEPS*stepDur;
  }

  const rendered = await off.startRendering();
  return pcmToWav(rendered);
}
function pcmToWav(buffer){
  const nCh=buffer.numberOfChannels, sr=buffer.sampleRate, len=buffer.getChannelData(0).length;
  const bytesPerSample=2, blockAlign=nCh*bytesPerSample, dataSize=len*blockAlign;
  const ab=new ArrayBuffer(44+dataSize); const v=new DataView(ab);
  const writeStr=(o,s)=>{ for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
  writeStr(0,'RIFF'); v.setUint32(4,36+dataSize,true); writeStr(8,'WAVE'); writeStr(12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nCh,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*blockAlign,true); v.setUint16(32,blockAlign,true); v.setUint16(34,16,true);
  writeStr(36,'data'); v.setUint32(40,dataSize,true);
  let off=44; const chs=[...Array(nCh)].map((_,i)=> buffer.getChannelData(i));
  for(let i=0;i<len;i++){ for(let ch=0;ch<nCh;ch++){ let s=Math.max(-1,Math.min(1, chs[ch][i])); v.setInt16(off, s<0 ? s*0x8000 : s*0x7FFF, true); off+=2; } }
  return new Blob([ab], {type:'audio/wav'});
}

/* ===== Events ===== */
playBtn.addEventListener('click', start);
stopBtn.addEventListener('click', stop);
clearBtn.addEventListener('click', clearAll);
exportBtn.addEventListener('click', async ()=>{
  overlayText.textContent='Rendu audio offline…';
  overlay.style.display='grid';
  try{
    const wavBlob = await exportWAV();
    const url = URL.createObjectURL(wavBlob);
    dlWav.href = url;
    const name = `beat_${rootSel.value}_${scaleSel.value}_${bpmInput.value}bpm.wav`;
    dlWav.download = name; fileName.textContent=name;
    overlay.style.display='none';
    app.classList.add('hidden');
    setTimeout(()=>{ app.style.display='none'; done.style.display='grid'; done.classList.add('show'); }, 260);
  }catch(e){ console.error(e); overlay.style.display='none'; alert('Échec de l’export.'); }
});
backBtn.addEventListener('click', ()=>{
  done.style.display='none';
  app.style.display='grid';
  app.classList.remove('hidden'); app.classList.add('show');
});
document.addEventListener('keydown', e=>{
  if(e.code==='Space'){ e.preventDefault(); start(); }
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); clearAll(); }
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); exportBtn.click(); }
});

/* ===== Init UI ===== */
buildGrid(); wireMixers();

/* ===== Seed groove propre ===== */
[0,8].forEach(i=> rows.kick[i]=true);
[4,12].forEach(i=> rows.snare[i]=true);
for(let i=0;i<STEPS;i++){ if(i%2===0) rows.hat[i]=true; }
rows.clap[12]=true;
rows.bass[0]=1; rows.bass[4]=2; rows.bass[8]=3; rows.bass[12]=4;
rows.pad[0]=1; rows.pad[4]=2; rows.pad[8]=3; rows.pad[12]=4;
buildGrid(); // re-applique visuels

</script>
</body>
</html>
