<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infinie & gratuit — Générateur de palette</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- jsPDF pour export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0B0B0D; --panel:#0d1120; --text:#E6ECF7; --muted:#A4ADBD;
      --border:rgba(95,123,255,0.18); --accent1:#2FE3FF; --accent2:#1B4CFF; --ring:0 0 0 2px rgba(43,167,255,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 600px at 8% 12%, rgba(43,167,255,0.12), transparent 60%),
        radial-gradient(1000px 800px at 82% 85%, rgba(27,76,255,0.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:0 auto;padding:32px 20px 80px}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo{width:28px;height:28px;border-radius:999px;background:radial-gradient(circle at 30% 30%,var(--accent1),var(--accent2));display:grid;place-items:center;color:#fff;font-weight:800}
    .badge{padding:6px 10px;font-size:12px;border-radius:999px;background:#0f1420;color:#9fb4ff;border:1px solid #1a2340}
    .title{font-size:42px;margin:6px 0 8px;line-height:1.1}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:20px;grid-template-columns:1.1fr .9fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .panel{
      background:linear-gradient(160deg, rgba(27,76,255,0.06), transparent),
                 linear-gradient(180deg, rgba(47,227,255,0.05), transparent 40%), var(--panel);
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03); position:relative;
    }
    .dropzone{
      position:relative; width:100%; aspect-ratio:16/10; display:grid; place-items:center;
      border:1.5px dashed #223054; border-radius:16px; background:#0a0f18; color:#93a6d3; overflow:hidden;
      transition:border-color .2s ease,box-shadow .2s ease,transform .2s ease;
    }
    .dropzone.drag{ border-color:#3a63ff; box-shadow:var(--ring); transform:scale(1.01) }
    .dropzone input{ position:absolute; inset:0; opacity:0; cursor:pointer }

    .preview{ position:relative; width:100%; aspect-ratio:16/10; border-radius:14px; overflow:hidden; background:#090f17; user-select:none }
    .preview img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain }
    .paletteGrid{
      position:absolute; left:16px; right:16px; bottom:16px;
      display:grid; grid-template-columns:repeat(8,1fr); gap:8px;
    }
    @media (max-width:980px){ .paletteGrid{ grid-template-columns:repeat(4,1fr); } }
    .swatch{
      border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    .swatch .meta{
      font-size:11px; padding:6px 8px; display:flex; align-items:center; justify-content:space-between;
      color:#dfe7ff; text-shadow:0 1px 0 rgba(0,0,0,.35); background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.25));
    }

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px}
    .field{margin-bottom:16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, select{
      width:100%; background:#0b0f1a; color:var(--text);
      border:1px solid #1a2340; border-radius:12px; padding:12px 14px; font-size:14px; outline:none;
    }
    .input:focus, select:focus{ box-shadow:var(--ring); border-color:#3a63ff }
    .btn{
      background:#0b0f1a;border:1px solid #1a2340;color:var(--text);
      border-radius:12px;padding:12px 14px;font-size:14px;cursor:pointer;user-select:none;font-weight:700
    }
    .btn:hover{ box-shadow:var(--ring); border-color:#3a63ff }
    .btn.primary{ background: linear-gradient(90deg, var(--accent1), var(--accent2)); border:none; color:white }
    .footer{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .badge-pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;font-size:12px;background:#0b0f1a;border:1px solid #1a2340;border-radius:999px}
    .progress{
      width:64px;height:64px;border-radius:999px; background:radial-gradient(circle at 30% 30%, rgba(47,227,255,.25), rgba(27,76,255,.15));
      display:grid;place-items:center;position:absolute;bottom:16px;right:16px; box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 2px 8px rgba(255,255,255,.06)
    }
    .progress .ring{ width:48px;height:48px;border-radius:999px;border:3px solid rgba(255,255,255,.12); border-right-color:rgba(47,227,255,.9); animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .ai-note{
      position:absolute; right:16px; bottom:90px; font-size:11px; color:#b8c7ff; background:#0b0f1a; border:1px solid #1a2340;
      padding:6px 10px; border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.4)
    }
    .hidden{display:none !important}
    .mini{font-size:11px;color:#9fb4ff}
    .copy{cursor:pointer; opacity:.95}
    .copy:hover{opacity:1; text-decoration:underline}
  </style>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="brand"><div class="logo">∞</div> Infinie & gratuit</div>
      <span class="badge">Générateur de palette — 100% local</span>
    </div>

    <h1 class="title">Palette de couleurs à partir d’une image</h1>
    <p class="small">Extraction pro (K-Means en espace LAB) — vos fichiers ne quittent jamais votre appareil.</p>

    <div class="grid">
      <!-- PREVIEW PANEL -->
      <div class="panel" id="panel-preview">
        <div class="dropzone" id="drop">
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;margin-bottom:6px">Déposer une image</div>
            <div class="small">ou <u>Téléverser</u></div>
          </div>
          <input type="file" id="file" accept="image/*"/>
        </div>

        <div class="preview hidden" id="preview">
          <img id="img" alt="Aperçu"/>
          <div class="paletteGrid" id="paletteGrid"></div>
        </div>

        <div class="footer">
          <div class="badge-pill">
            <span id="modeDot" style="width:8px;height:8px;border-radius:99px;background:#3a3f54"></span>
            <span id="modeText">ChromaMind v4 prêt</span>
          </div>
          <div id="fileInfo">Aucune image</div>
        </div>

        <div class="ai-note hidden" id="aiNote">ChromaMind v4 réfléchit… <span id="eta">15</span> s restantes</div>
        <div class="progress hidden" id="busy"><div class="ring"></div></div>
        <div class="small" style="margin-top:8px">Merci de nous faire confiance.</div>
      </div>

      <!-- CONTROLS PANEL -->
      <div class="panel">
        <div class="field">
          <label>Image</label>
          <div class="toolbar">
            <input class="input" type="file" id="file2" accept="image/*"/>
            <button class="btn" id="reset">Réinitialiser</button>
          </div>
        </div>

        <div class="field">
          <label>Paramètres d’extraction</label>
          <div class="toolbar">
            <select class="input" id="k">
              <option value="5">5 couleurs</option>
              <option value="6">6 couleurs</option>
              <option value="8" selected>8 couleurs</option>
              <option value="10">10 couleurs</option>
              <option value="12">12 couleurs</option>
            </select>
            <select class="input" id="order">
              <option value="pop" selected>Trier : fréquence</option>
              <option value="luma">Trier : luminance</option>
              <option value="hue">Trier : teinte</option>
            </select>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <label style="display:flex;gap:8px;align-items:center;margin:0">
              <input type="checkbox" id="skipBW" checked/> <span class="mini">Ignorer quasi-noir/blanc</span>
            </label>
            <label style="display:flex;gap:8px;align-items:center;margin:0">
              <input type="checkbox" id="snapWeb"/> <span class="mini">Arrondir vers Web-safe (optionnel)</span>
            </label>
          </div>
        </div>

        <div class="field">
          <label>Exporter</label>
          <div class="toolbar">
            <button class="btn" id="run" disabled>Lancer</button>
            <button class="btn" id="copyHex" disabled>Copier HEX</button>
            <button class="btn primary" id="downloadPNG" disabled>Télécharger PNG</button>
            <button class="btn primary" id="downloadPDF" disabled>Télécharger PDF</button>
          </div>
          <p class="small" style="margin-top:10px">
            “Lancer” simule un traitement IA de 15 s pour l’immersion. Les résultats sont calculés localement.
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== CONSTANTES ====== */
const COMPANY = 'Infinie & gratuit';

/* ====== DOM ====== */
const drop = document.getElementById('drop');
const file = document.getElementById('file');
const file2 = document.getElementById('file2');
const preview = document.getElementById('preview');
const img = document.getElementById('img');
const paletteGrid = document.getElementById('paletteGrid');

const runBtn = document.getElementById('run');
const copyBtn = document.getElementById('copyHex');
const dlPNGBtn = document.getElementById('downloadPNG');
const dlPDFBtn = document.getElementById('downloadPDF');
const resetBtn = document.getElementById('reset');

const busy = document.getElementById('busy');
const aiNote = document.getElementById('aiNote');
const eta = document.getElementById('eta');

const modeDot = document.getElementById('modeDot');
const modeText = document.getElementById('modeText');
const fileInfo = document.getElementById('fileInfo');

let imageFile=null, imgReady=false, palette=null, lastSheetCanvas=null;

function setBusy(v){ busy.classList.toggle('hidden', !v); aiNote.classList.toggle('hidden', !v); }
function setStatusOk(txt){ modeText.textContent=txt; modeDot.style.background='linear-gradient(90deg, var(--accent1), var(--accent2))'; }
function setStatusErr(txt){ modeText.textContent='⚠️ '+txt; modeDot.style.background='#9b2c2c'; }
function updateRun(){ runBtn.disabled = !imgReady; }

/* ====== Drag & Drop ====== */
['dragover','dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev, e=>{
    if(ev==='dragover'){ e.preventDefault(); drop.classList.add('drag'); }
    if(ev==='dragleave'){ drop.classList.remove('drag'); }
    if(ev==='drop'){ e.preventDefault(); drop.classList.remove('drag'); onFile(e.dataTransfer.files?.[0]); }
  });
});
file.addEventListener('change', e=> onFile(e.target.files?.[0]));
file2.addEventListener('change', e=> onFile(e.target.files?.[0]));
resetBtn.addEventListener('click', resetAll);

function resetAll(){
  imageFile=null; imgReady=false; palette=null; updateRun();
  img.removeAttribute('src'); preview.classList.add('hidden'); drop.classList.remove('hidden');
  paletteGrid.innerHTML=''; [copyBtn,dlPNGBtn,dlPDFBtn].forEach(b=> b.disabled=true);
  lastSheetCanvas=null; fileInfo.textContent='Aucune image'; setStatusOk('ChromaMind v4 prêt');
}

/* ====== Image handling ====== */
async function onFile(f){
  if(!f) return;
  imageFile=f;
  const url=URL.createObjectURL(f);
  img.src=url;
  img.onload=()=>{
    imgReady=true; updateRun();
    preview.classList.remove('hidden'); drop.classList.add('hidden');
    const sizeMB = (f.size/1e6).toFixed(2)+' MB';
    fileInfo.textContent = `${img.naturalWidth}×${img.naturalHeight}px — ${sizeMB}`;
  };
}

/* ====== RUN with fake AI timer ====== */
runBtn.addEventListener('click', async ()=>{
  if(!imgReady) return setStatusErr('Choisis une image');
  setBusy(true);
  let secs=15; eta.textContent=secs;
  modeText.textContent='Analyse couleurs… (ChromaMind v4)';
  const tInt = setInterval(()=>{ secs=Math.max(0,secs-1); eta.textContent=secs; },1000);

  const pCalc = computePaletteFromImage(img, parseInt(document.getElementById('k').value), {
    skipBW: document.getElementById('skipBW').checked,
    order: document.getElementById('order').value,
    snapWeb: document.getElementById('snapWeb').checked
  });

  await Promise.all([pCalc, sleep(15000)]);
  clearInterval(tInt); eta.textContent='0';

  palette = await pCalc;
  renderPalette(palette);
  setStatusOk(`Palette prête — ${palette.length} couleurs`);
  [copyBtn,dlPNGBtn,dlPDFBtn].forEach(b=> b.disabled=false);
  setBusy(false);
});

/* ====== Actions ====== */
copyBtn.addEventListener('click', ()=>{
  if(!palette) return;
  const hex=palette.map(p=>p.hex).join(', ');
  navigator.clipboard.writeText(hex);
  modeText.textContent='HEX copiés dans le presse-papiers';
});
dlPNGBtn.addEventListener('click', ()=>{
  if(!palette) return;
  const canvas = lastSheetCanvas || buildPaletteCanvas(palette, COMPANY);
  lastSheetCanvas = canvas;
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download=(imageFile?.name?.replace(/\.[^.]+$/,'')||'palette')+'_palette.png';
  a.click();
});
dlPDFBtn.addEventListener('click', ()=>{
  if(!palette) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' }); // 595x842
  const margin = 40, pageW=595, pageH=842;

  // ===== Filigrane pro (léger, diagonal) avec nom figé
  try {
    if (pdf.saveGraphicsState && pdf.restoreGraphicsState && pdf.GState) {
      pdf.saveGraphicsState();
      pdf.setGState(new pdf.GState({ opacity: 0.06 }));
      pdf.setFont('helvetica','bold'); pdf.setFontSize(86);
      pdf.setTextColor(30,60,120);
      pdf.text(COMPANY, pageW/2, pageH/2, { align:'center', angle:-28 });
      pdf.restoreGraphicsState();
    }
  } catch(e) { /* fallback silencieux */ }

  // ===== Entête
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
  pdf.setTextColor(0,0,0);
  pdf.text(COMPANY, margin, 54);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  const date = new Date().toLocaleString();
  pdf.text(`Palette générée le ${date}`, margin, 74);

  // ===== Grille
  const cols=4, swH=80, gap=14;
  const swW=(pageW - margin*2 - (cols-1)*gap)/cols;
  let x=margin, y=110, i=0;

  for (const c of palette) {
  // bloc couleur
  pdf.setFillColor(c.r, c.g, c.b);
  pdf.roundedRect(x, y, swW, swH, 8, 8, 'F');

  // bande méta noire
  pdf.setFillColor(0,0,0); pdf.setDrawColor(255,255,255); pdf.setLineWidth(.6);
  pdf.roundedRect(x, y+swH-22, swW, 22, 0, 0, 'F');

  // texte gauche : HEX (monospace) — on force le "#"
  const hexLabel = String.fromCharCode(35) + c.hex.replace('#','');
  pdf.setTextColor(255,255,255);
  pdf.setFont('courier','bold'); pdf.setFontSize(12);
  pdf.text(hexLabel, x+10, y+swH-7);

  // texte droit : uniquement le pourcentage (plus de R,G,B ici pour éviter tout chevauchement)
  pdf.setFont('helvetica','normal'); pdf.setFontSize(10);
  const pct = (c.ratio*100).toFixed(1) + '%';
  pdf.text(pct, x+swW-10, y+swH-7, { align:'right' });

  i++; if (i%cols===0){ x=margin; y+=swH+gap; } else { x+=swW+gap; }
}


  // ===== Footer
  pdf.setDrawColor(30,30,40); pdf.line(margin, pageH-70, pageW-margin, pageH-70);
  pdf.setTextColor(120); pdf.setFontSize(10);
  pdf.text('Infinie & gratuit — Générateur de palette (100% local · LAB k-means)', margin, pageH-50);

  pdf.save((imageFile?.name?.replace(/\.[^.]+$/,'')||'palette')+'_palette.pdf');
});

/* ====== Utils ====== */
const sleep = (ms)=> new Promise(r=> setTimeout(r, ms));
const clamp=(v,min,max)=> v<min?min:v>max?max:v;

/* ====== Palette computation (k-means++ en LAB) ====== */
async function computePaletteFromImage(imgEl, K=8, opts={}) {
  const MAX_DIM=640;
  const iw=imgEl.naturalWidth, ih=imgEl.naturalHeight;
  const s=Math.min(1, MAX_DIM/Math.max(iw,ih));
  const W=Math.max(1,Math.round(iw*s)), H=Math.max(1,Math.round(ih*s));

  const can=document.createElement('canvas'); can.width=W; can.height=H;
  const ctx=can.getContext('2d', {willReadFrequently:true});
  ctx.drawImage(imgEl,0,0,W,H);
  let data=ctx.getImageData(0,0,W,H).data;

  const samples=[]; const idxs=[];
  const SKIP_BW = !!opts.skipBW;
  for(let i=0;i<data.length;i+=4){
    const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
    if(a<200) continue;
    if(SKIP_BW){
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      if(max<20 || min>235) continue;
    }
    if(Math.random()<0.25){
      const lab = rgb2lab(r,g,b);
      samples.push(lab); idxs.push(i/4);
    }
  }
  if(samples.length===0){
    for(let i=0;i<data.length;i+=16){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      if(a<200) continue;
      samples.push(rgb2lab(r,g,b)); idxs.push(i/4);
    }
  }

  const cents=[];
  cents.push(samples[Math.floor(Math.random()*samples.length)].slice());
  while(cents.length<K){
    const d2=samples.map(p=> {
      let m=1e9;
      for(const c of cents){ const d=dist2(p,c); if(d<m) m=d; }
      return m;
    });
    const sum=d2.reduce((a,b)=>a+b,0);
    let r=Math.random()*sum;
    let idx=0; for(let i=0;i<d2.length;i++){ r-=d2[i]; if(r<=0){ idx=i; break; } }
    cents.push(samples[idx].slice());
  }

  const MAX_IT=12;
  let assign=new Array(samples.length).fill(0);
  for(let it=0; it<MAX_IT; it++){
    for(let i=0;i<samples.length;i++){
      let bi=0, bd=1e9;
      for(let c=0;c<K;c++){
        const d=dist2(samples[i], cents[c]);
        if(d<bd){ bd=d; bi=c; }
      }
      assign[i]=bi;
    }
    const acc=Array.from({length:K},()=>[0,0,0,0]);
    for(let i=0;i<samples.length;i++){
      const g=assign[i]; const p=samples[i]; acc[g][0]+=p[0]; acc[g][1]+=p[1]; acc[g][2]+=p[2]; acc[g][3]++;
    }
    for(let c=0;c<K;c++){
      if(acc[c][3]>0) cents[c]=[acc[c][0]/acc[c][3], acc[c][1]/acc[c][3], acc[c][2]/acc[c][3]];
    }
  }

  const counts=new Array(K).fill(0);
  for(const g of assign) counts[g]++;
  let out=[];
  for(let c=0;c<K;c++){
    let [L,a,b]=cents[c];
    let {r,g,bb}=lab2rgb(L,a,b);
    if(opts.snapWeb){ r=Math.round(r/17)*17; g=Math.round(g/17)*17; bb=Math.round(bb/17)*17; }
    r=clamp(Math.round(r),0,255); g=clamp(Math.round(g),0,255); bb=clamp(Math.round(bb),0,255);
    const hex = '#'+[r,g,bb].map(v=> v.toString(16).padStart(2,'0')).join('').toUpperCase();
    out.push({hex, r, g, b:bb, L, a, labB:b, count:counts[c], ratio:counts[c]/assign.length});
  }

  if(opts.order==='luma'){ out.sort((A,B)=> A.L - B.L); }
  else if(opts.order==='hue'){ out.sort((A,B)=> rgbHue(A) - rgbHue(B)); }
  else { out.sort((A,B)=> B.count - A.count); }

  return out;
}
function dist2(a,b){ const d0=a[0]-b[0], d1=a[1]-b[1], d2=a[2]-b[2]; return d0*d0+d1*d1+d2*d2; }
function rgbHue(c){
  const r=c.r/255, g=c.g/255, b=c.b/255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  if(max===min) return 0;
  let h;
  if(max===r) h=(g-b)/(max-min);
  else if(max===g) h=2+(b-r)/(max-min);
  else h=4+(r-g)/(max-min);
  h*=60; if(h<0) h+=360; return h;
}

/* ====== Conversions ====== */
function rgb2lab(r,g,b){
  let [R,G,B]=[r,g,b].map(v=>{ v/=255; return v<=0.04045 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4); });
  let X= (0.4124564*R + 0.3575761*G + 0.1804375*B)/0.95047;
  let Y= (0.2126729*R + 0.7151522*G + 0.0721750*B)/1.00000;
  let Z= (0.0193339*R + 0.1191920*G + 0.9503041*B)/1.08883;
  const f=t=> t>0.008856 ? Math.cbrt(t) : (7.787*t + 16/116);
  const fx=f(X), fy=f(Y), fz=f(Z);
  const L = 116*fy - 16;
  const a = 500*(fx - fy);
  const b_ = 200*(fy - fz);
  return [L,a,b_];
}
function lab2rgb(L,a,b){
  const fy=(L+16)/116, fx= a/500 + fy, fz= fy - b/200;
  const f3=t=> t**3; const inv=t=> t>0.206897 ? f3(t) : (t-16/116)/7.787;
  let X=0.95047*inv(fx), Y=1.00000*inv(fy), Z=1.08883*inv(fz);
  let R=  3.2404542*X + -1.5371385*Y + -0.4985314*Z;
  let G= -0.9692660*X +  1.8760108*Y +  0.0415560*Z;
  let B=  0.0556434*X + -0.2040259*Y +  1.0572252*Z;
  const g=t=> t<=0.0031308 ? 12.92*t : 1.055*Math.pow(t,1/2.4)-0.055;
  return {r: g(R)*255, g: g(G)*255, bb: g(B)*255};
}

/* ====== UI render ====== */
function renderPalette(pal){
  paletteGrid.innerHTML='';
  for(const c of pal){
    const card=document.createElement('div');
    card.className='swatch';
    const color=document.createElement('div');
    color.style.height='56px';
    color.style.background=`rgb(${c.r},${c.g},${c.b})`;
    const meta=document.createElement('div');
    meta.className='meta';
    const hex=document.createElement('span');
    hex.textContent=c.hex; hex.className='copy'; hex.title='Copier';
    hex.onclick=()=> navigator.clipboard.writeText(c.hex);
    const pct=document.createElement('span'); pct.style.opacity=.9; pct.textContent=(c.ratio*100).toFixed(1)+'%';
    meta.appendChild(hex); meta.appendChild(pct);
    card.appendChild(color); card.appendChild(meta);
    paletteGrid.appendChild(card);
  }
}

/* ====== PNG sheet ====== */
function buildPaletteCanvas(pal, company){
  const W=1400, H=900, margin=48;
  const can=document.createElement('canvas'); can.width=W; can.height=H;
  const ctx=can.getContext('2d');

  const grd=ctx.createLinearGradient(0,0,W,H); grd.addColorStop(0,'#0d1120'); grd.addColorStop(1,'#0a0f18');
  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#CFE5FF'; ctx.font='700 38px Inter, system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillText(company || COMPANY, margin, margin+8);
  ctx.font='400 16px Inter, system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillStyle='#9fb4ff'; ctx.fillText('Palette générée (LAB k-means · local)', margin, margin+40);

  const cols=4, gap=18, swH=112;
  const swW = (W - margin*2 - gap*(cols-1)) / cols;
  let x=margin, y=margin+88;
  ctx.font='700 18px Inter, system-ui';
  for(const c of pal){
    ctx.fillStyle=`rgb(${c.r},${c.g},${c.b})`;
    roundRect(ctx, x, y, swW, swH, 14, true, false);
    ctx.fillStyle='rgba(0,0,0,.45)';
    roundRect(ctx, x, y+swH-30, swW, 30, 0, true, false);
    ctx.fillStyle='#fff'; ctx.textBaseline='alphabetic';
    ctx.fillText(c.hex, x+12, y+swH-10);
    ctx.font='400 14px Inter, system-ui'; ctx.fillStyle='#dfe7ff';
    const meta=`${c.r}, ${c.g}, ${c.b} • ${(c.ratio*100).toFixed(1)}%`;
    const tw=ctx.measureText(meta).width;
    ctx.fillText(meta, x+swW-12-tw, y+swH-10);

    x+=swW+gap;
    if (x+swW>W-margin+1){ x=margin; y+=swH+gap; }
  }

  ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.beginPath(); ctx.moveTo(margin, H-72); ctx.lineTo(W-margin, H-72); ctx.stroke();
  ctx.fillStyle='#9fb4ff'; ctx.font='400 14px Inter, system-ui';
  ctx.fillText('Infinie & gratuit — Générateur de palette (100% local)', margin, H-48);

  return can;
}
function roundRect(ctx, x, y, w, h, r=12, fill=true, stroke=false){
  const rr=Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y,   x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x,   y+h, rr);
  ctx.arcTo(x,   y+h, x,   y,   rr);
  ctx.arcTo(x,   y,   x+w, y,   rr);
  ctx.closePath();
  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}
</script>
</body>
</html>
