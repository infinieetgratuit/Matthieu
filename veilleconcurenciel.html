<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Infinie & gratuit — Audit Express (100% Frontend)</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <!-- Export PDF (download), no print dialog -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0B0B0D; --panel:#0d1120; --text:#E6ECF7; --muted:#A4ADBD; --border:rgba(95,123,255,0.18);
      --accent1:#2FE3FF; --accent2:#1B4CFF; --ring:0 0 0 2px rgba(43,167,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 8% 12%, rgba(43,167,255,0.12), transparent 60%),
        radial-gradient(1000px 800px at 82% 85%, rgba(27,76,255,0.10), transparent 55%),
        var(--bg);
      min-height:100%;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 20px 80px}

    /* Brand */
    .brand{display:flex; align-items:center; gap:12px; margin-bottom:22px;}
    .badge{
      width:36px; height:36px; border-radius:999px; display:grid; place-items:center; position:relative;
      box-shadow:0 8px 40px rgba(27,76,255,.2), inset 0 0 0 1px rgba(255,255,255,.06);
      background: radial-gradient(120% 120% at 20% 15%, var(--accent1), var(--accent2));
    }
    .badge::after{content:"∞"; font-weight:800; color:#fff; font-size:20px; line-height:1}
    .wordmark{font-weight:800; letter-spacing:.2px}
    .status{
      margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#0b0f1a; font-size:12px; color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ready{background:#18e3a1; box-shadow:0 0 0 6px rgba(24,227,161,.15)}
    .dot.busy{background:#7aa0ff; animation:pulse .9s ease-in-out infinite alternate}
    @keyframes pulse{to{box-shadow:0 0 0 8px rgba(122,160,255,.14)}}

    .surface{
      background:
        linear-gradient(160deg, rgba(27,76,255,0.06), transparent),
        linear-gradient(180deg, rgba(47,227,255,0.05), transparent 40%),
        var(--panel);
      border:1px solid var(--border); border-radius:22px;
      box-shadow:0 10px 40px rgba(10,14,22,.35);
    }

    /* Buttons */
    .btn{
      appearance:none; border:0; cursor:pointer;
      color:#fff; font-weight:700; border-radius:14px; padding:14px 18px;
      background:linear-gradient(90deg, var(--accent1), var(--accent2));
      transition:transform .06s ease, box-shadow .2s ease;
      box-shadow:0 10px 30px rgba(27,76,255,.25);
    }
    .btn:focus{outline:none; box-shadow:var(--ring), 0 10px 30px rgba(27,76,255,.25)}
    .btn:active{transform:translateY(1px)}
    .ghost{background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none}
    .muted{color:var(--muted)}

    /* Step 1: Input */
    .ask{padding:28px; display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap}
    .input{
      flex:1 1 560px; display:flex; align-items:center; gap:10px; background:#0b0f1a; border:1px solid #1a2340; border-radius:14px; padding:12px 14px;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .input:focus-within{border-color:#2ba7ff; box-shadow:var(--ring)}
    .input input{background:transparent; border:0; outline:0; width:100%; color:var(--text); font-size:16px; line-height:1.6}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; text-align:center}

    /* Step 2: Loader */
    .center{display:grid; place-items:center}
    .loader{padding:40px 28px; text-align:center; gap:18px; display:flex; flex-direction:column; align-items:center; justify-content:center;}
    .pulse{
      width:68px; height:68px; border-radius:999px; position:relative;
      background:conic-gradient(from 0deg, var(--accent1), var(--accent2));
      animation:spin 1.8s linear infinite;
      mask: radial-gradient(farthest-side, transparent 52%, #000 53%);
    }
    .pulse::after{content:""; position:absolute; inset:9px; border-radius:50%; background: radial-gradient(120% 120% at 20% 20%, rgba(47,227,255,.18), rgba(27,76,255,.16)); border:1px solid var(--border);}
    @keyframes spin{to{transform:rotate(360deg)}}
    .rolling{min-height:24px; font-weight:600; font-size:14px}
    .readyBlock{padding:24px 18px; border-radius:14px; border:1px dashed var(--border); background:rgba(27,76,255,.06); font-weight:600}

    /* Step 3: Results */
    .results{padding:24px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:880px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{padding:18px 18px 16px; border-radius:18px; border:1px solid var(--border); background:
      linear-gradient(180deg, rgba(47,227,255,0.04), transparent 40%),
      var(--panel);
      position:relative; overflow:hidden;
    }
    .card h3{margin:0 0 8px; font-size:15px; letter-spacing:.2px}
    .kv{display:grid; grid-template-columns:180px 1fr; gap:8px; margin:10px 0}
    .readable{font-weight:600; font-size:14px; line-height:1.6; letter-spacing:.1px}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0b0f1a; font-size:12px}
    .good{color:#18e3a1} .warn{color:#ffb545} .bad{color:#ff6d6d}

    .section-title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .section-actions{display:flex; gap:8px}

    /* Typewriter */
    [data-typewriter]{white-space:pre-wrap; overflow:hidden; border-right:1px solid rgba(230,236,247,.28)}
    .tw-done{border-right-color:transparent}

    /* Reveal */
    .reveal{opacity:0; transform:translateY(6px); animation:reveal .45s ease forwards}
    @keyframes reveal{to{opacity:1; transform:none}}

    @media print{ .no-print{display:none !important} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Brand + IA status -->
    <div class="brand">
      <div class="badge" aria-hidden="true"></div>
      <div class="wordmark">Infinie & gratuit</div>
      <div id="iaStatus" class="status"><span class="dot busy"></span><span>IA : Initialisation…</span></div>
    </div>

    <!-- Step 1: Ask URL -->
    <section id="step-ask" class="surface ask reveal" style="animation-delay:.05s">
      <div class="input" role="search" aria-label="Champ URL à analyser">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21 21l-4.2-4.2m1.4-5A7.2 7.2 0 1 1 11 3.6a7.2 7.2 0 0 1 7.2 7.2Z" stroke="#7aa0ff" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <input id="url" type="text" placeholder="Colle l’URL d’une page (ex. https://exemple.com/produit)…" spellcheck="false"/>
      </div>
      <button id="go" class="btn">Analyser maintenant</button>
      <button id="demo" class="btn ghost">Essayer avec un exemple</button>
      <div class="hint">⚠️ En cas de blocage CORS, l’outil lit la page via un miroir en lecture seule (r.jina.ai).</div>
    </section>

    <!-- Step 2: Loader (INIT/READY/ANALYZING) -->
    <section id="step-loader" class="surface loader center no-print" hidden>
      <div class="pulse" aria-hidden="true"></div>
      <div id="loader-line" class="rolling">Initialisation de l’IA…</div>
      <div class="muted" style="font-size:12px">Traitement 100% local — aucune donnée envoyée à un serveur Infinie.</div>
      <div id="readyBox" class="readyBlock" hidden>✅ IA prête. Collez un lien et lancez l’analyse.</div>
    </section>

    <!-- Step 3: Results -->
    <section id="step-results" class="surface results" hidden>
      <div class="section-title">
        <h2 style="margin:0;font-size:18px;letter-spacing:.2px">Résultats de l’audit</h2>
        <div class="section-actions no-print">
          <button id="export" class="btn" title="Exporter un PDF téléchargeable">Exporter en PDF</button>
          <button id="again" class="btn ghost">Nouvelle URL</button>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="card reveal" style="animation-delay:.05s">
        <h3>Résumé exécutif</h3>
        <div id="summaryTW" data-typewriter class="readable"></div>
      </div>

      <div class="grid">
        <!-- SEO -->
        <div class="card reveal" style="animation-delay:.08s">
          <h3>SEO & métadonnées</h3>
          <div class="kv readable"><div>Titre</div><div id="titleTW" data-typewriter></div></div>
          <div class="kv readable"><div>Méta description</div><div id="descTW" data-typewriter></div></div>
          <div class="kv readable"><div>Robots (meta)</div><div id="robotsMetaTW" data-typewriter></div></div>
          <div class="kv readable"><div>Canonical</div><div id="canonicalTW" data-typewriter></div></div>
          <div class="kv readable"><div>Lang / Viewport</div><div id="langTW" data-typewriter></div></div>
          <div class="kv readable"><div>Open Graph</div><div id="ogTW" data-typewriter></div></div>
          <div class="kv readable"><div>Twitter Cards</div><div id="twTW" data-typewriter></div></div>
          <div class="kv readable"><div>Hreflang(s)</div><div id="hreflangTW" data-typewriter></div></div>
        </div>

        <!-- CONTENT -->
        <div class="card reveal" style="animation-delay:.11s">
          <h3>Contenu & lisibilité</h3>
          <div class="kv readable"><div>H1</div><div id="h1TW" data-typewriter></div></div>
          <div class="kv readable"><div>Headings H2–H6</div><div id="hxTW" data-typewriter></div></div>
          <div class="kv readable"><div>Mots / Temps de lecture</div><div id="readTW" data-typewriter></div></div>
          <div class="kv readable"><div>Mots-clés dominants</div><div id="kwTW" data-typewriter></div></div>
        </div>

        <!-- LINKS -->
        <div class="card reveal" style="animation-delay:.14s">
          <h3>Liens</h3>
          <div class="kv readable"><div>Interne / Externe</div><div id="linksTW" data-typewriter></div></div>
          <div class="kv readable"><div>Nofollow</div><div id="nofollowTW" data-typewriter></div></div>
          <div class="kv readable"><div>Principaux domaines sortants</div><div id="domainsTW" data-typewriter></div></div>
        </div>

        <!-- IMAGES -->
        <div class="card reveal" style="animation-delay:.17s">
          <h3>Images</h3>
          <div class="kv readable"><div>Comptage</div><div id="imgCountTW" data-typewriter></div></div>
          <div class="kv readable"><div>ALT manquants</div><div id="imgAltTW" data-typewriter></div></div>
          <div class="kv readable"><div>Lazy-loading</div><div id="lazyTW" data-typewriter></div></div>
        </div>

        <!-- SCRIPTS / TECH -->
        <div class="card reveal" style="animation-delay:.20s">
          <h3>Scripts & technologie (heuristique)</h3>
          <div class="kv readable"><div>Libs détectées</div><div id="libsTW" data-typewriter></div></div>
          <div class="kv readable"><div>Trackers</div><div id="trackTW" data-typewriter></div></div>
          <div class="kv readable"><div>CMS / Stack (déduit)</div><div id="cmsTW" data-typewriter></div></div>
        </div>

        <!-- STRUCTURED DATA -->
        <div class="card reveal" style="animation-delay:.23s">
          <h3>Données structurées</h3>
          <div class="kv readable"><div>JSON-LD types</div><div id="ldTW" data-typewriter></div></div>
          <div class="kv readable"><div>Microdata / RDFa</div><div id="microTW" data-typewriter></div></div>
        </div>

        <!-- ROBOTS / SITEMAP -->
        <div class="card reveal" style="animation-delay:.26s">
          <h3>Robots & Sitemap</h3>
          <div class="kv readable"><div>robots.txt</div><div id="robotsTxtTW" data-typewriter></div></div>
          <div class="kv readable"><div>sitemap.xml</div><div id="sitemapTW" data-typewriter></div></div>
        </div>

        <!-- PERFORMANCE HEURISTICS -->
        <div class="card reveal" style="animation-delay:.29s">
          <h3>Performance (statique)</h3>
          <div class="kv readable"><div>Poids HTML (approx.)</div><div id="sizeTW" data-typewriter></div></div>
          <div class="kv readable"><div>Ressources</div><div id="resTW" data-typewriter></div></div>
          <div class="kv readable"><div>Indices vitesse (heur.)</div><div id="perfTW" data-typewriter></div></div>
        </div>
      </div>

      <div class="muted" id="strategy" style="font-size:12px;margin-top:10px"></div>
    </section>
  </div>

  <script>
    // ---------- Mini helpers ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const setStatus = (state,text) => {
      const box = $('#iaStatus');
      const dot = box.querySelector('.dot');
      box.lastElementChild.textContent = 'IA : ' + text;
      dot.className = 'dot ' + (state==='busy' ? 'busy' : 'ready');
    };
    const nowStr = () => new Intl.DateTimeFormat('fr-FR', {dateStyle:'medium', timeStyle:'short'}).format(new Date());
    const clip = (s, n=240) => (s||'').replace(/\s+/g,' ').trim().slice(0,n) + ((s||'').length>n?'…':'');

    // Typewriter
    async function typewriter(el, text, speed=10){
      el.textContent = '';
      const min = 6, max = 16;
      for(let i=0;i<text.length;i++){
        el.textContent += text[i];
        await new Promise(r=>setTimeout(r, speed + Math.random()*(max-min)+min));
      }
      el.classList.add('tw-done');
    }
    async function typeAll(pairs, speed=10){
      for(const [el, text] of pairs){ await typewriter(el, text, speed); }
    }

    // Loader messages
    const loadingLines = [
      "Cartographie du DOM…",
      "Lecture des métadonnées (titre, description, OG)…",
      "Analyse des sections et titres…",
      "Inventaire des liens…",
      "Repérage des scripts et pixels…",
      "Audit des images (ALT, lazy)…",
      "Recherche des données structurées…",
      "Lecture robots.txt & sitemap.xml…",
      "Estimations de performance…",
    ];
    let rollingTimer=null, rollIdx=0;
    function startRolling(){
      $('#loader-line').textContent = loadingLines[0];
      rollIdx=0;
      rollingTimer = setInterval(()=>{
        rollIdx=(rollIdx+1)%loadingLines.length;
        $('#loader-line').textContent = loadingLines[rollIdx];
      }, 1400);
    }
    function stopRolling(){ if(rollingTimer){ clearInterval(rollingTimer); rollingTimer=null; } }

    // URL utils
    function normalizeURL(u){
      try{
        if(!/^https?:\/\//i.test(u)) u = 'https://' + u.replace(/^\/+/, '');
        return new URL(u).toString();
      }catch(e){ return null; }
    }
    function toOrigin(u){ try{ return new URL(u).origin; }catch(e){ return ""; } }
    function stripProtocol(u){ return u.replace(/^https?:\/\//i,''); }

    // Fetch strategies
    async function fetchHTML(target){
      const attempts = [
        {label:'Direct (CORS)', url: target},
        {label:'Miroir (Jina via https)', url:'https://r.jina.ai/http://' + stripProtocol(target)},
        {label:'Miroir (Jina via http)', url:'https://r.jina.ai/https://' + stripProtocol(target)},
      ];
      let lastErr = null;
      for(const a of attempts){
        try{
          const res = await fetch(a.url, {mode:'cors', credentials:'omit'});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const text = await res.text();
          if((text||'').trim().length < 50) throw new Error('Contenu trop court');
          return { html:text, strategy:a.label, via:a.url };
        }catch(err){ lastErr = err; }
      }
      throw lastErr || new Error('Impossible de récupérer la page.');
    }

    // Parse & text helpers
    function parseDOM(html){ return new DOMParser().parseFromString(html, 'text/html'); }
    function textFromHTML(html){
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      tmp.querySelectorAll('script, style, noscript, svg').forEach(n=>n.remove());
      return tmp.textContent.replace(/\s+/g,' ').trim();
    }
    const STOP = new Set(("a,à,ai,ainsi,alors,après,au,aucun,aura,auront,aussi,autre,aux,avec,avez,avoir,bon,car,ce,ces,cette,ceci,cela,celui,comme,comment,contre,ça,ceux,chez,ci,comment,des,du,de,donc,dont,elle,elles,encore,ensuite,entre,est,et,être,eux,fait,fois,font,ici,il,ils,je,la,le,les,leur,leurs,lors,ma,mais,me,mes,moi,mon,ne,ni,nos,notre,nous,on,ou,où,par,parce,parmi,pas,peu,peut,plus,pour,près,qu,quand,que,quel,quelle,quelles,quels,qui,quoi,sans,se,seront,si,sous,sur,ta,te,tes,toi,ton,toujours,tous,tout,trop,tu,un,une,vos,votre,vous,y,the,of,and,to,in,for,on,with,as,by,at,from,is,are,this,that,these,those,be,or,an,if,it,its,into,your,our,their,not,no").split(','));
    function topKeywords(text, limit=15){
      const words = text.toLowerCase().replace(/[^\p{L}\p{N}\- ]/gu,' ').split(/\s+/)
        .filter(w => w && w.length>2 && !STOP.has(w));
      const freq = new Map();
      for(const w of words){ freq.set(w, (freq.get(w)||0)+1); }
      return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,limit)
        .map(([w,c])=>`${w} (${c})`).join(', ');
    }
    function countWords(text){ return (text.match(/\b[\p{L}\p{N}’'-]+\b/gu)||[]).length; }
    function readingTime(words){ const min = Math.max(1, Math.round(words/200)); return `${min} min`; }

    // Extractors (clean output)
    function extractSEO(doc){
      const pick = (sel, attr='content') => (doc.querySelector(sel)?.getAttribute(attr)||'').trim();
      const title = (doc.querySelector('title')?.textContent||'').trim();
      const metaDesc = pick('meta[name="description"]') || pick('meta[name="Description"]');
      const robotsMeta = pick('meta[name="robots"]') || pick('meta[name="googlebot"]');
      const canonical = pick('link[rel="canonical"]','href');
      const lang = (doc.documentElement.getAttribute('lang')||'').trim();
      const viewport = pick('meta[name="viewport"]');

      // OG/Twitter clean flags + key fields
      const ogTags = [...doc.querySelectorAll('meta[property^="og:"]')];
      const twTags = [...doc.querySelectorAll('meta[name^="twitter:"]')];
      const og = {
        present: ogTags.length,
        title: pick('meta[property="og:title"]') ? '✓' : '✗',
        description: pick('meta[property="og:description"]') ? '✓' : '✗',
        image: pick('meta[property="og:image"]') ? '✓' : '✗',
        type: pick('meta[property="og:type"]') || '—'
      };
      const tw = {
        present: twTags.length,
        card: pick('meta[name="twitter:card"]') || '—',
        title: pick('meta[name="twitter:title"]') ? '✓' : '✗',
        description: pick('meta[name="twitter:description"]') ? '✓' : '✗',
        image: pick('meta[name="twitter:image"]') ? '✓' : '✗',
      };

      // Hreflang
      const hreflangs = [...doc.querySelectorAll('link[rel="alternate"][hreflang]')]
        .map(l => `${l.getAttribute('hreflang')} → ${l.getAttribute('href')}`).slice(0,10);

      return { title, metaDesc, robotsMeta, canonical, lang, viewport, og, tw, hreflangs };
    }

    function extractContent(doc, htmlText){
      const h1s = [...doc.querySelectorAll('h1')].map(h=>h.textContent.trim()).filter(Boolean);
      const headings = [2,3,4,5,6].map(n => [n, doc.querySelectorAll(`h${n}`).length]);
      const visibleText = textFromHTML(htmlText);
      const words = countWords(visibleText);
      const rtime = readingTime(words);
      const keywords = topKeywords(visibleText, 15);
      return { h1s, headings, words, rtime, keywords };
    }

    function extractLinks(doc, baseUrl){
      let internalCount=0, externalCount=0, nofollowCount=0, topDomains='—';
      try{
        const base = new URL(baseUrl);
        const links = [...doc.querySelectorAll('a[href]')];
        const domains = new Map();
        links.forEach(a=>{
          const href = a.getAttribute('href'); if(!href || href.startsWith('#') || href.startsWith('javascript:')) return;
          let url; try{ url = new URL(href, base);}catch(e){ return; }
          const isInternal = url.origin === base.origin;
          isInternal ? internalCount++ : externalCount++;
          if((a.getAttribute('rel')||'').toLowerCase().includes('nofollow')) nofollowCount++;
          if(!isInternal) domains.set(url.hostname, (domains.get(url.hostname)||0)+1);
        });
        topDomains = [...domains.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(([d,c])=>`${d} (${c})`).join(', ') || '—';
      }catch(e){}
      return {internalCount, externalCount, nofollowCount, topDomains};
    }

    function extractImages(doc){
      const imgs = [...doc.querySelectorAll('img')];
      return {
        count: imgs.length,
        altMissing: imgs.filter(i=>!(i.getAttribute('alt')||'').trim()).length,
        lazy: imgs.filter(i=> (i.getAttribute('loading')||'').toLowerCase()==='lazy').length,
      };
    }

    function extractScriptsTech(doc, htmlText){
      const scripts = [...doc.querySelectorAll('script[src], script[type="application/ld+json"], script:not([src])')];
      const srcs = scripts.map(s=>s.getAttribute('src')||'');
      const joined = srcs.join(' ') + ' ' + htmlText;
      const libs=[], trackers=[], cmsHints=[];
      const addIf = (re, label, arr=libs)=>{ if(re.test(joined)) arr.push(label); };
      addIf(/jquery/i,'jQuery');
      addIf(/react|__NEXT_DATA__|next\/static/i,'React/Next.js');
      addIf(/vue(\.js)?\/|Vue\.config/i,'Vue');
      addIf(/angular|ng-version/i,'Angular');
      addIf(/svelte/i,'Svelte');
      addIf(/gtag\/js|googletagmanager|gtm\.js/i,'Google Tag Manager', trackers);
      addIf(/google-analytics\.com\/(analytics|ga)\.js|measurement/i,'Google Analytics', trackers);
      addIf(/facebook\.net|fbq\(/i,'Meta Pixel', trackers);
      addIf(/clarity\.ms/i,'Microsoft Clarity', trackers);
      addIf(/hotjar\.com/i,'Hotjar', trackers);
      addIf(/wp-content|wp-includes|wordpress/i,'WordPress', cmsHints);
      addIf(/cdn\.shopify\.com|Shopify/i,'Shopify', cmsHints);
      addIf(/woocommerce/i,'WooCommerce', cmsHints);
      addIf(/prestashop|ps_/i,'PrestaShop', cmsHints);
      addIf(/magento/i,'Magento', cmsHints);
      addIf(/next-head-count/i,'Next.js', cmsHints);
      addIf(/eleventy|hugo|jekyll/i,'Static Site Gen', cmsHints);
      return { libs:[...new Set(libs)], trackers:[...new Set(trackers)], cmsHints:[...new Set(cmsHints)] };
    }

    function extractStructuredData(doc){
      const jsonld = [...doc.querySelectorAll('script[type*="ld+json"]')].map(s=>{
        try{
          const data = JSON.parse(s.textContent.trim()); const arr = Array.isArray(data)?data:[data];
          return arr.map(o=>o['@type']).filter(Boolean);
        }catch(e){ return []; }
      }).flat();
      const micro = [...doc.querySelectorAll('[itemscope][itemtype]')].map(n=> n.getAttribute('itemtype')).filter(Boolean);
      return { jsonld:[...new Set(jsonld)].slice(0,8), micro:[...new Set(micro)].slice(0,8) };
    }

    async function fetchText(url){
      try{ const res = await fetch(url, {mode:'cors', credentials:'omit'}); if(!res.ok) throw 0; return await res.text(); }
      catch(e){ return null; }
    }
    async function robotsAndSitemap(target){
      const origin = toOrigin(target);
      const robotsURL = origin + '/robots.txt';
      const robotsTxt = await fetchText(robotsURL) || await fetchText('https://r.jina.ai/http://' + stripProtocol(robotsURL));
      let sitemapURL = origin + '/sitemap.xml';
      let sitemapText = await fetchText(sitemapURL) || await fetchText('https://r.jina.ai/http://' + stripProtocol(sitemapURL));
      if(robotsTxt){
        const match = robotsTxt.match(/Sitemap:\s*(.+)$/im);
        if(match){
          const sURL = match[1].trim();
          sitemapText = await fetchText(sURL) || await fetchText('https://r.jina.ai/http://' + stripProtocol(sURL)) || sitemapText;
          sitemapURL = sURL;
        }
      }
      return { robots: robotsTxt ? `Trouvé (${robotsURL})` : 'Introuvable', sitemap: sitemapText ? `Trouvé (${sitemapURL})` : 'Introuvable' };
    }
    function performanceHeuristics(doc, htmlText){
      const size = (new TextEncoder().encode(htmlText)).length;
      const prettySize = size > 1024*1024 ? (size/1024/1024).toFixed(2)+' Mo' : (size/1024).toFixed(0)+' Ko';
      const css = doc.querySelectorAll('link[rel="stylesheet"]').length;
      const js = doc.querySelectorAll('script').length;
      const img = doc.querySelectorAll('img').length;
      const fonts = doc.querySelectorAll('link[rel="preload"][as="font"], link[href*=".woff"], link[href*=".woff2"]').length;
      const video = doc.querySelectorAll('video, source[type^="video/"]').length;
      const hints = [];
      if(css>5) hints.push('CSS nombreux (regrouper/minifier)');
      if(js>20) hints.push('JS volumineux (auditer bundle)');
      if(img>30) hints.push('Beaucoup d’images (optimiser/lazy)');
      if(video>0) hints.push('Vidéo détectée (poids élevé possible)');
      return { prettySize, resources: `CSS: ${css} · JS: ${js} · IMG: ${img} · FONTS: ${fonts} · VIDEO: ${video}`, hints: hints.join(' | ') || 'RAS (baseline statique)' };
    }

    // Flow
    const stepAsk = $('#step-ask'), stepLoader = $('#step-loader'), stepResults = $('#step-results');
    const els = {
      summary: $('#summaryTW'),
      title: $('#titleTW'), desc: $('#descTW'), robotsMeta: $('#robotsMetaTW'),
      canonical: $('#canonicalTW'), lang: $('#langTW'),
      og: $('#ogTW'), tw: $('#twTW'), hreflang: $('#hreflangTW'),
      h1: $('#h1TW'), hx: $('#hxTW'), read: $('#readTW'), kw: $('#kwTW'),
      links: $('#linksTW'), nofollow: $('#nofollowTW'), domains: $('#domainsTW'),
      imgCount: $('#imgCountTW'), imgAlt: $('#imgAltTW'), lazy: $('#lazyTW'),
      libs: $('#libsTW'), track: $('#trackTW'), cms: $('#cmsTW'),
      ld: $('#ldTW'), micro: $('#microTW'),
      robotsTxt: $('#robotsTxtTW'), sitemap: $('#sitemapTW'),
      size: $('#sizeTW'), res: $('#resTW'), perf: $('#perfTW'),
      strategy: $('#strategy'),
    };
    function show(el){ el.hidden=false; } function hide(el){ el.hidden=true; }
    function resetTW(){ document.querySelectorAll('[data-typewriter]').forEach(el=>{ el.textContent=''; el.classList.remove('tw-done'); }); }

    let lastAudit=null; // stored for PDF

    async function runAudit(raw){
      const target = normalizeURL(raw);
      if(!target){ alert('URL invalide.'); return; }

      // UI → loader (ANALYZING)
      hide(stepAsk); show(stepLoader);
      $('#readyBox').hidden = true;
      setStatus('busy','Analyse en cours…');
      startRolling();

      // Fetch
      let html, doc, strategy, via;
      try{
        const res = await fetchHTML(target);
        html = res.html; doc = parseDOM(res.html); strategy = res.strategy; via = res.via;
      }catch(e){
        stopRolling(); setStatus('ready','Prête');
        hide(stepLoader); show(stepAsk);
        alert("Échec de récupération de la page (CORS + fallback). Essayez une autre URL.");
        return;
      }

      // Extract
      const seo = extractSEO(doc);
      const content = extractContent(doc, html);
      const links = extractLinks(doc, target);
      const imgs = extractImages(doc);
      const tech = extractScriptsTech(doc, html);
      const sd = extractStructuredData(doc);
      const rs = await robotsAndSitemap(target);
      const perf = performanceHeuristics(doc, html);

      // Prepare output strings (clean & credible)
      const httpsOk = target.startsWith('https://') ? '✔︎' : '✖︎';
      const sumText =
        `Cible: ${target}\n`+
        `Titre (${(seo.title||'').length} car.) · Desc (${(seo.metaDesc||'').length} car.) · H1 (${content.h1s.length})\n`+
        `Mots: ${content.words} · Lecture: ${content.rtime} · Liens int/ext: ${links.internalCount}/${links.externalCount}\n`+
        `Images: ${imgs.count} (ALT manquants: ${imgs.altMissing}) · JSON-LD: ${(sd.jsonld||[]).length||0}\n`+
        `HTTPS: ${httpsOk} · robots.txt: ${rs.robots} · sitemap: ${rs.sitemap}`;

      const ogText = (seo.og.present
        ? `Présent (${seo.og.present}) · title ${seo.og.title} · description ${seo.og.description} · image ${seo.og.image} · type=${seo.og.type}`
        : 'Aucun');
      const twText = (seo.tw.present
        ? `Présent (${seo.tw.present}) · card=${seo.tw.card} · title ${seo.tw.title} · description ${seo.tw.description} · image ${seo.tw.image}`
        : 'Aucun');

      const pairs = [
        [els.summary, sumText],
        [els.title, clip(seo.title)||'—'],
        [els.desc, clip(seo.metaDesc)||'—'],
        [els.robotsMeta, seo.robotsMeta || '—'],
        [els.canonical, seo.canonical || '—'],
        [els.lang, `${seo.lang || '—'} · viewport=${seo.viewport || '—'}`],
        [els.og, ogText],
        [els.tw, twText],
        [els.hreflang, (seo.hreflangs.length? `${seo.hreflangs.length} variantes · `+seo.hreflangs.join(' | ') : '—')],
        [els.h1, content.h1s.slice(0,3).map(clip).join(' | ') || '—'],
        [els.hx, content.headings.map(([n,c])=>`H${n}=${c}`).join(' · ') || '—'],
        [els.read, `${content.words} mots · ${content.rtime}`],
        [els.kw, content.keywords || '—'],
        [els.links, `${links.internalCount} / ${links.externalCount}`],
        [els.nofollow, `${links.nofollowCount}`],
        [els.domains, links.topDomains || '—'],
        [els.imgCount, `${imgs.count}`],
        [els.imgAlt, `${imgs.altMissing}`],
        [els.lazy, `${imgs.lazy}`],
        [els.libs, (tech.libs.join(', ')||'—')],
        [els.track, (tech.trackers.join(', ')||'—')],
        [els.cms, (tech.cmsHints.join(', ')||'—')],
        [els.ld, (sd.jsonld.join(', ')||'—')],
        [els.micro, (sd.micro.join(', ')||'—')],
        [els.robotsTxt, rs.robots],
        [els.sitemap, rs.sitemap],
        [els.size, perf.prettySize],
        [els.res, perf.resources],
        [els.perf, perf.hints || '—'],
      ];

      // Persist for export
      lastAudit = {
        target, when: nowStr(), strategy: `${strategy}${via ? ' • ' + via : ''}`,
        seo, content, links, imgs, tech, sd, rs, perf, summary: sumText
      };

      // Show results + type animations
      stopRolling(); hide(stepLoader); show(stepResults); resetTW();
      $('#strategy').textContent = `Stratégie de lecture : ${lastAudit.strategy}`;
      await typeAll(pairs, 8);

      // Back to READY state
      setStatus('ready','Prête');
    }

    // INIT → READY pause at load
    (function init(){
      show(stepLoader);
      setStatus('busy','Initialisation…');
      $('#loader-line').textContent = 'Initialisation des modules…';
      setTimeout(()=>{
        $('#loader-line').textContent = 'Systèmes en ligne.';
        $('#readyBox').hidden = false;
        setStatus('ready','Prête');
      }, 1200);
      // then show ask
      setTimeout(()=>{ hide(stepLoader); show(step-ask); }, 1500);
    })();

    // Events
    $('#go').addEventListener('click', ()=> runAudit($('#url').value.trim()));
    $('#url').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#go').click(); });
    $('#demo').addEventListener('click', ()=>{ $('#url').value='https://www.wikipedia.org/'; $('#go').click(); });
    $('#again').addEventListener('click', ()=>{
      hide(stepResults); show(stepAsk); $('#url').focus(); setStatus('ready','Prête');
    });

    // PDF EXPORT (download, no print)
    async function exportPDF(){
      if(!lastAudit){ alert('Faites une analyse d’abord.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const A4W = 595.28, A4H = 841.89, margin = 28;

      // Cover
      doc.setFillColor(14,17,32);
      doc.roundedRect(margin, margin, A4W-2*margin, 110, 10, 10, 'F');
      // Accent halos
      doc.setFillColor(47,227,255, 0.25); doc.circle(margin+90, margin+55, 46, 'F');
      doc.setFillColor(27,76,255, 0.20); doc.circle(A4W-margin-110, margin+70, 60, 'F');
      // Logo
      doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(24);
      doc.text('∞', margin+18, margin+54);
      // Title
      doc.setFontSize(16); doc.text('Infinie & gratuit — Audit Express', margin+56, margin+48);
      doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(220);
      doc.text(`Cible : ${lastAudit.target}`, margin+56, margin+72, {maxWidth:A4W-2*margin-56});
      doc.text(`Date : ${lastAudit.when}`, margin+56, margin+90);

      // Summary block
      doc.setTextColor(30); doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Résumé', margin, 170);
      doc.setFont('helvetica','normal'); doc.setTextColor(40); doc.setFontSize(11);
      doc.text(lastAudit.summary, margin, 190, {maxWidth:A4W-2*margin});

      // Tables helper
      const sec = (title, rows) => {
        doc.autoTable({
          startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : 260,
          margin: {left: margin, right: margin},
          styles:{fontSize:10, cellPadding:6, lineWidth:0.2},
          headStyles:{fillColor:[20,26,48], textColor:255},
          bodyStyles:{fillColor:[247,248,255]},
          head:[[title,'']],
          body: rows.map(([k,v])=>[k, v]),
          theme:'grid'
        });
      };

      const seo = lastAudit.seo, c = lastAudit.content, l = lastAudit.links, i = lastAudit.imgs, t = lastAudit.tech, sd = lastAudit.sd, r = lastAudit.rs, p = lastAudit.perf;

      sec('SEO & métadonnées', [
        ['Titre', clip(seo.title, 500)||'—'],
        ['Meta description', clip(seo.metaDesc, 500)||'—'],
        ['Robots (meta)', seo.robotsMeta || '—'],
        ['Canonical', seo.canonical || '—'],
        ['Lang / Viewport', `${seo.lang || '—'} · viewport=${seo.viewport || '—'}`],
        ['Open Graph', seo.og.present ? `title ${seo.og.title} · description ${seo.og.description} · image ${seo.og.image} · type=${seo.og.type}` : 'Aucun'],
        ['Twitter Cards', seo.tw.present ? `card=${seo.tw.card} · title ${seo.tw.title} · description ${seo.tw.description} · image ${seo.tw.image}` : 'Aucun'],
        ['Hreflangs', (seo.hreflangs.length? `${seo.hreflangs.length} variantes · ${clip(seo.hreflangs.join(' | '), 600)}` : '—')],
      ]);

      sec('Contenu & lisibilité', [
        ['H1', (c.h1s.slice(0,3).map(h=>clip(h,200)).join(' | ') || '—')],
        ['Headings', c.headings.map(([n,x])=>`H${n}=${x}`).join(' · ') || '—'],
        ['Texte', `${c.words} mots · ${c.rtime}`],
        ['Mots-clés dominants', clip(c.keywords, 600)||'—'],
      ]);

      sec('Liens', [
        ['Interne / Externe', `${l.internalCount} / ${l.externalCount}`],
        ['Nofollow', `${l.nofollowCount}`],
        ['Top domaines sortants', clip(l.topDomains, 600)||'—'],
      ]);

      sec('Images', [
        ['Comptage', `${i.count}`],
        ['ALT manquants', `${i.altMissing}`],
        ['Lazy-loading', `${i.lazy}`],
      ]);

      sec('Scripts & technologies', [
        ['Librairies', clip(t.libs.join(', '), 600)||'—'],
        ['Trackers', clip(t.trackers.join(', '), 600)||'—'],
        ['CMS / Stack (déduit)', clip(t.cmsHints.join(', '), 600)||'—'],
      ]);

      sec('Données structurées', [
        ['JSON-LD types', clip(sd.jsonld.join(', '), 600)||'—'],
        ['Microdata / RDFa', clip(sd.micro.join(', '), 600)||'—'],
      ]);

      sec('Robots & Sitemap', [
        ['robots.txt', r.robots],
        ['sitemap.xml', r.sitemap],
        ['Stratégie de lecture', lastAudit.strategy],
      ]);

      sec('Performance (heuristiques)', [
        ['Poids HTML approx.', p.prettySize],
        ['Ressources', p.resources],
        ['Indices vitesse', p.hints || '—'],
      ]);

      // Save
      const safe = lastAudit.target.replace(/https?:\/\//,'').replace(/[^\w.-]/g,'_');
      doc.save(`Audit_Infinie_${safe}.pdf`);
    }

    $('#export').addEventListener('click', exportPDF);
  </script>
</body>
</html>
