<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Infinie & gratuit â€” PDF Locker (mot de passe)</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0B0B0D; --panel:#0d1120; --text:#E6ECF7; --muted:#A4ADBD;
      --border:rgba(95,123,255,0.18); --accent1:#2FE3FF; --accent2:#1B4CFF;
      --ring:0 0 0 2px rgba(43,167,255,.35)
    }
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
      background:
        radial-gradient(1200px 600px at 8% 12%, rgba(43,167,255,0.12), transparent 60%),
        radial-gradient(1000px 800px at 82% 85%, rgba(27,76,255,0.10), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale
    }
    *,*:before,*:after{box-sizing:border-box}
    :focus-visible{outline:none; box-shadow:var(--ring)}
    ::selection{background:rgba(47,227,255,.25)}

    .wrap{max-width:860px; margin:0 auto; padding:24px 18px 64px}
    .top{display:flex; align-items:center; gap:10px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:999px; color:#fff; font-weight:800;
      background:radial-gradient(circle at 30% 30%, var(--accent1), var(--accent2));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .badge{margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      color:#9fb4ff; background:#0f1420; border:1px solid #1a2340}
    .badge .dot{width:8px; height:8px; border-radius:50%; background:linear-gradient(90deg, var(--accent1), var(--accent2))}
    .title{font-size:28px; line-height:1.15; margin:10px 0 16px; font-weight:800}

    /* Carte unique (compacte) */
    .card{
      border:1px solid var(--border); border-radius:16px; padding:16px;
      background:
        linear-gradient(160deg, rgba(27,76,255,0.06), transparent),
        linear-gradient(180deg, rgba(47,227,255,0.05), transparent 40%),
        var(--panel);
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03)
    }
    .stack{display:flex; flex-direction:column; gap:12px}

    /* Zone dâ€™import */
    .drop{position:relative; display:grid; place-items:center; aspect-ratio:16/9; border-radius:14px;
      border:1.5px dashed #223054; background:#0a0f18; color:#93a6d3; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
    .drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .drop:hover{border-color:#3a63ff}
    .drop.is-drag{transform:scale(1.01); box-shadow:var(--ring); border-color:#3a63ff}
    .hint{text-align:center; font-weight:600}

    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .meta{display:flex; align-items:center; gap:10px; color:#A4ADBD; font-size:12px}
    .name{font-weight:700; color:var(--text)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b0f1a; border:1px solid #1a2340; font-size:12px}
    .dot{width:8px; height:8px; border-radius:50%}
    .ok{background:linear-gradient(90deg, var(--accent1), var(--accent2))}
    .err{background:#9b2c2c}

    .btn{appearance:none; background:#0b0f1a; border:1px solid #1a2340; color:var(--text);
      border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
    .btn:hover{box-shadow:var(--ring); border-color:#3a63ff}
    .btn.primary{background:linear-gradient(90deg, var(--accent1), var(--accent2)); border:none; color:#fff}
    .btn.ghost{background:transparent; border-color:#26324E; color:#A4ADBD}

    /* Password bloc */
    .pass{display:flex; align-items:center; gap:10px; justify-content:space-between;
      border:1px solid var(--border); background:rgba(13,17,32,.6); border-radius:14px; padding:10px 12px}
    .pass b{font-size:18px; letter-spacing:1px}
    .hide{display:none}

    /* Loader (compact) */
    .spin{--d:18px; width:var(--d); height:var(--d); border-radius:50%;
      border:2px solid rgba(255,255,255,.14); border-right-color:rgba(47,227,255,.9); animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}

    @media (max-width:720px){
      .title{font-size:24px}
    }
  </style>
  <!-- qpdf-wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.js"></script>
</head>
<body>
  <main class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo" aria-hidden>âˆž</div>
        <span>Infinie & gratuit</span>
      </div>
      <div class="badge"><span class="dot"></span><span><strong>Protection PDF</strong> â€” 100% local</span></div>
    </header>

    <h1 class="title">PDF Locker â€” Mot de passe</h1>

    <section class="card">
      <div class="stack">
        <!-- Import -->
        <div class="drop" id="drop" role="button" tabindex="0" aria-label="DÃ©posez un PDF ou cliquez pour importer">
          <input id="file" type="file" accept="application/pdf" aria-label="Importer un PDF">
          <div class="hint">ðŸ“„ Importer un PDF<br><span class="meta">Glisser-dÃ©poser ou cliquer</span></div>
        </div>

        <!-- Fichier sÃ©lectionnÃ© -->
        <div class="row" id="fileRow" style="display:none">
          <div class="meta grow">
            <span class="name" id="fname">document.pdf</span>
            <span>â€¢</span>
            <span id="fsize">0 Mo</span>
          </div>
          <div id="statusPill" class="pill"><span class="dot ok"></span><span id="statusTxt">PrÃªt</span></div>
        </div>

        <!-- Actions -->
        <div class="row">
          <button class="btn primary" id="lockBtn">Crypter (local)</button>
          <button class="btn ghost" id="resetBtn">RÃ©initialiser</button>
          <div class="row" id="loader" style="margin-left:auto; display:none"><div class="spin" title="Chargement"></div></div>
        </div>

        <!-- Mot de passe -->
        <div class="pass hide" id="passBox">
          <span class="meta">Mot de passe</span>
          <b id="passTxt">â€”</b>
          <button class="btn" id="copyBtn" aria-label="Copier le mot de passe">Copier</button>
        </div>

        <!-- Note -->
        <div class="meta" style="justify-content:space-between">
          <span>Vos fichiers ne quittent jamais votre appareil.</span>
          <span id="tip" class="hide">TÃ©lÃ©chargement automatique activÃ©.</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);

    // UI refs
    const drop = $('#drop');
    const fileInput = $('#file');
    const fileRow = $('#fileRow');
    const fname = $('#fname');
    const fsize = $('#fsize');
    const statusTxt = $('#statusTxt');
    const statusPill = $('#statusPill');
    const loader = $('#loader');
    const lockBtn = $('#lockBtn');
    const resetBtn = $('#resetBtn');
    const passBox = $('#passBox');
    const passTxt = $('#passTxt');
    const copyBtn = $('#copyBtn');
    const tip = $('#tip');

    let currentFile = null;
    let qpdfInstance = null;
    const WASM_URL = 'https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.wasm';

    // --- Helper robuste pour dÃ©tecter un PDF (corrige le "double import" Safari/Edge)
    function isPdf(file){
      const nameOk = /\.pdf$/i.test(file?.name || '');
      const mime = (file?.type || '').toLowerCase();
      const mimeOk = mime === 'application/pdf' || mime === 'application/x-pdf' || mime.startsWith('application/pdf');
      return mimeOk || nameOk;
    }

    // Drag & Drop + clavier
    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.remove('is-drag'); }));

    drop.addEventListener('drop', e => {
      const f = e.dataTransfer?.files?.[0];
      if(f) onFile(f);
      // reset pour permettre de re-choisir le mÃªme fichier juste aprÃ¨s
      fileInput.value = '';
    });

    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fileInput.click(); } });

    fileInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(f) onFile(f);
      // reset pour que le mÃªme fichier retrigge 'change' immÃ©diatement
      e.target.value = '';
    });

    function onFile(file){
      if(!isPdf(file)){ alert('Merci dâ€™importer un fichier PDF.'); return; }
      currentFile = file;
      fname.textContent = file.name;
      fsize.textContent = (file.size/1024/1024).toFixed(2) + ' Mo';
      fileRow.style.display = 'flex';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('PDF chargÃ©', true);
    }

    resetBtn.addEventListener('click', ()=>{
      currentFile = null; fileInput.value = '';
      fileRow.style.display = 'none';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('PrÃªt', true);
    });

    copyBtn.addEventListener('click', async()=>{
      try{
        await navigator.clipboard.writeText(passTxt.textContent);
        copyBtn.textContent = 'CopiÃ©';
        setTimeout(()=> copyBtn.textContent='Copier', 1200);
      }catch{}
    });

    lockBtn.addEventListener('click', async()=>{
      if(!currentFile){ alert('Importe un PDF dâ€™abord.'); return; }
      if(!qpdfInstance){ await loadQpdf(); }

      // Feedback compact
      await busy('Analyse du PDFâ€¦', 400);
      await busy('Chiffrement AES-256â€¦', 700);

      const password = genPassword();
      try{
        const outBlob = await encryptPdfWithQpdf(currentFile, password);
        passTxt.textContent = password;
        passBox.classList.remove('hide');
        autoDownload(outBlob, 'secured_' + (currentFile.name.replace(/\.pdf$/i,'') || 'document') + '.pdf');
        tip.classList.remove('hide');
        setStatus('PDF protÃ©gÃ©', true);
      }catch(err){
        console.error(err);
        setStatus('Erreur', false);
        alert('Ã‰chec du chiffrement du PDF.');
      }
    });

    function setStatus(text, ok){
      statusTxt.textContent = text;
      const dot = statusPill.querySelector('.dot');
      if(dot) dot.className = 'dot ' + (ok ? 'ok' : 'err');
    }

    async function busy(text, ms){
      setStatus(text, true);
      loader.style.display = 'flex';
      await new Promise(r=> setTimeout(r, ms));
      loader.style.display = 'none';
    }

    async function loadQpdf(){
      setStatus('Chargement du moduleâ€¦', true);
      loader.style.display = 'flex';
      qpdfInstance = await window.Module({
        locateFile: () => WASM_URL,
        noInitialRun: true,
        preRun: [ m => { try{ m.FS.mkdir('/in'); m.FS.mkdir('/out'); }catch{} } ],
      });
      loader.style.display = 'none';
      setStatus('Module prÃªt', true);
    }

    async function encryptPdfWithQpdf(file, password){
      const buf = new Uint8Array(await file.arrayBuffer());
      const inPath = '/in/doc.pdf';
      const outPath = '/out/locked.pdf';
      qpdfInstance.FS.writeFile(inPath, buf);

      // qpdf: --encrypt <user> <owner> <keylen> -- in out
      const args = ['--encrypt', password, password, '256', '--', inPath, outPath];
      qpdfInstance.callMain(args);

      const out = qpdfInstance.FS.readFile(outPath);
      try{ qpdfInstance.FS.unlink(inPath); qpdfInstance.FS.unlink(outPath); }catch{}
      return new Blob([out], {type:'application/pdf'});
    }

    function genPassword(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s=''; for(let i=0;i<10;i++) s += chars[(Math.random()*chars.length)|0];
      return s.slice(0,4)+'-'+s.slice(4,8)+'-'+s.slice(8);
    }

    function autoDownload(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 800);
    }
  </script>
</body>
</html>
