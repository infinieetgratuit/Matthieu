<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infinie & gratuit — Calculatrice (noir & or, compact)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark"/>
<style>
/* ===== Tokens & base (IDENTIQUES) ===== */
:root{
  --bg:#0A0A0B; --text:#F2F3F6; --muted:#A5A9B3;
  --gold-1:#D8B45A; --gold-2:#F2C76C; --gold-3:#BF8E2C;
  --panel:#101218CC; --border:rgba(212,172,82,.22);
  --grid:#F2C76C22; --grid-strong:#F2C76C35;
  --radius:14px; --ring:0 0 0 2px rgba(212,172,82,.35);
  --speed-grid:60s; --speed-plane:26s;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg); overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
:focus-visible{outline:none; box-shadow:var(--ring)}
::selection{background:rgba(242,199,108,.25)}

/* ===== Background: quadrillage infini (IDENTIQUE) ===== */
.back{position:fixed; inset:0; pointer-events:none; z-index:-3}
.grid-ortho{
  position:absolute; inset:-20vmax;
  background:
    linear-gradient(var(--grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size:42px 42px,42px 42px; filter:saturate(120%) contrast(105%);
  animation:drift var(--speed-grid) linear infinite;
}
@keyframes drift{0%{background-position:0 0,0 0}100%{background-position:420px 280px,420px 280px}}
.grid-plane{
  position:absolute; left:-10vw; right:-10vw; bottom:-6vh; height:60vh;
  transform:perspective(900px) rotateX(68deg); transform-origin:50% 100%;
  background:
    linear-gradient(var(--grid-strong) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-strong) 1px, transparent 1px);
  background-size:60px 60px,60px 60px;
  mask:linear-gradient(to top,#000 30%,rgba(0,0,0,.85) 55%,rgba(0,0,0,0) 100%);
  animation:planeMove var(--speed-plane) linear infinite;
}
@keyframes planeMove{0%{background-position:0 0,0 0}100%{background-position:0 -600px,0 -600px}}
.halo{position:absolute; inset:0; background:
  radial-gradient(55% 40% at 50% 38%, rgba(242,199,108,.10), transparent 60%),
  radial-gradient(80% 70% at 50% 100%, rgba(191,142,44,.18), transparent 70%); mix-blend-mode:screen}
.vignette{position:absolute; inset:0; background:radial-gradient(120% 120% at 50% 20%, transparent 0 55%, rgba(0,0,0,.52) 80% 100%)}
@media (prefers-reduced-motion:reduce){.grid-ortho,.grid-plane{animation:none}}

/* ===== Header compact (IDENTIQUE) ===== */
header{
  position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 16px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.18)); backdrop-filter:blur(10px) saturate(160%);
  font-size:13px;
}
.brand{display:flex; align-items:center; gap:8px; font-weight:800}
.logo{
  display:grid; place-items:center; width:28px; height:28px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, var(--gold-2), var(--gold-3)); color:#111; font-weight:900;
  box-shadow:0 0 14px rgba(212,172,82,.34), inset 0 0 6px rgba(255,255,255,.18);
}
.badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#CDBB8A; background:rgba(16,18,24,.6)}

/* ===== Layout centré (même gabarit) ===== */
main{min-height:calc(100vh - 48px); display:grid; place-items:center; padding:20px 12px}
.wrap{width:100%; max-width:520px; margin:auto; display:grid; gap:10px}
.card{
  background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:0 0 36px rgba(0,0,0,.55), inset 0 0 .5px rgba(255,255,255,.06);
  padding:12px; position:relative; overflow:hidden;
}
.title{font-size:16px; font-weight:800; margin:0 0 6px}
.muted{color:var(--muted); font-size:12px}

/* ===== Boutons / champs (réemploie styles) ===== */
.btn{
  appearance:none; background:#0b0d12; border:1px solid var(--border); color:var(--text);
  border-radius:10px; padding:10px 12px; font-weight:750; cursor:pointer; font-size:14px;
  transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.btn:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
.btn.small{padding:8px 10px; font-size:13px}
.btn.primary{background:linear-gradient(90deg, var(--gold-2), var(--gold-3)); border:none; color:#111}

/* ===== Overlay chargement (IDENTIQUE) ===== */
.overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,6,8,.66); backdrop-filter:blur(6px); z-index:10}
.loader{
  width:96px; height:96px; position:relative; display:grid; place-items:center; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, rgba(242,199,108,.10), rgba(0,0,0,0));
  box-shadow:inset 0 0 0 1px rgba(212,172,82,.18), 0 0 26px rgba(212,172,82,.18);
}
.ring{position:absolute; inset:10px; border-radius:50%; border:3px solid rgba(242,199,108,.18); border-top-color:rgba(242,199,108,.9); animation:spin 1.1s linear infinite}
.ring2{inset:20px; border-top-color:rgba(242,199,108,.55); animation-duration:1.8s}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay p{margin-top:12px; text-align:center; color:#E9D9B3; font-weight:700; font-size:14px}

/* ===== Résultat + merci (IDENTIQUES) ===== */
#done{display:none}
.ok{display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%;
  background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; font-weight:900; margin-right:6px}
.passbox{display:flex; align-items:center; gap:8px; justify-content:space-between; border:1px solid var(--border);
  background:rgba(13,17,24,.6); border-radius:10px; padding:8px 10px; margin-top:8px}
.passbox b{font-size:16px; letter-spacing:1px}
.center{text-align:center}
.thanks{
  margin-top:12px; border-radius:12px; padding:10px;
  background:
    linear-gradient(#0d1118cc,#0d1118cc) padding-box,
    linear-gradient(120deg,var(--gold-2),var(--gold-3)) border-box;
  border:1px solid transparent;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 6px 28px rgba(212,172,82,.12), inset 0 0 .5px rgba(255,255,255,.06);
}
.thanks img{max-width:100%; width:220px; height:auto; image-rendering:auto; filter:drop-shadow(0 2px 12px rgba(212,172,82,.25))}

/* ===== Calculatrice: UI ===== */
.calc{
  display:grid; gap:10px;
}
.display{
  border:1px solid var(--border); background:rgba(13,17,24,.6);
  border-radius:10px; padding:12px; font-weight:800; font-size:22px;
  letter-spacing:.4px; text-align:right; min-height:54px;
  box-shadow:inset 0 0 .5px rgba(255,255,255,.06);
  word-break:break-all;
}
.keys{
  display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;
}
.key{
  border:1px solid var(--border); background:#0b0d12; color:var(--text);
  border-radius:10px; padding:14px 10px; font-weight:800; font-size:16px; cursor:pointer;
  transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease;
  user-select:none; text-align:center;
}
.key:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
.key:active{transform:translateY(1px)}
.key.op{color:#E9D9B3}
.key.gold{background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; border:none}
.key.span2{grid-column:span 2}
.hint{font-weight:700; text-align:center; font-size:14px}
.fade{transition:opacity .28s ease, transform .28s ease, visibility .28s ease}
.hidden{opacity:0; visibility:hidden; transform:translateY(6px)}
.show{opacity:1; visibility:visible; transform:none}
</style>
</head>
<body>
<!-- Background (identique) -->
<div class="back" aria-hidden="true">
  <div class="grid-ortho"></div>
  <div class="grid-plane"></div>
  <div class="halo"></div>
  <div class="vignette"></div>
</div>

<!-- Header (identique) -->
<header>
  <div class="brand"><div class="logo">∞</div><span>Infinie & gratuit</span></div>
  <div class="badge">Calculatrice — local</div>
</header>

<main>
  <!-- Écran calculatrice -->
  <section id="app" class="wrap fade show" aria-live="polite">
    <div class="card">
      <h2 class="title">Calculatrice</h2>
      <div class="muted">Tape une expression (clavier ou boutons), puis <strong>=</strong> pour valider.</div>

      <div class="calc" style="margin-top:8px">
        <div id="display" class="display" role="status" aria-live="polite">0</div>
        <div class="keys" aria-label="Clavier de la calculatrice">
          <button class="key op" data-k="C">C</button>
          <button class="key op" data-k="⌫">⌫</button>
          <button class="key op" data-k="(">(</button>
          <button class="key op" data-k=")">)</button>

          <button class="key" data-k="7">7</button>
          <button class="key" data-k="8">8</button>
          <button class="key" data-k="9">9</button>
          <button class="key op" data-k="÷">÷</button>

          <button class="key" data-k="4">4</button>
          <button class="key" data-k="5">5</button>
          <button class="key" data-k="6">6</button>
          <button class="key op" data-k="×">×</button>

          <button class="key" data-k="1">1</button>
          <button class="key" data-k="2">2</button>
          <button class="key" data-k="3">3</button>
          <button class="key op" data-k="-">−</button>

          <button class="key" data-k="0">0</button>
          <button class="key" data-k=".">.</button>
          <button class="key op" data-k="%">%</button>
          <button class="key op" data-k="+">+</button>

          <button class="key op" data-k="^">^</button>
          <button class="key op" data-k="±">±</button>
          <button class="key span2 gold" data-k="=">=</button>
        </div>
      </div>

      <div class="row" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px">
        <div class="muted" id="note">100% local — parenthèses, ^ puissance, %, + − × ÷, décimales.</div>
        <button class="btn small" id="copyBtn">Copier</button>
      </div>
    </div>
  </section>

  <!-- Overlay (identique, bref lors du “=”) -->
  <div class="overlay" id="overlay" aria-live="polite">
    <div>
      <div class="loader">
        <div class="ring"></div>
        <div class="ring ring2"></div>
      </div>
      <p id="overlayText">Calcul…</p>
    </div>
  </div>

  <!-- Résultat (identique, avec merci) -->
  <section id="done" class="wrap fade">
    <div class="card center">
      <div><span class="ok">✓</span><strong>Calcul terminé</strong></div>
      <div class="muted" style="margin-top:6px">Le résultat est prêt.</div>

      <div class="thanks" aria-label="Merci !">
        <img src="merci.png" alt="Notre personnage dit « merci »">
      </div>

      <div class="passbox">
        <span class="muted">Résultat</span>
        <b id="resultOut">—</b>
        <button class="btn small" id="copyResBtn">Copier</button>
      </div>

      <div class="muted" style="margin-top:6px" id="exprLine">—</div>

      <div style="margin-top:10px">
        <button class="btn small" id="againBtn">Nouvelle opération</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const wait = ms => new Promise(r=> setTimeout(r, ms));

/* ===== UI refs ===== */
const app = $('#app'), display = $('#display'), keys = $('.keys');
const overlay = $('#overlay'), overlayText = $('#overlayText');
const done = $('#done'), resultOut = $('#resultOut'), exprLine = $('#exprLine');
const copyBtn = $('#copyBtn'), copyResBtn = $('#copyResBtn'), againBtn = $('#againBtn');

let expr = "0";
let lastResult = null;

/* ===== Rendu display ===== */
function render(){
  display.textContent = expr || "0";
}

/* ===== Saisie via boutons ===== */
keys.addEventListener('click', e=>{
  const k = e.target?.dataset?.k;
  if(!k) return;
  onKey(k);
});

/* ===== Saisie clavier ===== */
window.addEventListener('keydown', e=>{
  const m = {
    '/':'÷','*':'×','-':'-','+':'+','%':'%','^':'^',
    'Enter':'=','=':'=','Backspace':'⌫','Delete':'C'
  };
  let k = null;
  if(/[0-9.()]/.test(e.key)) k = e.key;
  else if(m[e.key]!==undefined) k = m[e.key];
  if(k){ e.preventDefault(); onKey(k); }
});

/* ===== Logique touches ===== */
function onKey(k){
  if(k === 'C'){ expr = "0"; render(); return; }
  if(k === '⌫'){
    expr = (expr.length>1) ? expr.slice(0,-1) : "0";
    render(); return;
  }
  if(k === '±'){
    // change le signe du nombre courant (fin d'expression)
    const m = expr.match(/(-?\d*\.?\d+)(?!.*-?\d*\.?\d+)/);
    if(m){
      const start = m.index, end = start + m[0].length;
      const val = parseFloat(m[0]) * -1;
      expr = expr.slice(0,start) + String(val) + expr.slice(end);
    }else{
      expr = (expr.startsWith('-')? expr.slice(1) : '-'+expr);
    }
    render(); return;
  }
  if(k === '='){ compute(); return; }

  // map opérateurs visuels vers internes
  const mapOps = {'÷':'/','×':'*','−':'-'}; // garde '-' si jamais
  const v = mapOps[k] || k;

  if(expr==="0" && /[0-9.]/.test(v)){ expr = v; render(); return; }
  if(expr==="0" && /[+\-*/^%)]/.test(v)){ expr = "0"+v; render(); return; }

  // éviter deux opérateurs à la suite (sauf parenthèses)
  if(/[+\-*/^%]$/.test(expr) && /[+\/*^%]/.test(v)) { expr = expr.slice(0,-1) + v; render(); return; }

  expr += v;
  render();
}

/* ===== Parser & évaluation sûrs (Shunting-yard + RPN) ===== */
function tokenize(s){
  const out=[]; let i=0;
  while(i<s.length){
    const c = s[i];
    if(c===' ') { i++; continue; }
    if('()+-*/^%'.includes(c)){ out.push({t:'op',v:c}); i++; continue; }
    if(/\d|\./.test(c)){
      let j=i; while(j<s.length && /[\d.]/.test(s[j])) j++;
      out.push({t:'num', v:s.slice(i,j)}); i=j; continue;
    }
    // caracteres unicode éventuels déjà mappés avant
    i++; // ignorer
  }
  // fusion du signe unaire: remplace (op|start) - num  -> num négatif
  const merged=[];
  for(let k=0;k<out.length;k++){
    const tok = out[k];
    if(tok.t==='op' && tok.v==='-' && (k===0 || (out[k-1].t==='op' && out[k-1].v!==')')) && out[k+1]?.t==='num'){
      merged.push({t:'num', v:String(-parseFloat(out[k+1].v))});
      k++; continue;
    }
    merged.push(tok);
  }
  return merged;
}
function toRPN(tokens){
  const out=[], st=[];
  const prec={ '^':4, '*':3, '/':3, '%':3, '+':2, '-':2 };
  const rightAssoc = { '^':true };
  for(const t of tokens){
    if(t.t==='num'){ out.push(t); continue; }
    if(t.t==='op'){
      if(t.v==='('){ st.push(t); continue; }
      if(t.v===')'){
        while(st.length && st[st.length-1].v!=='(') out.push(st.pop());
        st.pop(); continue;
      }
      // opérateur
      while(st.length){
        const top=st[st.length-1];
        if(top.v==='(') break;
        if( (rightAssoc[t.v] && prec[t.v] < prec[top.v]) || (!rightAssoc[t.v] && prec[t.v] <= prec[top.v]) ){
          out.push(st.pop()); continue;
        }
        break;
      }
      st.push(t);
    }
  }
  while(st.length) out.push(st.pop());
  return out;
}
function evalRPN(rpn){
  const st=[];
  for(const t of rpn){
    if(t.t==='num'){ st.push(parseFloat(t.v)); continue; }
    const b=st.pop(), a=st.pop();
    let v=0;
    switch(t.v){
      case '+': v=a+b; break;
      case '-': v=a-b; break;
      case '*': v=a*b; break;
      case '/': v=b===0? NaN : a/b; break;
      case '%': v=a%b; break;
      case '^': v=Math.pow(a,b); break;
      default: v=NaN;
    }
    st.push(v);
  }
  return st.pop();
}

/* ===== Calcul & écrans ===== */
async function compute(){
  // petite overlay pour cohérence DA (≈ 700–1100ms)
  app.classList.add('hidden'); await wait(260);
  overlay.style.display='grid'; overlayText.textContent='Calcul…';
  const input = expr.replace(/÷/g,'/').replace(/×/g,'*');
  let value = NaN;
  try{
    const rpn = toRPN(tokenize(input));
    value = evalRPN(rpn);
  }catch(e){ value = NaN; }
  await wait(850);
  overlay.style.display='none';

  if(!isFinite(value) || Number.isNaN(value)){
    alert('Expression invalide.');
    app.classList.remove('hidden'); return;
  }

  lastResult = value;
  resultOut.textContent = formatNumber(value);
  exprLine.textContent = `Expression : ${expr}`;
  done.style.display='grid';
  done.classList.add('show');
}

function formatNumber(n){
  const s = Math.abs(n) < 1e12 ? n.toString() : n.toExponential(6);
  // limite à 12 décimales propres
  const f = Number.parseFloat(s);
  return Number.isFinite(f) ? (+f.toFixed(12)).toString().replace(/\.?0+$/,'') : s;
}

/* ===== Actions ===== */
$('#againBtn').addEventListener('click', ()=>{
  done.style.display='none';
  expr = String(lastResult ?? "0");
  render();
  app.classList.remove('hidden'); app.classList.add('show');
});

copyBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(display.textContent.trim()); toast(); }catch{}
});
copyResBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(resultOut.textContent.trim()); toast(); }catch{}
});
function toast(){
  overlayText.textContent='Copié !';
  overlay.style.display='grid';
  setTimeout(()=> overlay.style.display='none', 650);
}

// init
render();
</script>
</body>
</html>
