<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infinie & gratuit ‚Äî Compresseur d‚Äôimage (noir & or, compact)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark"/>
<style>
  :root{
    --bg:#0A0A0B; --text:#F2F3F6; --muted:#A5A9B3;
    --gold-1:#D8B45A; --gold-2:#F2C76C; --gold-3:#BF8E2C;
    --panel:#101218CC; --border:rgba(212,172,82,.22);
    --grid:#F2C76C22; --grid-strong:#F2C76C35;
    --radius:14px; --ring:0 0 0 2px rgba(212,172,82,.35);
    --speed-grid:60s; --speed-plane:26s;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  :focus-visible{outline:none; box-shadow:var(--ring)}
  ::selection{background:rgba(242,199,108,.25)}

  /* ===== Background: quadrillage infini ===== */
  .back{position:fixed; inset:0; pointer-events:none; z-index:-3}
  .grid-ortho{
    position:absolute; inset:-20vmax;
    background:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size:42px 42px,42px 42px; filter:saturate(120%) contrast(105%);
    animation:drift var(--speed-grid) linear infinite;
  }
  @keyframes drift{0%{background-position:0 0,0 0}100%{background-position:420px 280px,420px 280px}}
  .grid-plane{
    position:absolute; left:-10vw; right:-10vw; bottom:-6vh; height:60vh;
    transform:perspective(900px) rotateX(68deg); transform-origin:50% 100%;
    background:
      linear-gradient(var(--grid-strong) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-strong) 1px, transparent 1px);
    background-size:60px 60px,60px 60px;
    mask:linear-gradient(to top,#000 30%,rgba(0,0,0,.85) 55%,rgba(0,0,0,0) 100%);
    animation:planeMove var(--speed-plane) linear infinite;
  }
  @keyframes planeMove{0%{background-position:0 0,0 0}100%{background-position:0 -600px,0 -600px}}
  .halo{position:absolute; inset:0; background:
      radial-gradient(55% 40% at 50% 38%, rgba(242,199,108,.10), transparent 60%),
      radial-gradient(80% 70% at 50% 100%, rgba(191,142,44,.18), transparent 70%); mix-blend-mode:screen}
  .vignette{position:absolute; inset:0; background:radial-gradient(120% 120% at 50% 20%, transparent 0 55%, rgba(0,0,0,.52) 80% 100%)}
  @media (prefers-reduced-motion:reduce){.grid-ortho,.grid-plane{animation:none}}

  /* ===== Header compact ===== */
  header{
    position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 16px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.18)); backdrop-filter:blur(10px) saturate(160%);
    font-size:13px;
  }
  .brand{display:flex; align-items:center; gap:8px; font-weight:800}
  .logo{
    display:grid; place-items:center; width:28px; height:28px; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, var(--gold-2), var(--gold-3)); color:#111; font-weight:900;
    box-shadow:0 0 14px rgba(212,172,82,.34), inset 0 0 6px rgba(255,255,255,.18);
  }
  .badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#CDBB8A; background:rgba(16,18,24,.6)}

  /* ===== Layout centr√© (m√™me gabarit pour import ET r√©sultat) ===== */
  main{min-height:calc(100vh - 48px); display:grid; place-items:center; padding:20px 12px}
  .wrap{width:100%; max-width:520px; margin:auto; display:grid; gap:10px}
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:0 0 36px rgba(0,0,0,.55), inset 0 0 .5px rgba(255,255,255,.06);
    padding:12px; position:relative; overflow:hidden;
  }
  .title{font-size:16px; font-weight:800; margin:0 0 6px}
  .muted{color:var(--muted); font-size:12px}

  .drop{
    position:relative; display:grid; place-items:center; height:140px; border-radius:10px;
    border:1.5px dashed rgba(212,172,82,.30); background:#0b0d12; color:#E9D9B3; cursor:pointer;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease; margin-top:4px;
  }
  .drop input{position:absolute; inset:0; opacity:0; pointer-events:none;}
  .drop:hover{border-color:rgba(242,199,108,.55)}
  .drop.is-drag{transform:scale(1.01); box-shadow:var(--ring); border-color:rgba(242,199,108,.75)}
  .hint{font-weight:700; text-align:center; font-size:14px}
  .row{display:flex; align-items:center; gap:8px; justify-content:space-between; margin-top:8px}
  .filemeta{display:flex; gap:8px; align-items:center; font-size:12px}
  .name{font-weight:700}
  .btn{
    appearance:none; background:#0b0d12; border:1px solid var(--border); color:var(--text);
    border-radius:10px; padding:10px 12px; font-weight:750; cursor:pointer; font-size:14px;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .btn:hover{box-shadow:var(--ring); border-color:rgba(242,199,108,.6)}
  .btn.primary{background:linear-gradient(90deg, var(--gold-2), var(--gold-3)); border:none; color:#111}
  .btn.small{padding:8px 10px; font-size:13px}

  /* ===== Overlay chargement (5‚Äì7s) ===== */
  .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,6,8,.66); backdrop-filter:blur(6px); z-index:10}
  .loader{
    width:96px; height:96px; position:relative; display:grid; place-items:center; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(242,199,108,.10), rgba(0,0,0,0));
    box-shadow:inset 0 0 0 1px rgba(212,172,82,.18), 0 0 26px rgba(212,172,82,.18);
  }
  .ring{position:absolute; inset:10px; border-radius:50%; border:3px solid rgba(242,199,108,.18); border-top-color:rgba(242,199,108,.9); animation:spin 1.1s linear infinite}
  .ring2{inset:20px; border-top-color:rgba(242,199,108,.55); animation-duration:1.8s}
  @keyframes spin{to{transform:rotate(360deg)}}
  .overlay p{margin-top:12px; text-align:center; color:#E9D9B3; font-weight:700; font-size:14px}

  /* ===== Cadre r√©sultat (m√™me gabarit .wrap et .card) ===== */
  #done{display:none}
  .ok{display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%;
      background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; font-weight:900; margin-right:6px}
  .passbox{display:flex; align-items:center; gap:8px; justify-content:space-between; border:1px solid var(--border);
           background:rgba(13,17,24,.6); border-radius:10px; padding:8px 10px; margin-top:8px}
  .passbox b{font-size:16px; letter-spacing:1px}
  .center{text-align:center}

  /* ===== Cadre "merci" ===== */
  .thanks{
    margin-top:12px;
    border-radius:12px;
    padding:10px;
    background:
      linear-gradient(#0d1118cc,#0d1118cc) padding-box,
      linear-gradient(120deg,var(--gold-2),var(--gold-3)) border-box;
    border:1px solid transparent;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 6px 28px rgba(212,172,82,.12), inset 0 0 .5px rgba(255,255,255,.06);
  }
  .thanks img{
    max-width:100%;
    width:220px; height:auto;
    image-rendering:auto;
    filter: drop-shadow(0 2px 12px rgba(212,172,82,.25));
  }

  /* ===== Animations ===== */
  .fade{transition:opacity .28s ease, transform .28s ease, visibility .28s ease}
  .hidden{opacity:0; visibility:hidden; transform:translateY(6px)}
  .show{opacity:1; visibility:visible; transform:none}
</style>
</head>
<body>
  <!-- Background -->
  <div class="back" aria-hidden="true">
    <div class="grid-ortho"></div>
    <div class="grid-plane"></div>
    <div class="halo"></div>
    <div class="vignette"></div>
  </div>

  <header>
    <div class="brand"><div class="logo">‚àû</div><span>Infinie & gratuit</span></div>
    <div class="badge">Compresseur d‚Äôimage ‚Äî local</div>
  </header>

  <main>
    <!-- Bloc import (centr√©) -->
    <section id="app" class="wrap fade show" aria-live="polite">
      <div class="card">
        <h2 class="title">Compresser une image</h2>
        <div class="muted">Glisse ton fichier ci-dessous, puis clique sur <strong>Compresser</strong>.</div>

        <div id="drop" class="drop" role="button" tabindex="0" aria-label="D√©poser/Importer une image">
          <input id="file" type="file" accept="image/*" aria-label="Importer une image">
          <div class="hint">üñºÔ∏è D√©poser / Importer une image</div>
        </div>

        <div class="row" id="meta" style="display:none">
          <div class="filemeta">
            <span class="name" id="fname">image</span><span>‚Ä¢</span><span id="fsize">0 Mo</span>
          </div>
          <div style="display:flex; gap:6px">
            <button class="btn small" id="resetBtn">R√©init.</button>
            <button class="btn primary" id="compressBtn">Compresser</button>
          </div>
        </div>
        <div class="muted" id="note" style="margin-top:6px">
          100% local ‚Äî EXIF supprim√©s. Sortie en WebP, transparence conserv√©e.
        </div>
      </div>
    </section>

    <!-- Overlay (5‚Äì7 s) -->
    <div class="overlay" id="overlay" aria-live="polite">
      <div>
        <div class="loader">
          <div class="ring"></div>
          <div class="ring ring2"></div>
        </div>
        <p id="overlayText">Analyse de l‚Äôimage‚Ä¶</p>
      </div>
    </div>

    <!-- R√©sultat (centr√©, m√™me largeur que l‚Äôimport) -->
    <section id="done" class="wrap fade">
      <div class="card center">
        <div><span class="ok">‚úì</span><strong>Image compress√©e avec succ√®s</strong></div>
        <div class="muted" style="margin-top:6px">Le fichier compress√© est pr√™t.</div>

        <!-- Merci -->
        <div class="thanks" aria-label="Merci !">
          <img src="merci.png" alt="Notre personnage dit ¬´ merci ¬ª">
        </div>

        <!-- Infos & action (r√©utilise le style .passbox) -->
        <div class="passbox">
          <span class="muted" id="statsLabel">Taille compress√©e</span>
          <b id="sizeOut">‚Äî</b>
          <a class="btn small" id="downloadBtn" href="#" download>T√©l√©charger</a>
        </div>

        <div class="muted" style="margin-top:6px" id="gainLine">‚Äî</div>

        <div style="margin-top:10px">
          <button class="btn small" id="againBtn">Nouvelle op√©ration</button>
        </div>
      </div>
    </section>
  </main>

<script>
/* ===== Shortcuts ===== */
const $ = (s, r=document)=> r.querySelector(s);
const wait = ms => new Promise(r=> setTimeout(r, ms));

/* ===== UI refs ===== */
const app = $('#app'), drop = $('#drop'), fileInput = $('#file');
const meta = $('#meta'), fname = $('#fname'), fsize = $('#fsize');
const compressBtn = $('#compressBtn'), resetBtn = $('#resetBtn');
const overlay = $('#overlay'), overlayText = $('#overlayText');
const done = $('#done'), sizeOut = $('#sizeOut'), gainLine = $('#gainLine'), downloadBtn = $('#downloadBtn'), againBtn = $('#againBtn');

let currentFile = null;
let outURL = null, outBlob = null, origSize = 0;

/* ===== Import: un seul choix, pas de re-s√©lection forc√©e ===== */
function isImage(file){
  const mime = (file?.type||'').toLowerCase();
  if(mime.startsWith('image/')) return true;
  const name = file?.name?.toLowerCase() || '';
  return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(name);
}
const prevent = e=>{ e.preventDefault(); e.stopPropagation(); };
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.add('is-drag'); }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.remove('is-drag'); }));

// Anti double-ouverture
let openingDialog = false;
drop.addEventListener('click', ()=>{
  if(openingDialog) return;
  openingDialog = true;
  fileInput.click();
  setTimeout(()=> openingDialog=false, 400);
});
drop.addEventListener('keydown', e=>{
  if(e.key==='Enter'||e.key===' '){
    e.preventDefault();
    if(openingDialog) return;
    openingDialog = true;
    fileInput.click();
    setTimeout(()=> openingDialog=false, 400);
  }
});
drop.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0];
  if(f) onFile(f);
});
fileInput.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(f) onFile(f);
});

function onFile(file){
  if(!isImage(file)){ alert('Merci d‚Äôimporter une image.'); return; }
  currentFile = file;
  origSize = file.size||0;
  fname.textContent = file.name || 'image';
  fsize.textContent = (origSize/1024/1024).toFixed(2) + ' Mo';
  meta.style.display = 'flex';
}

/* ===== Actions ===== */
resetBtn.addEventListener('click', resetAll);
againBtn.addEventListener('click', resetAll);
function resetAll(){
  currentFile = null;
  if(outURL){ URL.revokeObjectURL(outURL); outURL=null; }
  outBlob=null; origSize=0;
  fileInput.value = '';            // reset uniquement au reset
  meta.style.display = 'none';
  done.style.display = 'none';
  app.classList.remove('hidden'); app.classList.add('show');
  overlay.style.display = 'none';
}

/* ===== Compression locale (WebP, alpha ok) ===== */
compressBtn.addEventListener('click', async ()=>{
  if(!currentFile){ alert('Importe une image d‚Äôabord.'); return; }

  // Masque l‚Äôapp, affiche overlay
  app.classList.remove('show'); app.classList.add('hidden');
  await wait(260);
  overlay.style.display='grid';

  // Progression lisible (dur√©e min ~5.5s)
  const timeline = (async()=>{
    overlayText.textContent='Analyse de l‚Äôimage‚Ä¶'; await wait(1500);
    overlayText.textContent='Compression WebP‚Ä¶';    await wait(2500);
    overlayText.textContent='Finalisation‚Ä¶';        await wait(1500);
  })();

  try{
    const blobPromise = compressImageToWebP(currentFile, 0.82); // qualit√© par d√©faut
    await Promise.all([blobPromise, timeline]);
    outBlob = await blobPromise;

    if(outURL){ URL.revokeObjectURL(outURL); }
    outURL = URL.createObjectURL(outBlob);

    const outName = makeOutName(currentFile.name || 'image');
    downloadBtn.href = outURL;
    downloadBtn.download = outName;

    const outSize = outBlob.size||0;
    sizeOut.textContent = (outSize/1024/1024).toFixed(2)+' Mo';
    const gain = (1 - (outSize / Math.max(1, origSize))) * 100;
    gainLine.textContent = `Originale : ${(origSize/1024/1024).toFixed(2)} Mo ‚Ä¢ Gain : ${gain>=0? '‚àí'+gain.toFixed(1)+'%': '+'+Math.abs(gain).toFixed(1)+'%'}`;

    // Fin ‚Üí on cache overlay et on montre le cadre r√©sultat
    overlay.style.display='none';
    done.style.display='grid';
    done.classList.add('show');
  }catch(err){
    console.error(err);
    overlay.style.display='none';
    alert('√âchec de la compression. R√©essaie avec un autre fichier.');
    app.classList.remove('hidden'); app.classList.add('show');
  }
});

/* ===== Core ===== */
async function compressImageToWebP(file, quality=0.82){
  const dataURL = await fileToDataURL(file);
  const {img,w,h,hasAlpha} = await loadImage(dataURL);
  // Cr√©e canvas
  const canvas = ('OffscreenCanvas' in window) ? new OffscreenCanvas(w,h) : Object.assign(document.createElement('canvas'),{width:w,height:h});
  if(!(canvas instanceof OffscreenCanvas)){ canvas.width=w; canvas.height=h; }
  const ctx = canvas.getContext('2d');
  if(!hasAlpha){ ctx.fillStyle = '#0B0B0D'; ctx.fillRect(0,0,w,h); } // s√©curit√© pour vieux JPEG
  ctx.drawImage(img, 0, 0, w, h);
  // toBlob
  const blob = await canvasToBlob(canvas, 'image/webp', quality);
  if(!blob) throw new Error('Impossible de cr√©er le WebP');
  return blob;
}

function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function loadImage(src){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>{
      // D√©termine si alpha possible via heuristique (PNG/WebP/GIF/SVG -> alpha probable)
      const alphaLikely = /image\/(png|webp|gif|svg)/i.test(src.split(';')[0]) || true; // on pr√©serve toujours
      res({img,w:img.naturalWidth,h:img.naturalHeight,hasAlpha:alphaLikely});
    };
    img.onerror = rej;
    img.src = src;
  });
}
function canvasToBlob(canvas, type, quality){
  return new Promise((resolve)=>{
    if('convertToBlob' in canvas){
      canvas.convertToBlob({type,quality}).then(resolve).catch(()=>resolve(null));
    }else if('toBlob' in canvas){
      canvas.toBlob(b=> resolve(b), type, quality);
    }else{
      try{
        const dataURL = canvas.toDataURL(type, quality);
        resolve(dataURLtoBlob(dataURL));
      }catch{ resolve(null); }
    }
  });
}
function dataURLtoBlob(dataURL){
  const [head,body] = dataURL.split(',');
  const mime = head.match(/:(.*?);/)[1];
  const bin = atob(body); const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8], {type:mime});
}
function makeOutName(original){
  const base = (original||'image').replace(/\.[^.]+$/,'');
  return `${base}_compressed.webp`;
}
</script>
</body>
</html>
