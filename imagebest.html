<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Infinie & gratuit ‚Äî LYRA-SR (Am√©lioration d‚Äôimage)</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0B0B0D; --panel:#0d1120; --text:#E6ECF7; --muted:#A4ADBD;
      --border:rgba(95,123,255,0.18); --accent1:#2FE3FF; --accent2:#1B4CFF;
      --ring:0 0 0 2px rgba(43,167,255,.35)
    }
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
      background:
        radial-gradient(1200px 600px at 8% 12%, rgba(43,167,255,0.12), transparent 60%),
        radial-gradient(1000px 800px at 82% 85%, rgba(27,76,255,0.10), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale
    }
    *,*:before,*:after{box-sizing:border-box}
    :focus-visible{outline:none; box-shadow:var(--ring)}
    ::selection{background:rgba(47,227,255,.25)}

    .wrap{max-width:980px; margin:0 auto; padding:24px 18px 80px}
    .top{display:flex; align-items:center; gap:10px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:999px; color:#fff; font-weight:800;
      background:radial-gradient(circle at 30% 30%, var(--accent1), var(--accent2));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .badge{margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      color:#9fb4ff; background:#0f1420; border:1px solid #1a2340}
    .badge .dot{width:8px; height:8px; border-radius:50%; background:linear-gradient(90deg, var(--accent1), var(--accent2))}
    .title{font-size:28px; line-height:1.15; margin:10px 0 16px; font-weight:800}

    /* Carte principale */
    .card{
      border:1px solid var(--border); border-radius:20px; padding:18px;
      background:
        linear-gradient(160deg, rgba(27,76,255,0.06), transparent),
        linear-gradient(180deg, rgba(47,227,255,0.05), transparent 40%),
        var(--panel);
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03)
    }
    .stack{display:flex; flex-direction:column; gap:12px}

    /* Zone d‚Äôimport */
    .drop{position:relative; display:grid; place-items:center; aspect-ratio:16/9; border-radius:16px;
      border:1.5px dashed #223054; background:#0a0f18; color:#93a6d3; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
    .drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .drop:hover{border-color:#3a63ff}
    .drop.is-drag{transform:scale(1.01); box-shadow:var(--ring); border-color:#3a63ff}
    .hint{text-align:center; font-weight:700}
    .hint small{display:block; font-weight:400; color:var(--muted)}

    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .meta{display:flex; align-items:center; gap:10px; color:#A4ADBD; font-size:12px}
    .name{font-weight:800; color:var(--text)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b0f1a; border:1px solid #1a2340; font-size:12px}
    .dot{width:8px; height:8px; border-radius:50%}
    .ok{background:linear-gradient(90deg, var(--accent1), var(--accent2))}
    .err{background:#9b2c2c}
    .tip{color:#9fb4ff}

    .btn{appearance:none; background:#0b0f1a; border:1px solid #1a2340; color:var(--text);
      border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
    .btn:hover{box-shadow:var(--ring); border-color:#3a63ff}
    .btn.primary{background:linear-gradient(90deg, var(--accent1), var(--accent2)); border:none; color:#fff}
    .btn.ghost{background:transparent; border-color:#26324E; color:#A4ADBD}

    .controls{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:720px){ .controls{grid-template-columns:1fr} }

    .field{border:1px solid var(--border); background:rgba(13,17,32,.6); border-radius:14px; padding:10px 12px}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .seg{display:flex; gap:6px; background:#0b0f1a; border:1px solid #1a2340; border-radius:10px; padding:4px}
    .seg button{flex:1; border:none; background:transparent; color:#A4ADBD; font-weight:700; padding:10px; border-radius:8px; cursor:pointer}
    .seg button.active{color:#fff; background:linear-gradient(90deg, rgba(47,227,255,.15), rgba(27,76,255,.15)); box-shadow:inset 0 0 0 1px #2b3c6f}

    .range{width:100%}
    .check{display:flex; align-items:center; gap:8px; font-size:14px; color:#c7d2ff}

    /* Loader IA */
    .progress{position:relative; height:10px; border-radius:999px; background:#0e1422; border:1px solid #1a2340; overflow:hidden}
    .bar{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--accent1), var(--accent2)); box-shadow:0 0 30px rgba(47,227,255,.45) inset}
    .aiLine{font-size:12px; color:#9fb4ff; display:flex; align-items:center; gap:8px}
    .spin{--d:16px; width:var(--d); height:var(--d); border-radius:50%;
      border:2px solid rgba(255,255,255,.14); border-right-color:rgba(47,227,255,.9); animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* Zone r√©sultat + slider avant/apr√®s */
    .compare{position:relative; width:100%; aspect-ratio:16/9; border-radius:16px; overflow:hidden; border:1px solid #1a2340; background:#0a0f18}
    .compare canvas{position:absolute; inset:0; width:100%; height:100%; image-rendering:auto}
    .afterMask{clip-path:inset(0 0 0 50%)}
    .handle{position:absolute; top:0; bottom:0; left:50%; width:2px; background:linear-gradient(180deg, var(--accent1), var(--accent2)); cursor:ew-resize}
    .handle:before{content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:36px; height:36px; border-radius:999px; border:1px solid #2b3c6f; background:#0b0f1a; box-shadow:0 8px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06)}
    .legend{display:flex; justify-content:space-between; font-size:12px; color:#9fb4ff; margin-top:8px}

    .footerNote{display:flex; justify-content:space-between; align-items:center; gap:10px; color:#A4ADBD; font-size:12px}
    .footerNote .ok{width:8px;height:8px;border-radius:50%}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo" aria-hidden>‚àû</div>
        <span>Infinie & gratuit</span>
      </div>
      <div class="badge"><span class="dot"></span><span><strong>LYRA-SR‚Ñ¢</strong> ‚Äî Am√©lioration IA (100% local)</span></div>
    </header>

    <h1 class="title">Am√©liorer la qualit√© d‚Äôune image ‚Äî <span class="tip">structure fa√ßon Revolut, design Infinie</span></h1>

    <section class="card">
      <div class="stack">
        <!-- Import -->
        <div class="drop" id="drop" role="button" tabindex="0" aria-label="D√©posez une image ou cliquez pour importer">
          <input id="file" type="file" accept="image/*" aria-label="Importer une image">
          <div class="hint">üñºÔ∏è D√©poser / Importer une image<br><small>PNG, JPG, WebP, AVIF‚Ä¶</small></div>
        </div>

        <!-- Fichier s√©lectionn√© -->
        <div class="row" id="fileRow" style="display:none">
          <div class="meta grow">
            <span class="name" id="fname">image.png</span>
            <span>‚Ä¢</span>
            <span id="fmeta">‚Äî</span>
          </div>
          <div id="statusPill" class="pill"><span class="dot ok"></span><span id="statusTxt">Pr√™t</span></div>
        </div>

        <!-- R√©glages -->
        <div class="controls">
          <div class="field">
            <label>Facteur d‚Äôagrandissement</label>
            <div class="seg" id="scaleSeg">
              <button data-scale="1" class="active">1√ó (nettet√©)</button>
              <button data-scale="2">2√ó</button>
              <button data-scale="4">4√ó</button>
            </div>
          </div>
          <div class="field">
            <label>Nettoyage & Nettet√©</label>
            <div class="row" style="gap:12px; flex-wrap:wrap">
              <label class="check"><input id="denoise" type="checkbox" checked/> D√©bruitage fin</label>
              <label class="check"><input id="sharpen" type="checkbox" checked/> Nettet√© adaptative</label>
              <label class="check"><input id="contrast" type="checkbox"/> Micro-contraste</label>
            </div>
          </div>
          <div class="field">
            <label>Force de nettet√©</label>
            <input id="amount" type="range" class="range" min="0" max="200" value="80">
          </div>
          <div class="field">
            <label>Qualit√© export (JPG/WebP)</label>
            <input id="quality" type="range" class="range" min="70" max="100" value="92">
          </div>
        </div>

        <!-- Actions -->
        <div class="row">
          <button class="btn primary" id="runBtn">Lancer LYRA-SR</button>
          <button class="btn ghost" id="resetBtn">R√©initialiser</button>
          <div class="row" id="loader" style="margin-left:auto; display:none; align-items:center; gap:10px">
            <div class="spin" title="Chargement"></div>
            <div class="aiLine"><strong>LYRA-SR</strong> pr√©pare la magie‚Ä¶</div>
          </div>
        </div>

        <!-- Progress -->
        <div id="progWrap" class="stack" style="display:none">
          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="aiLine"><span class="spin"></span><span id="stepTxt">Initialisation du moteur‚Ä¶</span></div>
        </div>

        <!-- R√©sultat (avant / apr√®s) -->
        <div id="result" style="display:none">
          <div class="compare" id="compare">
            <canvas id="before"></canvas>
            <canvas id="after" class="afterMask"></canvas>
            <div class="handle" id="handle" title="Glisser pour comparer"></div>
          </div>
          <div class="legend"><span>Avant</span><span>Apr√®s</span></div>

          <div class="row" style="margin-top:12px">
            <div class="meta grow" id="dims">‚Äî</div>
            <button class="btn" id="savePNG">Exporter en PNG</button>
            <button class="btn" id="saveJPG">Exporter en JPG</button>
            <button class="btn" id="saveWEBP">Exporter en WebP</button>
          </div>
        </div>

        <!-- L√©gende -->
        <div class="footerNote">
          <span><span class="ok" style="background:linear-gradient(90deg, var(--accent1), var(--accent2))"></span> Traitement local ‚Äî vos images ne quittent jamais votre appareil.</span>
          <span class="tip">Astuce : pour de tr√®s grandes images, commencez en 2√ó.</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);
    const drop = $('#drop'), fileInput = $('#file');
    const fileRow = $('#fileRow'), fname = $('#fname'), fmeta = $('#fmeta');
    const statusTxt = $('#statusTxt'), statusPill = $('#statusPill');
    const runBtn = $('#runBtn'), resetBtn = $('#resetBtn');
    const loader = $('#loader'), bar = $('#bar'), progWrap = $('#progWrap'), stepTxt = $('#stepTxt');
    const beforeC = $('#before'), afterC = $('#after'), result = $('#result');
    const handle = $('#handle'), compare = $('#compare'), dims = $('#dims');
    const scaleSeg = $('#scaleSeg'), denoise = $('#denoise'), sharpen = $('#sharpen'), contrast = $('#contrast');
    const amount = $('#amount'), quality = $('#quality');
    const savePNG = $('#savePNG'), saveJPG = $('#saveJPG'), saveWEBP = $('#saveWEBP');

    let currentImg = null, currentBitmap = null, outBitmap = null, scale = 1;

    // --- Drag & Drop
    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.remove('is-drag'); }));
    drop.addEventListener('drop', e => { const f = e.dataTransfer?.files?.[0]; if(f) onFile(f); fileInput.value=''; });
    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fileInput.click(); } });
    fileInput.addEventListener('change', e=>{ const f = e.target.files?.[0]; if(f) onFile(f); e.target.value=''; });

    // --- Scale segmented control
    scaleSeg.addEventListener('click', e=>{
      if(e.target.tagName!=='BUTTON') return;
      [...scaleSeg.children].forEach(b=> b.classList.remove('active'));
      e.target.classList.add('active');
      scale = +e.target.dataset.scale;
    });

    function setStatus(text, ok=true){
      statusTxt.textContent = text;
      const dot = statusPill.querySelector('.dot');
      if(dot) dot.className = 'dot ' + (ok ? 'ok' : 'err');
    }

    async function onFile(file){
      if(!/^image\//i.test(file.type||'')){ alert('Merci d‚Äôimporter une image (PNG, JPG, WebP, AVIF‚Ä¶).'); return; }
      resetUI(false);
      setStatus('Chargement de l‚Äôimage‚Ä¶', true);
      fname.textContent = file.name || 'image';
      const blob = file;
      currentImg = blob;
      currentBitmap = await createImageBitmap(blob).catch(()=>null);
      if(!currentBitmap){ setStatus('Erreur de d√©codage', false); return; }
      fmeta.textContent = currentBitmap.width + '√ó' + currentBitmap.height + ' px';
      fileRow.style.display = 'flex';
      setStatus('Pr√™t', true);

      // Fit preview canvases to container
      layoutCanvases();
      drawToCanvas(currentBitmap, beforeC);
      drawToCanvas(currentBitmap, afterC); // start identical
      result.style.display = 'block';
    }

    function resetUI(clearImage=true){
      if(clearImage){
        currentImg = null; currentBitmap = null; outBitmap = null;
        fileRow.style.display = 'none';
        result.style.display = 'none';
      }
      progWrap.style.display = 'none';
      loader.style.display = 'none';
      setStatus('Pr√™t', true);
      bar.style.width = '0%';
      stepTxt.textContent = 'Initialisation du moteur‚Ä¶';
    }
    resetBtn.addEventListener('click', ()=> resetUI(true));

    // --- Layout / compare handle
    function layoutCanvases(){
      const r = compare.getBoundingClientRect();
      [beforeC, afterC].forEach(c=>{ c.width = r.width; c.height = r.height; });
      setHandlePosition(0.5);
    }
    window.addEventListener('resize', ()=>{ if(!currentBitmap) return; layoutCanvases(); drawToCanvas(currentBitmap, beforeC); if(outBitmap) drawToCanvas(outBitmap, afterC); });

    function setHandlePosition(p){ // p in [0..1]
      const left = (p*100).toFixed(2)+'%';
      handle.style.left = left;
      afterC.style.clipPath = `inset(0 0 0 ${left})`;
    }
    (function initHandle(){
      let dragging=false;
      const move = e=>{
        if(!dragging) return;
        const rect = compare.getBoundingClientRect();
        const x = (e.touches? e.touches[0].clientX : e.clientX) - rect.left;
        const p = Math.max(0, Math.min(1, x/rect.width));
        setHandlePosition(p);
      };
      handle.addEventListener('mousedown', ()=> dragging=true);
      window.addEventListener('mouseup', ()=> dragging=false);
      window.addEventListener('mousemove', move);
      handle.addEventListener('touchstart', ()=> dragging=true, {passive:true});
      window.addEventListener('touchend', ()=> dragging=false, {passive:true});
      window.addEventListener('touchmove', move, {passive:false});
    })();

    // --- Core processing (LYRA-SR pipeline)
    runBtn.addEventListener('click', async()=>{
      if(!currentBitmap){ alert('Importe une image d‚Äôabord.'); return; }
      loader.style.display = 'flex';
      progWrap.style.display = 'block';
      bar.style.width = '0%';

      try{
        await step('Analyse & pr√©paration', 10, 300);
        const maxOut = 48e6; // ~48 Mpix s√©curit√©
        let targetW = Math.round(currentBitmap.width * (scale||1));
        let targetH = Math.round(currentBitmap.height * (scale||1));
        if(targetW*targetH > maxOut){
          const f = Math.sqrt(maxOut/(targetW*targetH));
          targetW = Math.max(1, Math.floor(targetW*f));
          targetH = Math.max(1, Math.floor(targetH*f));
        }

        await step('Upscale haute-qualit√©', 55, 500);
        const up = await upscaleHQ(currentBitmap, targetW, targetH, progress=> bar.style.width = (10 + 35*progress).toFixed(1)+'%');

        let imgData = readImageData(up);
        if(denoise.checked){
          await step('D√©bruitage fin', 65, 250);
          imgData = median3x3(imgData);
        }
        if(sharpen.checked){
          await step('Nettet√© adaptative', 78, 350);
          imgData = unsharp(imgData, (amount.value|0)/100, 1.6);
        }
        if(contrast.checked){
          await step('Micro-contraste', 88, 250);
          imgData = localContrast(imgData, 0.06);
        }
        await step('Finalisation', 96, 200);

        const out = new OffscreenCanvas(imgData.width, imgData.height);
        const octx = out.getContext('2d', {alpha:false});
        octx.putImageData(imgData, 0, 0);
        outBitmap = await out.transferToImageBitmap();

        // Affichage
        drawToCanvas(currentBitmap, beforeC);
        drawToCanvas(outBitmap, afterC);
        setHandlePosition(0.5);
        dims.textContent = `R√©solution: ${currentBitmap.width}√ó${currentBitmap.height} ‚Üí ${imgData.width}√ó${imgData.height}`;
        bar.style.width = '100%';
        stepTxt.textContent = 'LYRA-SR a termin√© ‚ú®';
        loader.style.display = 'none';
      }catch(err){
        console.error(err);
        setStatus('Erreur de traitement', false);
        loader.style.display = 'none';
        alert('Une erreur est survenue pendant le traitement.');
      }
    });

    async function step(txt, pct, sleep=250){
      stepTxt.textContent = `LYRA-SR ‚Äî ${txt}‚Ä¶`;
      bar.style.width = pct + '%';
      await new Promise(r=> setTimeout(r, sleep));
    }

    // --- Helper dessin vers canvas d‚Äôaper√ßu (fit contain)
    function drawToCanvas(bitmap, canvas){
      const ctx = canvas.getContext('2d', {alpha:false});
      const {width: cw, height: ch} = canvas;
      ctx.fillStyle = '#0a0f18'; ctx.fillRect(0,0,cw,ch);
      const iw = bitmap.width, ih = bitmap.height;
      const scale = Math.min(cw/iw, ch/ih);
      const w = Math.max(1, Math.floor(iw*scale)), h = Math.max(1, Math.floor(ih*scale));
      const x = (cw - w) >> 1, y = (ch - h) >> 1;
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(bitmap, x, y, w, h);
    }

    function readImageData(bitmap){
      // rendre sur canvas temporaire pour acc√©der aux pixels
      const can = new OffscreenCanvas(bitmap.width, bitmap.height);
      const c = can.getContext('2d', {alpha:false});
      c.drawImage(bitmap, 0, 0);
      return c.getImageData(0, 0, can.width, can.height);
    }

    // --- Upscale haute qualit√© (multi-√©tapes + smoothing √©lev√©)
    async function upscaleHQ(bitmap, tw, th, onp){
      const steps = Math.max(1, Math.ceil(Math.log2(Math.max(tw/bitmap.width, th/bitmap.height))));
      let src = bitmap;
      for(let i=1;i<=steps;i++){
        const f = Math.pow(2, i)/Math.pow(2, steps); // progression
        const w = Math.round(lerp(bitmap.width, tw, i/steps));
        const h = Math.round(lerp(bitmap.height, th, i/steps));
        const can = new OffscreenCanvas(w, h);
        const ctx = can.getContext('2d', {alpha:false});
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(src, 0, 0, w, h);
        src = await can.convertToBlob({type:'image/png'})
          .then(b=> createImageBitmap(b));
        onp && onp(i/steps);
        await new Promise(r=> setTimeout(r, 0)); // laisser souffler l‚ÄôUI
      }
      return src;
    }
    function lerp(a,b,t){ return a + (b-a)*t; }

    // --- Filtres: median, unsharp, local contrast
    function median3x3(img){
      const {data, width, height} = img;
      const out = new Uint8ClampedArray(data.length);
      const get = (x,y,c)=>{
        x = Math.max(0, Math.min(width-1, x));
        y = Math.max(0, Math.min(height-1, y));
        return data[(y*width + x)*4 + c];
      };
      const neigh = new Array(9);
      for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
          for(let c=0;c<3;c++){
            let k=0;
            for(let j=-1;j<=1;j++) for(let i=-1;i<=1;i++) neigh[k++] = get(x+i,y+j,c);
            neigh.sort((a,b)=>a-b);
            out[(y*width + x)*4 + c] = neigh[4];
          }
          out[(y*width + x)*4 + 3] = data[(y*width + x)*4 + 3];
        }
      }
      return new ImageData(out, width, height);
    }

    function unsharp(img, amount=0.8, radius=1.6){
      const {data, width, height} = img;
      // blur rapide via box blur s√©par√© (3 passes)
      const blurred = blurSeparable(data, width, height, radius);
      const out = new Uint8ClampedArray(data.length);
      for(let i=0;i<data.length;i+=4){
        const r = clamp(data[i]   + amount*(data[i]   - blurred[i]));
        const g = clamp(data[i+1] + amount*(data[i+1] - blurred[i+1]));
        const b = clamp(data[i+2] + amount*(data[i+2] - blurred[i+2]));
        out[i]=r; out[i+1]=g; out[i+2]=b; out[i+3]=data[i+3];
      }
      return new ImageData(out, width, height);
    }

    function localContrast(img, strength=0.06){
      // l√©ger rehaussement de micro-contraste en Y‚Äô (luma)
      const {data, width, height} = img;
      const blurred = blurSeparable(data, width, height, 8);
      const out = new Uint8ClampedArray(data.length);
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const br=blurred[i], bg=blurred[i+1], bb=blurred[i+2];
        const y  = 0.299*r + 0.587*g + 0.114*b;
        const yb = 0.299*br + 0.587*bg + 0.114*bb;
        const ny = clamp(y + (y - yb)* (strength*255));
        const ratio = (ny+1e-3)/(y+1e-3);
        out[i] = clamp(r*ratio); out[i+1] = clamp(g*ratio); out[i+2] = clamp(b*ratio); out[i+3] = data[i+3];
      }
      return new ImageData(out, width, height);
    }

    function blurSeparable(src, w, h, radius){
      // box blur triple pour approx gaussienne
      const r = Math.max(1, Math.floor(radius));
      const tmp = new Uint8ClampedArray(src.length);
      const out = new Uint8ClampedArray(src.length);
      // horizontal
      for(let y=0;y<h;y++){
        for(let c=0;c<3;c++){
          let sum=0;
          for(let x=-r;x<=r;x++){
            const ix = Math.max(0, Math.min(w-1, x));
            sum += src[(y*w + ix)*4 + c];
          }
          for(let x=0;x<w;x++){
            const i1 = Math.max(0, x-r-1), i2 = Math.min(w-1, x+r);
            if(x>0){ sum += src[(y*w + i2)*4 + c] - src[(y*w + i1)*4 + c]; }
            tmp[(y*w + x)*4 + c] = sum/(2*r+1);
          }
        }
        tmp[(y*w)*4 + 3] = 255; // alpha maintenu plus tard
      }
      // vertical
      for(let x=0;x<w;x++){
        for(let c=0;c<3;c++){
          let sum=0;
          for(let y2=-r;y2<=r;y2++){
            const iy = Math.max(0, Math.min(h-1, y2));
            sum += tmp[(iy*w + x)*4 + c];
          }
          for(let y=0;y<h;y++){
            const i1 = Math.max(0, y-r-1), i2 = Math.min(h-1, y+r);
            if(y>0){ sum += tmp[(i2*w + x)*4 + c] - tmp[(i1*w + x)*4 + c]; }
            out[(y*w + x)*4 + c] = sum/(2*r+1);
          }
        }
      }
      for(let i=0;i<src.length;i+=4) out[i+3] = src[i+3];
      return out;
    }

    function clamp(v){ return v<0?0: v>255?255: v|0; }

    // --- Exports
    async function exportFrom(bitmap, type='image/png', quality=0.92){
      const can = new OffscreenCanvas(bitmap.width, bitmap.height);
      const ctx = can.getContext('2d', {alpha:false});
      ctx.drawImage(bitmap, 0, 0);
      let blob;
      if(type==='image/jpeg' || type==='image/webp'){
        blob = await can.convertToBlob({type, quality: quality/100});
      }else{
        blob = await can.convertToBlob({type});
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ext = type==='image/png'?'png': type==='image/webp'?'webp':'jpg';
      const base = (fname.textContent || 'image').replace(/\.[a-z0-9]+$/i,'');
      a.href = url; a.download = `${base}_lyra.${ext}`; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1200);
    }
    savePNG.addEventListener('click', ()=> outBitmap && exportFrom(outBitmap,'image/png', +quality.value));
    saveJPG.addEventListener('click', ()=> outBitmap && exportFrom(outBitmap,'image/jpeg', +quality.value));
    saveWEBP.addEventListener('click',()=> outBitmap && exportFrom(outBitmap,'image/webp', +quality.value));

    // Accessibilit√©: Enter lance
    document.addEventListener('keydown', e=>{
      if(e.key==='Enter' && document.activeElement!==fileInput) runBtn.click();
    });
  </script>
</body>
</html>
