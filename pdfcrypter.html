<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Infinie & gratuit â€” PDF Locker (mot de passe)</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ========= THEME : Premium sombre + vert lumineux (mood ChatGPT) ========= */
    :root{
      --bg:#0A0B0A;
      --panel:#0E1111;
      --panel-2:#0B0D0C;
      --text:#E7F1ED;
      --muted:#A3B7AE;
      --border:rgba(16,163,127,.18);
      --accent1:#00FFA5;
      --accent2:#10A37F;
      --accent3:#0AD59A;
      --ring:0 0 0 2px rgba(0,255,181,.28), 0 0 0 8px rgba(0,255,181,.06);
      --shadow-lg:0 28px 90px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
      --radius:16px;
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 14% 12%, rgba(0,255,181,.07), transparent 60%),
        radial-gradient(1000px 700px at 86% 85%, rgba(16,163,127,.06), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    /* Grille subtile */
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient(0deg,
          rgba(0,255,181,.06) 0px, rgba(0,255,181,.06) 1px,
          transparent 1px, transparent 24px),
        repeating-linear-gradient(90deg,
          rgba(0,255,181,.05) 0px, rgba(0,255,181,.05) 1px,
          transparent 1px, transparent 24px);
      opacity:.35;
      -webkit-mask-image:
        radial-gradient(1000px 700px at 15% 15%, rgba(0,0,0,.85), transparent 70%),
        radial-gradient(900px 600px at 85% 85%, rgba(0,0,0,.75), transparent 65%);
              mask-image:
        radial-gradient(1000px 700px at 15% 15%, rgba(0,0,0,.85), transparent 70%),
        radial-gradient(900px 600px at 85% 85%, rgba(0,0,0,.75), transparent 65%);
      z-index:0;
    }
    *,*:before,*:after{box-sizing:border-box}
    :focus-visible{outline:none; box-shadow:var(--ring)}
    ::selection{background:rgba(0,255,181,.18)}

    /* ====== Header ====== */
    .header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(110%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.00));
      border-bottom:1px solid rgba(0,255,181,.12);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 18px}
    .top{display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{
      display:inline-grid; place-items:center; width:28px; height:28px; border-radius:999px; color:#05110C; font-weight:800;
      background:radial-gradient(circle at 35% 30%, var(--accent1), var(--accent2));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10), 0 0 0 6px rgba(16,163,127,.10), 0 12px 28px rgba(0,0,0,.45);
      text-shadow:0 1px 0 rgba(255,255,255,.4);
    }
    .badge{
      margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; font-size:12px; color:#BFE6D8;
      background:linear-gradient( to bottom right, rgba(16,163,127,.16), rgba(0,0,0,.0) );
      border:1px solid rgba(16,163,127,.28);
    }
    .badge .dot{width:8px; height:8px; border-radius:50%; background:linear-gradient(90deg, var(--accent2), var(--accent1)); box-shadow:0 0 8px rgba(0,255,181,.6)}

    /* ====== Layout refondu : Left (Import) / Right (Actions) ====== */
    .shell{max-width:1100px; margin:0 auto; padding:28px 18px 64px; position:relative; z-index:1}
    .title{font-size:28px; line-height:1.15; margin:6px 0 18px; font-weight:800; letter-spacing:.2px}

    .grid{
      display:grid; grid-template-columns:1.2fr .8fr; gap:16px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr; gap:14px}
    }

    /* ====== Left Pane (Dropzone / Preview) ====== */
    .pane{
      border:1px solid var(--border); border-radius:var(--radius);
      background:
        linear-gradient(160deg, rgba(16,163,127,.06), transparent),
        linear-gradient(180deg, rgba(0,255,181,.05), transparent 40%),
        var(--panel);
      box-shadow:var(--shadow-lg);
      overflow:hidden;
    }
    .pane-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid rgba(0,255,181,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    .pane-head .label{font-weight:700}
    .pane-body{padding:14px}

    .drop{
      position:relative; display:grid; place-items:center; height:420px; border-radius:14px;
      border:1.5px dashed rgba(0,255,181,.28);
      background:
        radial-gradient(600px 300px at 20% 15%, rgba(0,255,181,.06), transparent 55%),
        #0A0D0C;
      color:#BEEBDD; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      overflow:hidden;
    }
    .drop::after{
      content:""; position:absolute; inset:-30%;
      background:conic-gradient(from 0deg, rgba(0,255,181,.08), transparent 40%, rgba(0,255,181,.04));
      filter:blur(20px); opacity:.35; pointer-events:none;
      animation:spin 10s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .drop:hover{border-color:rgba(0,255,181,.55); box-shadow:0 0 0 1px rgba(0,255,181,.15), 0 20px 60px rgba(0,0,0,.45)}
    .drop.is-drag{transform:scale(1.01); box-shadow:0 0 0 2px rgba(0,255,181,.35), 0 28px 80px rgba(0,0,0,.55)}
    .hint{text-align:center; font-weight:700}
    .hint small{display:block; color:var(--muted); font-weight:600; opacity:.9}

    /* ====== Right Pane (Stepper + Actions) ====== */
    .side{
      border:1px solid var(--border); border-radius:var(--radius);
      background:
        linear-gradient(160deg, rgba(16,163,127,.06), transparent),
        linear-gradient(180deg, rgba(0,255,181,.05), transparent 40%),
        var(--panel-2);
      box-shadow:var(--shadow-lg);
      display:flex; flex-direction:column;
    }
    .side-head{padding:12px 14px; border-bottom:1px solid rgba(0,255,181,.12)}
    .side-body{padding:14px; display:flex; flex-direction:column; gap:12px}

    .stepper{display:flex; gap:8px; flex-wrap:wrap}
    .step{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      color:#CFEFE3; border:1px solid rgba(0,255,181,.18);
      background:linear-gradient( to bottom right, rgba(0,255,181,.06), rgba(0,0,0,.0) );
      opacity:.65;
    }
    .step .dot{width:8px; height:8px; border-radius:50%; background:#2a2; box-shadow:0 0 10px rgba(0,255,181,.6)}
    .step.is-active{opacity:1; border-color:rgba(0,255,181,.35)}
    .step.is-done{opacity:.9}

    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .meta{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px}
    .name{font-weight:700; color:var(--text)}

    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:linear-gradient( to bottom right, rgba(0,255,181,.08), rgba(0,0,0,.0) );
      border:1px solid rgba(0,255,181,.22); font-size:12px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.04);
    }
    .dot{width:8px; height:8px; border-radius:50%}
    .ok{background:linear-gradient(90deg, var(--accent2), var(--accent1)); box-shadow:0 0 10px rgba(0,255,181,.7)}
    .err{background:#9b2c2c}

    .btn{
      appearance:none; background:#0D110F; border:1px solid rgba(0,255,181,.18); color:var(--text);
      border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
    }
    .btn:hover{box-shadow:0 0 0 1px rgba(0,255,181,.22), 0 14px 36px rgba(0,0,0,.5)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(90deg, var(--accent2), var(--accent1));
      border:none; color:#03150E; text-shadow:0 1px 0 rgba(255,255,255,.35);
      box-shadow:0 0 0 0 rgba(0,255,181,0), 0 18px 50px rgba(0,0,0,.55);
    }
    .btn.primary:hover{box-shadow:0 0 0 6px rgba(0,255,181,.10), 0 22px 64px rgba(0,0,0,.6)}
    .btn.ghost{background:transparent; border-color:rgba(0,255,181,.22); color:var(--muted)}
    .btn.ghost:hover{color:var(--text)}

    .pass{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      border:1px solid rgba(0,255,181,.22);
      background:linear-gradient(180deg, rgba(0,255,181,.05), rgba(0,0,0,.0));
      border-radius:14px; padding:10px 12px
    }
    .pass b{font-size:18px; letter-spacing:1px; color:#D8FFF1}
    .hide{display:none}

    .foot{margin-top:auto; padding:12px 14px; border-top:1px solid rgba(0,255,181,.12); color:var(--muted); font-size:12px}

    /* Loader */
    .spin{
      --d:18px; width:var(--d); height:var(--d); border-radius:50%;
      border:2px solid rgba(255,255,255,.12); border-right-color:rgba(0,255,181,.95);
      animation:sp 1s linear infinite; filter:drop-shadow(0 0 6px rgba(0,255,181,.45));
    }
    @keyframes sp{to{transform:rotate(360deg)}}

    @media (max-width:720px){
      .title{font-size:24px}
      .drop{height:320px}
    }
  </style>
  <!-- qpdf-wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="wrap top">
      <div class="brand">
        <div class="logo" aria-hidden>âˆž</div>
        <span>Infinie & gratuit</span>
      </div>
      <div class="badge"><span class="dot"></span><span><strong>Protection PDF</strong> â€” 100% local</span></div>
    </div>
  </header>

  <!-- Main -->
  <main class="shell">
    <h1 class="title">PDF Locker â€” Mot de passe</h1>

    <div class="grid">
      <!-- LEFT : Import / Preview -->
      <section class="pane">
        <div class="pane-head"><div class="label">1. Importer votre PDF</div></div>
        <div class="pane-body">
          <div class="drop" id="drop" role="button" tabindex="0" aria-label="DÃ©posez un PDF ou cliquez pour importer">
            <input id="file" type="file" accept="application/pdf" aria-label="Importer un PDF">
            <div class="hint">
              ðŸ“„ DÃ©poser / Cliquer pour sÃ©lectionner
              <small>Le chiffrement sâ€™effectue en local, sur votre appareil.</small>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT : Steps / Actions / Status -->
      <aside class="side">
        <div class="side-head">
          <div class="stepper" id="stepper">
            <div class="step is-active" data-step="1"><span class="dot"></span> Importer</div>
            <div class="step" data-step="2"><span class="dot"></span> Chiffrer</div>
            <div class="step" data-step="3"><span class="dot"></span> Exporter</div>
          </div>
        </div>

        <div class="side-body">
          <!-- Fichier sÃ©lectionnÃ© -->
          <div class="row" id="fileRow" style="display:none">
            <div class="meta grow">
              <span class="name" id="fname">document.pdf</span>
              <span>â€¢</span>
              <span id="fsize">0 Mo</span>
            </div>
            <div id="statusPill" class="pill"><span class="dot ok"></span><span id="statusTxt">PrÃªt</span></div>
          </div>

          <!-- Actions -->
          <div class="row">
            <button class="btn primary" id="lockBtn">Crypter (local)</button>
            <button class="btn ghost" id="resetBtn">RÃ©initialiser</button>
            <div class="row" id="loader" style="margin-left:auto; display:none"><div class="spin" title="Chargement"></div></div>
          </div>

          <!-- Mot de passe -->
          <div class="pass hide" id="passBox">
            <span class="meta">Mot de passe</span>
            <b id="passTxt">â€”</b>
            <button class="btn" id="copyBtn" aria-label="Copier le mot de passe">Copier</button>
          </div>

          <!-- Note -->
          <div class="meta" style="justify-content:space-between">
            <span>Vos fichiers ne quittent jamais votre appareil.</span>
            <span id="tip" class="hide">TÃ©lÃ©chargement automatique activÃ©.</span>
          </div>
        </div>

        <div class="foot">Astuce : gardez le mot de passe en lieu sÃ»r. Sans lui, le dÃ©chiffrement sera impossible.</div>
      </aside>
    </div>
  </main>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);

    // UI refs
    const drop = $('#drop');
    const fileInput = $('#file');
    const fileRow = $('#fileRow');
    const fname = $('#fname');
    const fsize = $('#fsize');
    const statusTxt = $('#statusTxt');
    const statusPill = $('#statusPill');
    const loader = $('#loader');
    const lockBtn = $('#lockBtn');
    const resetBtn = $('#resetBtn');
    const passBox = $('#passBox');
    const passTxt = $('#passTxt');
    const copyBtn = $('#copyBtn');
    const tip = $('#tip');
    const stepper = $('#stepper');

    let currentFile = null;
    let qpdfInstance = null;
    const WASM_URL = 'https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.wasm';

    function setStep(n){
      const steps = stepper?.querySelectorAll('.step') || [];
      steps.forEach(el=>{
        const s = Number(el.dataset.step||0);
        el.classList.remove('is-active','is-done');
        if(s < n) el.classList.add('is-done');
        if(s === n) el.classList.add('is-active');
      });
    }

    // Robust PDF check
    function isPdf(file){
      const nameOk = /\.pdf$/i.test(file?.name || '');
      const mime = (file?.type || '').toLowerCase();
      const mimeOk = mime === 'application/pdf' || mime === 'application/x-pdf' || mime.startsWith('application/pdf');
      return mimeOk || nameOk;
    }

    // Drag & Drop + clavier
    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ prevent(e); drop.classList.remove('is-drag'); }));

    drop.addEventListener('drop', e => {
      const f = e.dataTransfer?.files?.[0];
      if(f) onFile(f);
      fileInput.value = '';
    });

    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fileInput.click(); } });

    fileInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(f) onFile(f);
      e.target.value = '';
    });

    function onFile(file){
      if(!isPdf(file)){ alert('Merci dâ€™importer un fichier PDF.'); return; }
      currentFile = file;
      fname.textContent = file.name;
      fsize.textContent = (file.size/1024/1024).toFixed(2) + ' Mo';
      fileRow.style.display = 'flex';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('PDF chargÃ©', true);
      setStep(2);
    }

    resetBtn.addEventListener('click', ()=>{
      currentFile = null; fileInput.value = '';
      fileRow.style.display = 'none';
      passBox.classList.add('hide');
      tip.classList.add('hide');
      setStatus('PrÃªt', true);
      setStep(1);
    });

    copyBtn.addEventListener('click', async()=>{
      try{
        await navigator.clipboard.writeText(passTxt.textContent);
        copyBtn.textContent = 'CopiÃ©';
        setTimeout(()=> copyBtn.textContent='Copier', 1200);
      }catch{}
    });

    lockBtn.addEventListener('click', async()=>{
      if(!currentFile){ alert('Importe un PDF dâ€™abord.'); return; }
      if(!qpdfInstance){ await loadQpdf(); }

      await busy('Analyse du PDFâ€¦', 400);
      await busy('Chiffrement AES-256â€¦', 700);

      const password = genPassword();
      try{
        const outBlob = await encryptPdfWithQpdf(currentFile, password);
        passTxt.textContent = password;
        passBox.classList.remove('hide');
        autoDownload(outBlob, 'secured_' + (currentFile.name.replace(/\.pdf$/i,'') || 'document') + '.pdf');
        tip.classList.remove('hide');
        setStatus('PDF protÃ©gÃ©', true);
        setStep(3);
      }catch(err){
        console.error(err);
        setStatus('Erreur', false);
        alert('Ã‰chec du chiffrement du PDF.');
      }
    });

    function setStatus(text, ok){
      statusTxt.textContent = text;
      const dot = statusPill.querySelector('.dot');
      if(dot) dot.className = 'dot ' + (ok ? 'ok' : 'err');
    }

    async function busy(text, ms){
      setStatus(text, true);
      loader.style.display = 'flex';
      await new Promise(r=> setTimeout(r, ms));
      loader.style.display = 'none';
    }

    async function loadQpdf(){
      setStatus('Chargement du moduleâ€¦', true);
      loader.style.display = 'flex';
      qpdfInstance = await window.Module({
        locateFile: () => WASM_URL,
        noInitialRun: true,
        preRun: [ m => { try{ m.FS.mkdir('/in'); m.FS.mkdir('/out'); }catch{} } ],
      });
      loader.style.display = 'none';
      setStatus('Module prÃªt', true);
    }

    async function encryptPdfWithQpdf(file, password){
      const buf = new Uint8Array(await file.arrayBuffer());
      const inPath = '/in/doc.pdf';
      const outPath = '/out/locked.pdf';
      qpdfInstance.FS.writeFile(inPath, buf);
      const args = ['--encrypt', password, password, '256', '--', inPath, outPath];
      qpdfInstance.callMain(args);
      const out = qpdfInstance.FS.readFile(outPath);
      try{ qpdfInstance.FS.unlink(inPath); qpdfInstance.FS.unlink(outPath); }catch{}
      return new Blob([out], {type:'application/pdf'});
    }

    function genPassword(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s=''; for(let i=0;i<10;i++) s += chars[(Math.random()*chars.length)|0];
      return s.slice(0,4)+'-'+s.slice(4,8)+'-'+s.slice(8);
    }

    function autoDownload(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 800);
    }

    // Init stepper state
    setStep(1);
  </script>
</body>
</html>
